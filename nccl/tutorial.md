# NCCL æµ‹è¯•éªŒè¯å·¥å…·è¯´æ˜æ–‡æ¡£

> æ³¨æ„ï¼š**æ€§èƒ½éƒ¨åˆ†æŒ‡æ ‡çš„è§£é‡Šå’Œè®¡ç®—æ–¹æ³•å¯èƒ½ä¼šæ ¹æ®å…·ä½“çš„ç¡¬ä»¶é…ç½®å’Œç½‘ç»œç¯å¢ƒè€Œæœ‰æ‰€ä¸åŒã€‚å»ºè®®åœ¨å®é™…æµ‹è¯•ä¸­æ ¹æ®è‡ªå·±çš„ç¯å¢ƒè¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–**ã€‚

---

> **ç›®å‰è¿›å±•**ï¼šå•èŠ‚ç‚¹æµ‹è¯•åŸºæœ¬éªŒè¯OKï¼ˆNvlink,Pcie,IB,SHM,Ethernet,Socketï¼‰ï¼Œå¤šèŠ‚ç‚¹åŸºäºä»¥å¤ªç½‘éªŒè¯OKã€‚

## 1. æ¦‚è¿°ä¸ç³»ç»Ÿè¦æ±‚

### 1.1 NCCL æµ‹è¯•èƒŒæ™¯

#### 1.1.1 ä¸ºä»€ä¹ˆéœ€è¦ NCCL æµ‹è¯•

åœ¨ç°ä»£æ·±åº¦å­¦ä¹ è®­ç»ƒä¸­ï¼Œå¤šGPUå’Œåˆ†å¸ƒå¼è®­ç»ƒå·²æˆä¸ºå¤„ç†å¤§è§„æ¨¡æ¨¡å‹çš„æ ‡å‡†æ–¹æ³•ã€‚NCCL (NVIDIA Collective Communications Library) ä½œä¸ºNVIDIAæä¾›çš„é«˜æ€§èƒ½é›†åˆé€šä¿¡åº“ï¼Œè´Ÿè´£GPUé—´çš„æ•°æ®åŒæ­¥å’Œé€šä¿¡ã€‚ç„¶è€Œï¼ŒNCCLçš„æ€§èƒ½é«˜åº¦ä¾èµ–äºï¼š

- **ç¡¬ä»¶é…ç½®**ï¼šGPUå‹å·ã€å†…å­˜å¸¦å®½ã€PCIeæ‹“æ‰‘ç»“æ„
- **ç½‘ç»œç¯å¢ƒ**ï¼šInfiniBandã€RoCEã€ä»¥å¤ªç½‘çš„é…ç½®å’Œæ€§èƒ½
- **è½¯ä»¶æ ˆ**ï¼šCUDAç‰ˆæœ¬ã€é©±åŠ¨ç¨‹åºã€NCCLåº“ç‰ˆæœ¬çš„å…¼å®¹æ€§
- **ç¯å¢ƒå˜é‡**ï¼šæ•°ç™¾ä¸ªNCCLå‚æ•°çš„æ­£ç¡®é…ç½®ï¼ˆç°å·²é€šè¿‡ç»Ÿä¸€é…ç½®ç®¡ç†å™¨è‡ªåŠ¨åŒ–ï¼‰

ä¸å½“çš„é…ç½®å¯èƒ½å¯¼è‡´ï¼š

- è®­ç»ƒé€Ÿåº¦ä¸‹é™50-90%
- é€šä¿¡å»¶è¿Ÿå¢åŠ 10-100å€
- ç½‘ç»œå¸¦å®½åˆ©ç”¨ç‡ä½äº10%
- åˆ†å¸ƒå¼è®­ç»ƒå¤±è´¥æˆ–ä¸ç¨³å®š

#### 1.1.2 NCCL æ ¸å¿ƒæ¦‚å¿µ

**AllReduce æ“ä½œ**ï¼šNCCLæœ€é‡è¦çš„é›†åˆé€šä¿¡åŸè¯­ï¼Œç”¨äºæ¢¯åº¦èšåˆ

- å°†æ‰€æœ‰GPUä¸Šçš„æ•°æ®è¿›è¡Œå½’çº¦è¿ç®—ï¼ˆå¦‚æ±‚å’Œï¼‰
- å°†ç»“æœå¹¿æ’­åˆ°æ‰€æœ‰å‚ä¸çš„GPU
- æ˜¯åˆ†å¸ƒå¼è®­ç»ƒä¸­æ¢¯åº¦åŒæ­¥çš„æ ¸å¿ƒæ“ä½œ

**é€šä¿¡ç®—æ³•**ï¼š

- **Ring AllReduce**ï¼šé€‚ç”¨äºå¸¦å®½å—é™ç¯å¢ƒï¼Œé€šä¿¡é‡ä¸º `2(N-1)/N Ã— data_size`
- **Tree AllReduce**ï¼šé€‚ç”¨äºå»¶è¿Ÿæ•æ„Ÿåœºæ™¯ï¼Œé€šä¿¡æ·±åº¦ä¸º `logâ‚‚(N)`
- **Double Binary Tree**ï¼šNCCL 2.4+çš„é»˜è®¤ç®—æ³•ï¼Œå¹³è¡¡å»¶è¿Ÿå’Œå¸¦å®½

**ç½‘ç»œåç«¯**ï¼š

- **NVLink**ï¼šGPUé—´ç›´è¿ï¼Œå¸¦å®½300-600 GB/s
- **InfiniBand**ï¼šé«˜æ€§èƒ½ç½‘ç»œï¼Œå¸¦å®½12.5-50 GB/s (100-400 Gbps)
- **RoCE**ï¼šåŸºäºä»¥å¤ªç½‘çš„RDMAï¼Œå¸¦å®½3.1-12.5 GB/s (25-100 Gbps)
- **TCP/Socket**ï¼šé€šç”¨ç½‘ç»œï¼Œå¸¦å®½0.125-1.25 GB/s (1-10 Gbps)

### 1.2 å·¥å…·æ¦‚è¿°

æœ¬å·¥å…·å¥—ä»¶æä¾›äº†å®Œæ•´çš„ NCCL æµ‹è¯•å’Œéƒ¨ç½²è§£å†³æ–¹æ¡ˆï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒå·¥å…·ï¼š

#### 1.2.1 æ ¸å¿ƒæµ‹è¯•å·¥å…·

**`nccl_benchmark.sh`** - ä¸»è¦çš„ NCCL æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œä¸“é—¨è®¾è®¡ç”¨äºï¼š

- **æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼šæµ‹é‡çœŸå®çš„NCCLé€šä¿¡æ€§èƒ½
- **æ™ºèƒ½é…ç½®ç®¡ç†**ï¼šç»Ÿä¸€é…ç½®ç®¡ç†å™¨è‡ªåŠ¨åŒ–NCCLç¯å¢ƒå˜é‡è®¾ç½®
- **å¤šçº§ä¼˜åŒ–ç­–ç•¥**ï¼šæä¾›ä¿å®ˆã€å¹³è¡¡ã€æ¿€è¿›ä¸‰ç§ä¼˜åŒ–çº§åˆ«ï¼ˆ**ä»…é€‚ç”¨äº NVLink ç½‘ç»œåç«¯**ï¼‰
- **è‡ªåŠ¨è·¯å¾„æ£€æµ‹**ï¼šæŒ‰NCCLä¼˜å…ˆçº§è‡ªåŠ¨é€‰æ‹©æœ€ä½³é€šä¿¡è·¯å¾„
- **é—®é¢˜è¯Šæ–­**ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œé…ç½®é—®é¢˜
- **ç¯å¢ƒä¼˜åŒ–**ï¼šæä¾›æœ€ä½³å®è·µé…ç½®å»ºè®®

**`gpu_topology_detector.sh`** - GPU æ‹“æ‰‘æ£€æµ‹å·¥å…·ï¼š

- **ç¡¬ä»¶æ‹“æ‰‘åˆ†æ**ï¼šæ£€æµ‹ GPU é—´çš„è¿æ¥æ–¹å¼ï¼ˆNVLinkã€PCIeï¼‰
- **NCCL é€šä¿¡è·¯å¾„éªŒè¯**ï¼šç¡®è®¤ NCCL å®é™…ä½¿ç”¨çš„é€šä¿¡è·¯å¾„
- **æ€§èƒ½é¢„æµ‹**ï¼šåŸºäºç¡¬ä»¶æ‹“æ‰‘é¢„æµ‹é€šä¿¡æ€§èƒ½
- **é…ç½®å»ºè®®**ï¼šæä¾›æœ€ä¼˜çš„ç½‘ç»œåç«¯é…ç½®å»ºè®®

#### 1.2.2 å®¹å™¨åŒ–éƒ¨ç½²å·¥å…·

**`nccl_container_manager.sh`** - å®¹å™¨åŒ–æµ‹è¯•ç®¡ç†å·¥å…·ï¼š

- **å•èŠ‚ç‚¹å®¹å™¨æµ‹è¯•**ï¼šä½¿ç”¨ Docker å®¹å™¨è¿è¡Œ NCCL æµ‹è¯•
- **ç¯å¢ƒéš”ç¦»**ï¼šæä¾›å¹²å‡€çš„æµ‹è¯•ç¯å¢ƒï¼Œé¿å…ä¸»æœºç¯å¢ƒå¹²æ‰°
- **ç‰¹æƒæ¨¡å¼æ”¯æŒ**ï¼šå®Œæ•´çš„ç¡¬ä»¶è®¿é—®æƒé™ï¼ˆGPUã€InfiniBandï¼‰
- **é…ç½®çµæ´»æ€§**ï¼šæ”¯æŒå¤šç§ç½‘ç»œåç«¯å’Œæµ‹è¯•å‚æ•°

#### 1.2.3 å¤šèŠ‚ç‚¹éƒ¨ç½²å·¥å…·

**`nccl_multinode_launcher.sh`** - ä¼ ç»Ÿå¤šèŠ‚ç‚¹éƒ¨ç½²å·¥å…·ï¼š

- **è£¸æœºå¤šèŠ‚ç‚¹æµ‹è¯•**ï¼šç›´æ¥åœ¨ç‰©ç†æœºä¸Šè¿è¡Œåˆ†å¸ƒå¼æµ‹è¯•
- **èŠ‚ç‚¹åè°ƒ**ï¼šè‡ªåŠ¨å¤„ç†ä¸»èŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹çš„å¯åŠ¨é¡ºåº
- **å‚æ•°åŒæ­¥**ï¼šç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨ä¸€è‡´çš„æµ‹è¯•å‚æ•°
- **æ•…éšœæ¢å¤**ï¼šæä¾›é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†

**`k8s/deploy.sh`** - Kubernetes å¤šèŠ‚ç‚¹éƒ¨ç½²å·¥å…·ï¼š

- **äº‘åŸç”Ÿéƒ¨ç½²**ï¼šåœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½² NCCL æµ‹è¯•
- **StatefulSet ç®¡ç†**ï¼šæä¾›ç¨³å®šçš„ Pod å‘½åå’Œæœ‰åºå¯åŠ¨
- **èµ„æºç®¡ç†**ï¼šè‡ªåŠ¨ç®¡ç† GPU èµ„æºåˆ†é…å’Œè°ƒåº¦
- **æ‰©å±•æ€§**ï¼šæ”¯æŒå¤§è§„æ¨¡å¤šèŠ‚ç‚¹æµ‹è¯•éƒ¨ç½²

#### 1.2.4 è¾…åŠ©å·¥å…·

**`nccl_python_template.py`** - Python æµ‹è¯•æ¨¡æ¿ï¼š

- **è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬**ï¼šæä¾›å¯å®šåˆ¶çš„ NCCL æµ‹è¯•ä»£ç æ¨¡æ¿
- **æ€§èƒ½ç›‘æ§**ï¼šè¯¦ç»†çš„å»¶è¿Ÿå’Œååé‡ç»Ÿè®¡
- **è°ƒè¯•æ”¯æŒ**ï¼šä¸°å¯Œçš„æ—¥å¿—è¾“å‡ºå’Œé”™è¯¯å¤„ç†
- **å¤šè¿›ç¨‹åè°ƒ**ï¼šæ”¯æŒåˆ†å¸ƒå¼æµ‹è¯•çš„è¿›ç¨‹åŒæ­¥

### 1.3 ä¸»è¦åŠŸèƒ½

#### 1.3.1 ç³»ç»Ÿæ£€æŸ¥

- **ä¾èµ–æ£€æŸ¥**: éªŒè¯ Python3ã€PyTorchã€CUDAã€NCCLã€NVIDIA GPU ç­‰å¿…è¦ç»„ä»¶
- **InfiniBand çŠ¶æ€æ£€æŸ¥**: æ£€æµ‹ IB è®¾å¤‡çŠ¶æ€ã€Link Layer ç±»å‹ã€ç½‘ç»œæ‹“æ‰‘

#### 1.3.2 ç¯å¢ƒé…ç½®

- **ç»Ÿä¸€é…ç½®ç®¡ç†å™¨**: æ¶ˆé™¤é‡å¤ä»£ç ï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰NCCLé…ç½®é¡¹
- **æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ**: ç¼“å­˜ç³»ç»Ÿä¿¡æ¯ï¼Œé¿å…é‡å¤æ£€æµ‹ï¼Œæå‡æ€§èƒ½
- **è‡ªåŠ¨ç½‘ç»œç±»å‹æ£€æµ‹**: æ™ºèƒ½è¯†åˆ«åŸç”Ÿ IB æˆ– RoCE ç¯å¢ƒ
- **æ‰¹é‡é…ç½®è®¾ç½®**: æ”¯æŒé…ç½®ç»„çš„æ‰¹é‡è®¾ç½®å’Œç®¡ç†
- **ç½‘ç»œé…ç½®é¢„è®¾**: æä¾›å¤šç§ç½‘ç»œé…ç½®æ¨¡æ¿ï¼ˆIBã€PCIeã€ä»¥å¤ªç½‘ç­‰ï¼‰
- **æ€§èƒ½ä¼˜åŒ–é…ç½®**: ä¸‰çº§ä¼˜åŒ–ç­–ç•¥ï¼ˆä¿å®ˆã€å¹³è¡¡ã€æ¿€è¿›ï¼‰
- **æ™ºèƒ½ç½‘ç»œæ¥å£é…ç½®**: è‡ªåŠ¨æ£€æµ‹å’Œé…ç½®ç‰©ç†ç½‘ç»œæ¥å£
- **GPUDirect RDMA æ”¯æŒ**: å¯ç”¨é«˜æ€§èƒ½ GPU ç›´æ¥å†…å­˜è®¿é—®

#### 1.3.3 æ€§èƒ½æµ‹è¯•

- **åˆ†å¸ƒå¼ AllReduce æµ‹è¯•**: ä½¿ç”¨å¤š GPU è¿›è¡Œ NCCL é€šä¿¡æµ‹è¯•
- **å»¶è¿Ÿå’Œååé‡åˆ†æ**: è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡æµ‹é‡
- **ç†è®ºä¼ è¾“é‡è®¡ç®—**: Ring AllReduce ç®—æ³•æ•ˆç‡åˆ†æ

#### 1.3.4 æŠ¥å‘Šç”Ÿæˆ

- **è¯¦ç»†æµ‹è¯•æŠ¥å‘Š**: åŒ…å«ç³»ç»Ÿä¿¡æ¯ã€é…ç½®å‚æ•°ã€æµ‹è¯•ç»“æœ
- **æ€§èƒ½æ•°æ®åˆ†æ**: å»¶è¿Ÿã€æ•°æ®ååé‡ã€ç†è®ºä¼ è¾“é‡ç»Ÿè®¡
- **é—®é¢˜è¯Šæ–­**: é”™è¯¯å’Œè­¦å‘Šçš„ç»Ÿè®¡ä¸åˆ†æ

### 1.4 ç³»ç»Ÿè¦æ±‚

#### 1.4.1 ç¡¬ä»¶è¦æ±‚

- **GPU**: ä¸€ä¸ªæˆ–å¤šä¸ª NVIDIA GPU (æ”¯æŒ CUDA Compute Capability 3.5+)
  - æ¨èï¼šV100ã€A100ã€H100 ç­‰æ•°æ®ä¸­å¿ƒGPU
  - æœ€ä½ï¼šGTX 1080ã€RTX 2080 ç­‰æ¶ˆè´¹çº§GPU
- **ç½‘ç»œ**: InfiniBand ç½‘å¡ (åŸç”Ÿ IB æˆ– RoCE)
  - InfiniBandï¼šEDR (12.5 GB/s)ã€HDR (25 GB/s)ã€NDR (50 GB/s)
  - RoCEï¼š3.1/6.25/12.5 GB/s (25/50/100 Gbps) ä»¥å¤ªç½‘å¡
- **å†…å­˜**: å»ºè®® 16GB ä»¥ä¸Šç³»ç»Ÿå†…å­˜ (å¤§è§„æ¨¡æµ‹è¯•éœ€è¦æ›´å¤š)
- **å­˜å‚¨**: è‡³å°‘ 10GB å¯ç”¨ç©ºé—´ç”¨äºæ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶

#### 1.4.2 è½¯ä»¶è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (Ubuntu 18.04+/CentOS 7+/RHEL 7+)
- **Python**: Python 3.7+ (æ¨è 3.8-3.11)
- **PyTorch**: 1.12.0+ æ”¯æŒ CUDA çš„ç‰ˆæœ¬
  - æ¨èï¼šPyTorch 2.0+ ä»¥è·å¾—æœ€ä½³NCCLæ”¯æŒ
- **NCCL**: 2.12.0+ (æ¨è 2.18.0+)
  - é€šè¿‡ `python -c "import torch; print(torch.cuda.nccl.version())"` æ£€æŸ¥ç‰ˆæœ¬
- **CUDA**: 11.7+ (æ¨è 12.0+)
  - å¿…é¡»ä¸PyTorchç‰ˆæœ¬å…¼å®¹
- **NVIDIA Driver**: 515.0+ (æ¨è 535.0+)
- **InfiniBand å·¥å…·**:
  - `infiniband-diags` (åŒ…å« `ibstat`, `perfquery`)
  - `libibverbs-dev` (åŒ…å« `ibv_devinfo`)
  - `rdma-core` (RDMA æ ¸å¿ƒåº“)

#### 1.4.3 ä¾èµ–å®‰è£…

**Ubuntu/Debianï¼š**

```bash
# æ›´æ–°åŒ…ç®¡ç†å™¨
sudo apt-get update

# å®‰è£… InfiniBand å·¥å…·å’Œå¼€å‘åº“
sudo apt-get install -y infiniband-diags ibverbs-utils libibverbs-dev rdma-core

# éªŒè¯ InfiniBand å®‰è£…
ibstat
ibv_devinfo

# å®‰è£… Python å’Œ PyTorch (CUDA 11.8 ç¤ºä¾‹)
pip3 install torch==2.0.1+cu118 torchvision==0.15.2+cu118 torchaudio==2.0.2+cu118 \
    --index-url https://download.pytorch.org/whl/cu118

# éªŒè¯ PyTorch å’Œ NCCL
python3 -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.version.cuda}'); print(f'NCCL: {torch.cuda.nccl.version()}')"
```

**CentOS/RHELï¼š**

```bash
# CentOS 7/RHEL 7
sudo yum install -y infiniband-diags libibverbs-utils libibverbs-devel rdma-core-devel

# CentOS 8+/RHEL 8+ (ä½¿ç”¨ dnf)
sudo dnf install -y infiniband-diags libibverbs-utils libibverbs-devel rdma-core-devel

# å¯ç”¨ InfiniBand æœåŠ¡
sudo systemctl enable rdma
sudo systemctl start rdma

# éªŒè¯å®‰è£…
ibstat
ibv_devinfo
```

**éªŒè¯å®Œæ•´ç¯å¢ƒï¼š**

```bash
# æ£€æŸ¥ GPU çŠ¶æ€
nvidia-smi

# æ£€æŸ¥ CUDA ç‰ˆæœ¬
nvcc --version

# æ£€æŸ¥ InfiniBand è®¾å¤‡
ibstat | grep -E "(CA type|Number of ports|State|Physical state)"

# æ£€æŸ¥ NCCL æµ‹è¯•ç¯å¢ƒ
python3 -c "
import torch
print(f'GPU æ•°é‡: {torch.cuda.device_count()}')
print(f'NCCL å¯ç”¨: {torch.distributed.is_nccl_available()}')
print(f'NCCL ç‰ˆæœ¬: {torch.cuda.nccl.version()}')
"
```

---

## 2. å•èŠ‚ç‚¹æµ‹è¯•

### 2.1 å•èŠ‚ç‚¹æµ‹è¯•æ¦‚è¿°

å•èŠ‚ç‚¹NCCLæµ‹è¯•ä¸“æ³¨äºéªŒè¯å•å°æœåŠ¡å™¨å†…å¤šGPUä¹‹é—´çš„é€šä¿¡æ€§èƒ½ï¼Œæ˜¯åˆ†å¸ƒå¼è®­ç»ƒç¯å¢ƒæ­å»ºçš„ç¬¬ä¸€æ­¥ã€‚

å•èŠ‚ç‚¹æµ‹è¯•å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

#### 2.1.1 NCCLé€šä¿¡è·¯å¾„é€‰æ‹©æœºåˆ¶

**NCCLè‡ªåŠ¨æ¢æµ‹å’Œé€‰æ‹©é€»è¾‘**ï¼š

NCCLåœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ¢æµ‹ç³»ç»Ÿç¡¬ä»¶æ‹“æ‰‘ï¼Œå¹¶æ ¹æ®ä»¥ä¸‹ä¼˜å…ˆçº§é€‰æ‹©æœ€ä¼˜é€šä¿¡è·¯å¾„ï¼š

| é€šä¿¡æ–¹å¼ | ä½¿ç”¨æ¡ä»¶ | å¸¦å®½/å»¶è¿Ÿç‰¹æ€§ | å…¸å‹æ ‡è¯† | ä¼˜å…ˆçº§ |
|----------|----------|---------------|----------|--------|
| **NVLink** | GPUé—´é€šè¿‡NVLinkç›´è¿ | é«˜å¸¦å®½ï¼Œä½å»¶è¿Ÿ | `NVL` | 1ï¼ˆæœ€é«˜ï¼‰ |
| **PCIe P2P** | GPUåœ¨åŒä¸€PCIeæ ¹æ¡¥æˆ–æ”¯æŒP2Pçš„æ¡¥ä¸‹ | ä¸­ç­‰å¸¦å®½ï¼Œä½å»¶è¿Ÿ | `PXB` | 2 |
| **SHMï¼ˆShared Memoryï¼‰** | åŒèŠ‚ç‚¹GPUä¸æ”¯æŒP2P | è¾ƒä½å¸¦å®½ï¼ŒCPUå‚ä¸æ•°æ®æ‹·è´ | `SHM` | 3 |
| **Loopbackç½‘ç»œ** | å¼ºåˆ¶é…ç½®æˆ–é…ç½®é”™è¯¯æ—¶ | é€šå¸¸ä¸ç”¨äºå•èŠ‚ç‚¹ | `NET` | 4ï¼ˆæœ€ä½ï¼‰ |

**é‡è¦æŠ€æœ¯ç»†èŠ‚**ï¼š

- **å•èŠ‚ç‚¹åœºæ™¯**ï¼šNCCLé»˜è®¤**ä¸ä¼š**ä½¿ç”¨IB/RDMAç½‘ç»œï¼Œå³ä½¿å­˜åœ¨IBç½‘å¡
- **é€šä¿¡è·¯å¾„**ï¼šå®é™…çš„GPUé—´æ•°æ®ä¼ è¾“ä»ç„¶æ˜¯NVLinkæˆ–PCIeï¼ŒIBä»…åœ¨ç‰¹æ®Šé…ç½®ä¸‹ä½¿ç”¨
- **è‡ªåŠ¨é€‰æ‹©**ï¼š`--network auto`è®©NCCLæ ¹æ®ç¡¬ä»¶æ‹“æ‰‘è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è·¯å¾„

#### 2.1.2 æµ‹è¯•èŒƒå›´ä¸åº”ç”¨åœºæ™¯

**æµ‹è¯•èŒƒå›´**ï¼š

- GPUé—´P2Pé€šä¿¡ï¼ˆPCIeã€NVLinkï¼‰
- æœ¬åœ°ç½‘ç»œæ ˆæ€§èƒ½ï¼ˆloopbackï¼‰
- NCCLç®—æ³•åœ¨å•æœºç¯å¢ƒä¸‹çš„æ•ˆç‡
- GPUå†…å­˜å¸¦å®½å’Œå»¶è¿Ÿç‰¹æ€§

**åº”ç”¨åœºæ™¯**ï¼š

- å•æœºå¤šGPUè®­ç»ƒéªŒè¯
- ç¡¬ä»¶é…ç½®ä¼˜åŒ–
- æ€§èƒ½åŸºçº¿å»ºç«‹
- é—®é¢˜éš”ç¦»å’Œè¯Šæ–­

**æ€§èƒ½æœŸæœ›**ï¼ˆå‚è€ƒå€¼ï¼‰ï¼š

- **NVLinkè¿æ¥**ï¼šå»¶è¿Ÿ < 10Î¼sï¼Œå¸¦å®½ > 200 GB/s
- **PCIeè¿æ¥**ï¼šæ ¹æ®PCIeç‰ˆæœ¬å’Œé…ç½®ï¼š
  - **PCIe 3.0 x16**ï¼šå»¶è¿Ÿ < 100Î¼sï¼Œå¸¦å®½ > 12 GB/s
  - **PCIe 4.0 x16**ï¼šå»¶è¿Ÿ < 50Î¼sï¼Œå¸¦å®½ > 20 GB/s
  - **PCIe 5.0 x16**ï¼šå»¶è¿Ÿ < 30Î¼sï¼Œå¸¦å®½ > 40 GB/s
- **InfiniBand loopback**ï¼šå»¶è¿Ÿ < 5Î¼sï¼Œå¸¦å®½ > 80 GB/s

### 2.2 ç¡¬ä»¶ç¯å¢ƒæ£€æµ‹

åœ¨è¿›è¡ŒNCCLæ€§èƒ½æµ‹è¯•å‰ï¼Œé¦–å…ˆéœ€è¦äº†è§£ç³»ç»Ÿçš„ç¡¬ä»¶æ‹“æ‰‘å’ŒNCCLå®é™…ä½¿ç”¨çš„é€šä¿¡è·¯å¾„ã€‚

#### 2.2.1 åŸºç¡€ç¡¬ä»¶æ‹“æ‰‘æ£€æµ‹

**æŸ¥çœ‹GPUæ‹“æ‰‘ç»“æ„**ï¼š

```bash
nvidia-smi topo -m
```

**å…¸å‹è¾“å‡ºè§£è¯»**ï¼š

```shm
        GPU0    GPU1    GPU2    GPU3    CPU Affinity
GPU0     X      NV2     SYS     SYS     0-31
GPU1    NV2      X      SYS     SYS     0-31  
GPU2    SYS     SYS      X      NV1     32-63
GPU3    SYS     SYS     NV1      X      32-63
```

**æ‹“æ‰‘æ ‡è¯†å«ä¹‰**ï¼š

- **NV1/NV2/NV4**ï¼šNVLinkè¿æ¥ï¼ˆæ•°å­—è¡¨ç¤ºé“¾è·¯æ•°é‡ï¼‰
- **PXB**ï¼šPCIeæ¡¥æ¥è¿æ¥
- **SYS**ï¼šè·¨NUMAèŠ‚ç‚¹æˆ–CPUè¿æ¥
- **X**ï¼šè‡ªèº«

**PCIeé…ç½®æ£€æµ‹**ï¼š

```bash
# æ£€æŸ¥PCIeç‰ˆæœ¬å’Œé“¾è·¯å®½åº¦
lspci -vvv | grep -A10 NVIDIA | grep -E "(LnkCap|LnkSta)"

# æ£€æŸ¥PCIeå¸¦å®½åˆ©ç”¨ç‡
nvidia-smi dmon -s pci -c 1
```

**PCIeé…ç½®å»ºè®®**ï¼š

- **é«˜ç«¯è®­ç»ƒ**ï¼šä¼˜å…ˆé€‰æ‹©PCIe 4.0/5.0 x16ï¼Œç¡®ä¿æ¯ä¸ªGPUç‹¬äº«x16é“¾è·¯
- **ä¸­ç«¯é…ç½®**ï¼šPCIe 3.0 x16å¯æ»¡è¶³åŸºæœ¬éœ€æ±‚ï¼Œé¿å…x8é…ç½®
- **å¤šGPUç³»ç»Ÿ**ï¼šæ£€æŸ¥PCIeé€šé“åˆ†é…ï¼Œé¿å…å¸¦å®½ç«äº‰
- **CPUé€‰æ‹©**ï¼šç¡®ä¿CPUæä¾›è¶³å¤Ÿçš„PCIeé€šé“æ•°ï¼ˆå¦‚Intel Xeonæˆ–AMD EPYCï¼‰

#### 2.2.2 NCCLé€šä¿¡è·¯å¾„æ£€æµ‹

æˆ‘ä»¬æä¾›äº†ä¸“é—¨çš„æ£€æµ‹è„šæœ¬ [gpu_topology_detector.sh](gpu_topology_detector.sh)ï¼Œè¯¥è„šæœ¬æŒ‰ç…§NCCLçš„å®é™…ä¼˜å…ˆçº§è¿›è¡Œæ£€æµ‹ï¼š

**NCCLé€šä¿¡è·¯å¾„ä¼˜å…ˆçº§**ï¼š

1. **NVLink** (æœ€é«˜ä¼˜å…ˆçº§) - GPUé—´ä¸“ç”¨é«˜é€Ÿäº’è”
2. **PCIe P2P** - é€šè¿‡PCIeæ€»çº¿ç‚¹å¯¹ç‚¹é€šä¿¡  
3. **å…±äº«å†…å­˜** - é€šè¿‡CPUå†…å­˜ä¸­è½¬
4. **ç½‘ç»œä¼ è¾“** (æœ€ä½ä¼˜å…ˆçº§) - ä¸»è¦ç”¨äºè·¨èŠ‚ç‚¹é€šä¿¡

**ä½¿ç”¨æ–¹æ³•**ï¼š

```bash
# è¿è¡ŒNCCLé€šä¿¡è·¯å¾„æ£€æµ‹è„šæœ¬
chmod +x gpu_topology_detector.sh
./gpu_topology_detector.sh
```

**è„šæœ¬åŠŸèƒ½ç‰¹ç‚¹**ï¼š

- **æŒ‰NCCLä¼˜å…ˆçº§æ£€æµ‹**ï¼šä¸¥æ ¼æŒ‰ç…§ NVLink > PCIe P2P > SHM > NET çš„é¡ºåºè¿›è¡Œæ£€æµ‹
- **è¯¦ç»†ç¡¬ä»¶åˆ†æ**ï¼šæ£€æŸ¥GPUæ‹“æ‰‘ã€NVLinkçŠ¶æ€ã€PCIeé“¾è·¯ã€IBè®¾å¤‡ç­‰
- **å®é™…è·¯å¾„éªŒè¯**ï¼šè¿è¡ŒNCCLæµ‹è¯•éªŒè¯å®é™…ä½¿ç”¨çš„é€šä¿¡è·¯å¾„
- **æ™ºèƒ½é…ç½®å»ºè®®**ï¼šæ ¹æ®æ£€æµ‹ç»“æœæä¾›æœ€ä¼˜çš„ç½‘ç»œåç«¯é…ç½®å»ºè®®

**å…¸å‹è¾“å‡ºç¤ºä¾‹**ï¼š

```bash
=== NCCLé€šä¿¡è·¯å¾„æ£€æµ‹ ===
1. GPUåŸºæœ¬ä¿¡æ¯ï¼š
0, NVIDIA A100-SXM4-80GB, 81920

3. NVLinkè¿æ¥è¯¦æƒ…ï¼ˆä¼˜å…ˆçº§1 - æœ€é«˜ï¼‰ï¼š
âœ“ NVLinkå¯ç”¨ï¼šæ£€æµ‹åˆ°æ´»è·ƒçš„NVLinkè¿æ¥

9. æ¨èé…ç½®ï¼ˆæŒ‰NCCLä¼˜å…ˆçº§ï¼‰ï¼š
ğŸš€ ä¼˜å…ˆçº§1 - NVLinkç›´è¿ï¼ˆæœ€ä¼˜ï¼‰ï¼š
   é…ç½®ï¼š--network autoï¼ˆNCCLå°†è‡ªåŠ¨é€‰æ‹©NVLinkï¼‰
   é¢„æœŸæ€§èƒ½ï¼šå»¶è¿Ÿ < 10Î¼sï¼Œå¸¦å®½ > 200 GB/s
```

#### 2.2.3 NCCLé€šä¿¡è·¯å¾„éªŒè¯

**ä½¿ç”¨NCCLè°ƒè¯•ä¿¡æ¯**ï¼š

```bash
# å¯ç”¨è¯¦ç»†è°ƒè¯•ä¿¡æ¯
export NCCL_DEBUG=INFO
./nccl_benchmark.sh --network auto -s 100M -t 30
```

**å…³é”®è¾“å‡ºä¿¡æ¯**ï¼š

```bash
NCCL INFO Channel 00 : 0[0] -> 1[0] via NVL  # NVLinkè¿æ¥
NCCL INFO Channel 01 : 1[0] -> 2[0] via PXB  # PCIeæ¡¥æ¥
NCCL INFO Channel 02 : 2[0] -> 3[0] via SHM  # å…±äº«å†…å­˜
```

**è·¯å¾„æ ‡è¯†è¯´æ˜**ï¼š

- **NVL**ï¼šNVLinkç›´è¿
- **PXB**ï¼šPCIeæ¡¥æ¥
- **SHM**ï¼šå…±äº«å†…å­˜ï¼ˆCPUå‚ä¸ï¼‰
- **NET**ï¼šç½‘ç»œé€šä¿¡ï¼ˆç½•è§ï¼‰

### 2.3 æµ‹è¯•é…ç½®é€‰é¡¹

#### 2.3.1 åŸºæœ¬è¯­æ³•

```bash
./nccl_benchmark.sh [é€‰é¡¹]
```

#### 2.3.2 å…³é”®æŠ€æœ¯èƒŒæ™¯

åœ¨äº†è§£å…·ä½“å‚æ•°ä¹‹å‰ï¼Œéœ€è¦ç†è§£ä»¥ä¸‹å…³é”®æ¦‚å¿µï¼š

**å®é™…ç‰©ç†è·¯å¾„**ï¼šæ— è®ºé€‰æ‹©å“ªç§ç½‘ç»œåç«¯ï¼ŒGPUé—´çš„å®é™…æ•°æ®ä¼ è¾“ä»ç„¶é€šè¿‡NVLinkæˆ–PCIe

**å•èŠ‚ç‚¹NETæµ‹è¯•çš„ç‰¹æ®Šæ„ä¹‰**ï¼š

although single node environment, GPU interconnection via network transmission has no meaning, but NET test still has important valueï¼š

1. **ç¡¬ä»¶éªŒè¯**ï¼š
   - éªŒè¯IB/ä»¥å¤ªç½‘å¡ç¡¬ä»¶åŠŸèƒ½æ­£å¸¸
   - æµ‹è¯•GPUDirect RDMAæ˜¯å¦æ­£ç¡®é…ç½®
   - ç¡®è®¤ç½‘ç»œé©±åŠ¨å’Œå›ºä»¶ç‰ˆæœ¬å…¼å®¹æ€§

2. **å¤šèŠ‚ç‚¹éƒ¨ç½²å‡†å¤‡**ï¼š
   - åœ¨å•èŠ‚ç‚¹ç¯å¢ƒä¸­é¢„å…ˆéªŒè¯ç½‘ç»œé…ç½®
   - å»ºç«‹ç½‘ç»œæ€§èƒ½åŸºçº¿ï¼Œä¾¿äºå¤šèŠ‚ç‚¹å¯¹æ¯”
   - æ’æŸ¥ç½‘ç»œç›¸å…³çš„ç¯å¢ƒå˜é‡é…ç½®é—®é¢˜

3. **æ•…éšœæ’é™¤**ï¼š
   - å½“NVLink/PCIeå‡ºç°é—®é¢˜æ—¶ï¼ŒéªŒè¯NCCLæ˜¯å¦èƒ½æ­£ç¡®å›é€€åˆ°ç½‘ç»œä¼ è¾“
   - æ’æŸ¥NCCLåœ¨ç‰¹å®šç½‘ç»œé…ç½®ä¸‹çš„è¡Œä¸º
   - éªŒè¯å®¹å™¨åŒ–ç¯å¢ƒçš„ç½‘ç»œéš”ç¦»é…ç½®

4. **æ€§èƒ½å¯¹æ¯”**ï¼š
   - é‡åŒ–ä¸åŒä¼ è¾“æ–¹å¼çš„æ€§èƒ½å·®å¼‚
   - ä¸ºç³»ç»Ÿä¼˜åŒ–æä¾›æ•°æ®æ”¯æ’‘
   - éªŒè¯ç¡¬ä»¶å‡çº§çš„æ€§èƒ½æå‡æ•ˆæœ

**IBçš„ç‰¹æ®Šæ€§**ï¼šå•èŠ‚ç‚¹ä¸­çš„`--network ib`æ˜¯IBç½‘å¡çš„loopbackæµ‹è¯•ï¼Œä¸æ”¹å˜GPUé—´ç‰©ç†è¿æ¥

**è‡ªåŠ¨é€‰æ‹©æœºåˆ¶**ï¼š`--network auto`åœ¨è„šæœ¬å±‚é¢é…ç½®ç½‘ç»œç¯å¢ƒï¼Œä½†NCCLä»æŒ‰å†…éƒ¨é€»è¾‘é€‰æ‹©æœ€ä¼˜è·¯å¾„

**NETæ¨¡å¼ä¸‹çš„GPUé—´é€šä¿¡æœºåˆ¶**ï¼š

å½“é€‰æ‹©NETï¼ˆç½‘ç»œä¼ è¾“ï¼‰æ—¶ï¼Œä¸¤å—GPUä¹‹é—´çš„é€šä¿¡è·¯å¾„å¦‚ä¸‹ï¼š

1. **æ•°æ®æµå‘**ï¼š

   ```text
   GPU1 æ˜¾å­˜ â†’ CPUå†…å­˜ â†’ ç½‘ç»œæ ˆ â†’ ç½‘å¡ â†’ Loopback â†’ ç½‘å¡ â†’ ç½‘ç»œæ ˆ â†’ CPUå†…å­˜ â†’ GPU2 æ˜¾å­˜
   ```

2. **å…·ä½“æ­¥éª¤**ï¼š
   - **æ­¥éª¤1**ï¼šGPU1é€šè¿‡PCIeå°†æ•°æ®ä¼ è¾“åˆ°CPUå†…å­˜ï¼ˆHost Memoryï¼‰
   - **æ­¥éª¤2**ï¼šCPUå°†æ•°æ®é€šè¿‡ç½‘ç»œæ ˆå‘é€åˆ°ç½‘å¡
   - **æ­¥éª¤3**ï¼šç½‘å¡è¿›è¡Œæœ¬åœ°å›ç¯ï¼ˆLoopbackï¼‰å¤„ç†
   - **æ­¥éª¤4**ï¼šæ•°æ®é€šè¿‡ç½‘ç»œæ ˆè¿”å›åˆ°CPUå†…å­˜
   - **æ­¥éª¤5**ï¼šCPUé€šè¿‡PCIeå°†æ•°æ®ä¼ è¾“åˆ°GPU2å†…å­˜

3. **æŠ€æœ¯ç»†èŠ‚**ï¼š
   - **InfiniBandæ¨¡å¼**ï¼šä½¿ç”¨IBç½‘å¡çš„loopbackåŠŸèƒ½ï¼Œæ”¯æŒGPUDirect RDMAï¼ˆå¦‚æœé…ç½®æ­£ç¡®ï¼‰
   - **ä»¥å¤ªç½‘æ¨¡å¼**ï¼šä½¿ç”¨ä»¥å¤ªç½‘å¡çš„loopbackï¼Œé€šè¿‡TCP/IPåè®®æ ˆ
   - **Socketæ¨¡å¼**ï¼šçº¯è½¯ä»¶å®ç°ï¼Œé€šè¿‡TCP Socketè¿›è¡Œæœ¬åœ°é€šä¿¡

4. **GPUDirect RDMAçš„ä½œç”¨**ï¼š
   - **å¯ç”¨æ—¶**ï¼šGPUå†…å­˜å¯ä»¥ç›´æ¥ä¸ç½‘å¡é€šä¿¡ï¼Œå‡å°‘CPUå†…å­˜æ‹·è´
   - **ç¦ç”¨æ—¶**ï¼šå¿…é¡»ç»è¿‡CPUå†…å­˜ä¸­è½¬ï¼Œå¢åŠ å»¶è¿Ÿå’ŒCPUè´Ÿè½½

5. **æ€§èƒ½å½±å“å› ç´ **ï¼š
   - **ç½‘å¡ç±»å‹**ï¼šIB > é«˜é€Ÿä»¥å¤ªç½‘ > æ ‡å‡†ä»¥å¤ªç½‘
   - **GPUDirectæ”¯æŒ**ï¼šRDMA > æ ‡å‡†DMA
   - **ç½‘ç»œæ ˆå¼€é”€**ï¼šåè®®å¤„ç†ã€ä¸­æ–­å¤„ç†ã€å†…å­˜æ‹·è´
   - **Loopbackå»¶è¿Ÿ**ï¼šç½‘å¡å†…éƒ¨å¤„ç†æ—¶é—´

**é€šä¿¡è·¯å¾„å¯¹æ¯”**ï¼š

| é€šä¿¡æ¨¡å¼ | æ•°æ®è·¯å¾„ | å»¶è¿Ÿç‰¹å¾ | å¸¦å®½ç‰¹å¾ | é€‚ç”¨åœºæ™¯ |
|----------|----------|----------|----------|----------|
| **NVLink** | `GPU1 â†” GPU2` | < 10Î¼s | > 200 GB/s | ç”Ÿäº§ç¯å¢ƒé¦–é€‰ |
| **PCIe P2P** | `GPU1 â†” PCIe â†” GPU2` | 10-50Î¼s | 32-63 GB/s | æ— NVLinkæ—¶çš„æœ€ä½³é€‰æ‹© |
| **å…±äº«å†…å­˜** | `GPU1 â†” CPUå†…å­˜ â†” GPU2` | 50-200Î¼s | ç³»ç»Ÿå†…å­˜å¸¦å®½ | å…¼å®¹æ€§ä¿éšœ |
| **IBç½‘ç»œ** | `GPU1 â†” CPU â†” IBç½‘å¡ â†” CPU â†” GPU2` | > 200Î¼s | 8-32 GB/s | IBåŠŸèƒ½éªŒè¯ |
| **ä»¥å¤ªç½‘** | `GPU1 â†” CPU â†” ä»¥å¤ªç½‘å¡ â†” CPU â†” GPU2` | > 500Î¼s | 4-16 GB/s | å…¼å®¹æ€§æµ‹è¯• |
| **Socket** | `GPU1 â†” CPU â†” TCPæ ˆ â†” CPU â†” GPU2` | > 1000Î¼s | < 4 GB/s | è°ƒè¯•ä¸“ç”¨ |

**å…³é”®ç†è§£**ï¼š

- NETæ¨¡å¼ä¸‹ï¼ŒGPUé—´é€šä¿¡**ä¸æ˜¯ç›´è¿**ï¼Œè€Œæ˜¯é€šè¿‡ç½‘ç»œæ ˆçš„æœ¬åœ°å›ç¯
- è¿™ç§é€šä¿¡æ–¹å¼ä¸»è¦ç”¨äº**åŠŸèƒ½éªŒè¯**è€Œéæ€§èƒ½ä¼˜åŒ–
- åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒNCCLä¼šä¼˜å…ˆé€‰æ‹©æ›´é«˜æ•ˆçš„ç›´è¿è·¯å¾„

**åŒé‡é€‰æ‹©é€»è¾‘**ï¼šè„šæœ¬é€‰æ‹©ç½‘ç»œé…ç½®ç­–ç•¥ï¼ŒNCCLé€‰æ‹©å®é™…é€šä¿¡è·¯å¾„

#### 2.3.3 å•èŠ‚ç‚¹ä¸“ç”¨å‚æ•°

**æ•°æ®å¤§å°é…ç½®**ï¼š

- `-s, --size SIZE`: æµ‹è¯•æ•°æ®å¤§å°
  - `1M` = 1MB (262144 å…ƒç´ ) - å»¶è¿Ÿæµ‹è¯•
  - `10M` = 10MB (2621440 å…ƒç´ ) - ä¸­ç­‰è´Ÿè½½
  - `100M` = 100MB (26214400 å…ƒç´ ) - å¸¦å®½æµ‹è¯•  
  - `1G` = 1GB (268435456 å…ƒç´ ) - æœ€å¤§ååé‡
  - `10G` = 10GB (2684354560 å…ƒç´ ) - æé™ååé‡æµ‹è¯•

**æµ‹è¯•æ—¶é•¿**ï¼š

- `-t, --time SECONDS`: æµ‹è¯•æŒç»­æ—¶é—´ [é»˜è®¤: 30ç§’]
  - å»ºè®®å»¶è¿Ÿæµ‹è¯•ï¼š10-30ç§’
  - å»ºè®®ååé‡æµ‹è¯•ï¼š60-120ç§’

**ç½‘ç»œåç«¯é€‰æ‹©**ï¼ˆNCCLé€šä¿¡è·¯å¾„æ§åˆ¶ï¼‰ï¼š

- `--network nvlink`: **å¼ºåˆ¶NVLinkè·¯å¾„**
  - ä»…åœ¨ç¡®è®¤å­˜åœ¨NVLinkè¿æ¥æ—¶ä½¿ç”¨
  - å¦‚æœç¡¬ä»¶ä¸æ”¯æŒï¼Œæµ‹è¯•å°†å¤±è´¥
  - ç”¨äºéªŒè¯NVLinkä¸“ç”¨æ€§èƒ½
  
- `--network auto`: **è‡ªåŠ¨è·¯å¾„é€‰æ‹©**ï¼ˆæ¨èï¼‰
  - **è„šæœ¬å±‚é¢**ï¼šè‡ªåŠ¨æ£€æµ‹IBè®¾å¤‡ï¼Œä¼˜å…ˆé…ç½®IBç¯å¢ƒå˜é‡
  - **NCCLå±‚é¢**ï¼šä»æŒ‰NVLink > PCIe P2P > SHM > NETä¼˜å…ˆçº§é€‰æ‹©å®é™…é€šä¿¡è·¯å¾„
  - **å®é™…æ•ˆæœ**ï¼šGPUé—´é€šä¿¡ä»éµå¾ªNCCLå†…éƒ¨ä¼˜å…ˆçº§ï¼Œç½‘ç»œé…ç½®ä¸»è¦å½±å“è·¨èŠ‚ç‚¹é€šä¿¡
  - é€‚ç”¨äºå¤§å¤šæ•°æ€§èƒ½æµ‹è¯•åœºæ™¯
  
- `--network ib`: **å¼ºåˆ¶IB Loopback**ï¼ˆç‰¹æ®Šæµ‹è¯•åœºæ™¯ï¼‰
  - é€šè¿‡IBç½‘å¡è¿›è¡Œæœ¬åœ°å›ç¯é€šä¿¡
  - **é‡è¦è¯´æ˜**ï¼šè¿™ä¸æ˜¯GPUé—´ç›´è¿ï¼Œè€Œæ˜¯æµ‹è¯•IBç½‘å¡æœ¬èº«çš„æ€§èƒ½
  - **åº”ç”¨åœºæ™¯**ï¼š
    - éªŒè¯IBç½‘å¡ç¡¬ä»¶åŠŸèƒ½ï¼ˆåœ¨å¤šèŠ‚ç‚¹éƒ¨ç½²å‰ï¼‰
    - æµ‹è¯•GPUDirect RDMAåŠŸèƒ½
    - æ’æŸ¥IBç½‘å¡é©±åŠ¨é—®é¢˜
    - å»ºç«‹IBç½‘ç»œæ€§èƒ½åŸºçº¿
  - **æ€§èƒ½ç‰¹ç‚¹**ï¼šé€šå¸¸æ¯”NVLink/PCIeæ…¢ï¼Œä½†éªŒè¯ç½‘ç»œæ ˆåŠŸèƒ½
  - éœ€è¦é…åˆç¯å¢ƒå˜é‡ï¼š`NCCL_IB_DISABLE=0`
  
- `--network ethernet`: **ä»¥å¤ªç½‘Loopback**ï¼ˆå…¼å®¹æ€§æµ‹è¯•ï¼‰
  - é€šè¿‡ä»¥å¤ªç½‘å¡è¿›è¡Œæœ¬åœ°å›ç¯
  - **åº”ç”¨åœºæ™¯**ï¼š
    - éªŒè¯NCCLåœ¨çº¯ä»¥å¤ªç½‘ç¯å¢ƒçš„å…¼å®¹æ€§
    - æµ‹è¯•å®¹å™¨åŒ–ç¯å¢ƒçš„ç½‘ç»œé…ç½®
    - æ’æŸ¥ç½‘ç»œæ ˆé—®é¢˜
    - æ¨¡æ‹Ÿä½å¸¦å®½ç½‘ç»œç¯å¢ƒ
  - **æ€§èƒ½ç‰¹ç‚¹**ï¼šæ€§èƒ½è¾ƒä½ï¼Œä¸»è¦ç”¨äºåŠŸèƒ½éªŒè¯
  - æ‰€æœ‰ç³»ç»Ÿéƒ½æ”¯æŒ
  
- `--network socket`: **Socketé€šä¿¡**ï¼ˆè°ƒè¯•ä¸“ç”¨ï¼‰
  - é€šè¿‡TCP Socketè¿›è¡Œé€šä¿¡
  - **åº”ç”¨åœºæ™¯**ï¼š
    - NCCLæ•…éšœæ’é™¤å’Œè°ƒè¯•
    - éªŒè¯æœ€åŸºç¡€çš„é€šä¿¡åŠŸèƒ½
    - æµ‹è¯•é˜²ç«å¢™å’Œç½‘ç»œç­–ç•¥
    - æ•™å­¦å’Œæ¼”ç¤ºç”¨é€”
  - **æ€§èƒ½ç‰¹ç‚¹**ï¼šæ€§èƒ½æœ€ä½ï¼Œä½†å…¼å®¹æ€§æœ€å¥½

**ä¼˜åŒ–çº§åˆ«é…ç½®**ï¼ˆä»…é€‚ç”¨äº NVLink ç½‘ç»œåç«¯ï¼‰ï¼š

> **é‡è¦è¯´æ˜**: `--optimization-level` å‚æ•°ä»…å¯¹ NVLink ç½‘ç»œåç«¯æœ‰æ•ˆã€‚å…¶ä»–ç½‘ç»œåç«¯ï¼ˆInfiniBandã€ä»¥å¤ªç½‘ã€PCIeã€Socketï¼‰ä½¿ç”¨å›ºå®šçš„ä¼˜åŒ–é…ç½®ï¼Œä¸æ”¯æŒåŠ¨æ€ä¼˜åŒ–çº§åˆ«è°ƒæ•´ã€‚

- `--optimization-level conservative`: **ä¿å®ˆé…ç½®**ï¼ˆä»… NVLinkï¼‰
  - ç¨³å®šæ€§ä¼˜å…ˆï¼Œå…¼å®¹æ€§æœ€å¥½
  - é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒå’Œå…³é”®ä»»åŠ¡
  - ä½¿ç”¨ç»è¿‡éªŒè¯çš„å‚æ•°ç»„åˆ
  
- `--optimization-level balanced`: **å¹³è¡¡é…ç½®**ï¼ˆä»… NVLinkï¼Œæ¨èï¼‰
  - æ€§èƒ½ä¸ç¨³å®šæ€§å…¼é¡¾
  - å¯ç”¨ç®—æ³•å’Œåè®®è‡ªåŠ¨é€‰æ‹©
  - é€‚ç”¨äºå¤§å¤šæ•°åº”ç”¨åœºæ™¯
  
- `--optimization-level aggressive`: **æ¿€è¿›é…ç½®**ï¼ˆä»… NVLinkï¼‰
  - æœ€å¤§æ€§èƒ½ä¼˜åŒ–
  - ç§»é™¤æ‰€æœ‰ç®—æ³•é™åˆ¶
  - å¯ç”¨NCCLå®Œå…¨è‡ªåŠ¨ä¼˜åŒ–
  - é€‚ç”¨äºæ€§èƒ½æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•

**è°ƒè¯•é€‰é¡¹**ï¼š

- `--check-only`: ä»…æ£€æŸ¥ç¯å¢ƒï¼Œä¸è¿è¡Œæµ‹è¯•
- `--env-only`: æ˜¾ç¤ºç¯å¢ƒå˜é‡é…ç½®
- `--dry-run`: Dry-runæ¨¡å¼ï¼Œæ£€æŸ¥ç¯å¢ƒå’Œé…ç½®ä½†ä¸æ‰§è¡Œæµ‹è¯•
- `-q, --quiet`: é™é»˜æ¨¡å¼

### 2.4 å•èŠ‚ç‚¹æµ‹è¯•å®è·µ

#### 2.4.1 å¿«é€ŸéªŒè¯æµ‹è¯•

```bash
# åŸºç¡€ç¯å¢ƒæ£€æŸ¥
./nccl_benchmark.sh --check-only

# Dry-runæ¨¡å¼ï¼šæ£€æŸ¥ç¯å¢ƒå’Œé…ç½®ä½†ä¸æ‰§è¡Œæµ‹è¯•
./nccl_benchmark.sh --dry-run

# å¿«é€Ÿæ€§èƒ½æµ‹è¯•ï¼ˆ1MBæ•°æ®ï¼Œ30ç§’ï¼Œå¹³è¡¡ä¼˜åŒ–ï¼‰
./nccl_benchmark.sh --optimization-level balanced

# æŸ¥çœ‹ç¯å¢ƒé…ç½®
./nccl_benchmark.sh --env-only

# ä¸åŒä¼˜åŒ–çº§åˆ«æµ‹è¯•ï¼ˆä»…é€‚ç”¨äº NVLink ç½‘ç»œåç«¯ï¼‰
./nccl_benchmark.sh --network nvlink --optimization-level conservative -s 100M -t 60  # ä¿å®ˆé…ç½®
./nccl_benchmark.sh --network nvlink --optimization-level balanced -s 1G -t 60        # å¹³è¡¡é…ç½®ï¼ˆæ¨èï¼‰
./nccl_benchmark.sh --network nvlink --optimization-level aggressive -s 1G -t 60      # æ¿€è¿›é…ç½®
```

#### 2.4.2 ç»Ÿä¸€é…ç½®ç®¡ç†å™¨

**æ–°ç‰ˆæœ¬ç‰¹æ€§**ï¼šè„šæœ¬ç°åœ¨ä½¿ç”¨ç»Ÿä¸€é…ç½®ç®¡ç†å™¨è‡ªåŠ¨åŒ–NCCLç¯å¢ƒå˜é‡è®¾ç½®ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚

**è‡ªåŠ¨é…ç½®åŠŸèƒ½**ï¼š

```bash
# 1. è‡ªåŠ¨æ£€æµ‹å’Œé…ç½®ï¼ˆæ¨èï¼‰
./nccl_benchmark.sh --network auto --optimization-level balanced

# 2. æŸ¥çœ‹è‡ªåŠ¨é…ç½®çš„ç¯å¢ƒå˜é‡
./nccl_benchmark.sh --env-only

# 3. ä¸åŒç½‘ç»œåç«¯çš„è‡ªåŠ¨é…ç½®
./nccl_benchmark.sh --network nvlink --optimization-level aggressive  # NVLinkä¼˜åŒ–ï¼ˆæ”¯æŒä¼˜åŒ–çº§åˆ«ï¼‰
./nccl_benchmark.sh --network ib                                      # InfiniBandä¼˜åŒ–ï¼ˆå›ºå®šé…ç½®ï¼‰
./nccl_benchmark.sh --network pcie                                    # PCIeä¼˜åŒ–ï¼ˆå›ºå®šé…ç½®ï¼‰
```

**é…ç½®ç®¡ç†å™¨åŠŸèƒ½**ï¼š

- **æ‰¹é‡é…ç½®è®¾ç½®**ï¼šæ”¯æŒé…ç½®ç»„çš„ç»Ÿä¸€ç®¡ç†
- **æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ**ï¼šé¿å…é‡å¤æ£€æµ‹ï¼Œæå‡é…ç½®æ•ˆç‡
- **ç½‘ç»œé…ç½®é¢„è®¾**ï¼šæä¾›å¤šç§é¢„è®¾é…ç½®æ¨¡æ¿
- **æ€§èƒ½ä¼˜åŒ–é…ç½®**ï¼šä¸‰çº§ä¼˜åŒ–ç­–ç•¥è‡ªåŠ¨è°ƒæ•´å‚æ•°

**æ‰‹åŠ¨é…ç½®ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰**ï¼š

```bash
# ä»ç„¶æ”¯æŒæ‰‹åŠ¨ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
export NCCL_DEBUG=INFO         # è¯¦ç»†è°ƒè¯•ä¿¡æ¯
export NCCL_DEBUG_SUBSYS=INIT,NET  # åˆå§‹åŒ–å’Œç½‘ç»œå­ç³»ç»Ÿè°ƒè¯•

# è¿è¡Œæµ‹è¯•
./nccl_benchmark.sh --network auto

# æ¸…ç†ç¯å¢ƒå˜é‡
unset NCCL_DEBUG NCCL_DEBUG_SUBSYS
```

**é‡è¦è¯´æ˜**ï¼š

- **é»˜è®¤è¡Œä¸º**ï¼šNCCLä¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è·¯å¾„ï¼Œé€šå¸¸æ— éœ€æ‰‹åŠ¨é…ç½®
- **IBå¼ºåˆ¶ä½¿ç”¨**ï¼šåœ¨å•èŠ‚ç‚¹ä¸­å¼ºåˆ¶ä½¿ç”¨IBæ˜¯éå…¸å‹é…ç½®ï¼Œä¸»è¦ç”¨äºæµ‹è¯•IBç½‘å¡æ€§èƒ½
- **æ€§èƒ½å½±å“**ï¼šå¼ºåˆ¶é…ç½®å¯èƒ½é™ä½æ€§èƒ½ï¼Œå»ºè®®ä»…ç”¨äºè°ƒè¯•å’Œç‰¹æ®Šæµ‹è¯•

#### 2.4.3 å»¶è¿Ÿä¼˜åŒ–æµ‹è¯•

```bash
# å°æ•°æ®åŒ…å»¶è¿Ÿæµ‹è¯•ï¼ˆNVLinkï¼‰
./nccl_benchmark.sh --network nvlink -s 1M -t 30

# InfiniBandå»¶è¿Ÿæµ‹è¯•
./nccl_benchmark.sh --network ib -s 1M -t 30

# å¯¹æ¯”ä¸åŒç½‘ç»œåç«¯çš„å»¶è¿Ÿ
for backend in nvlink ib ethernet socket; do
    echo "=== æµ‹è¯• $backend å»¶è¿Ÿ ==="
    ./nccl_benchmark.sh --network $backend -s 1M -t 10 -q
done
```

#### 2.4.4 å¸¦å®½æ€§èƒ½æµ‹è¯•

```bash
# å¤§æ•°æ®ååé‡æµ‹è¯•ï¼ˆNVLinkï¼‰
./nccl_benchmark.sh --network nvlink -s 1G -t 120

# InfiniBandå¸¦å®½æµ‹è¯•
./nccl_benchmark.sh --network ib -s 1G -t 120

# æ¸è¿›å¼æ•°æ®å¤§å°æµ‹è¯•
for size in 1M 10M 100M 1G 10G; do
    echo "=== æµ‹è¯•æ•°æ®å¤§å°: $size ==="
    ./nccl_benchmark.sh --network auto -s $size -t 60
done
```

#### 2.4.5 æ€§èƒ½åŸºå‡†å»ºç«‹

```bash
# å®Œæ•´æ€§èƒ½åŸºå‡†æµ‹è¯•å¥—ä»¶
echo "å¼€å§‹å•èŠ‚ç‚¹NCCLæ€§èƒ½åŸºå‡†æµ‹è¯•..."

# 1. å»¶è¿ŸåŸºå‡†ï¼ˆå°æ•°æ®åŒ…ï¼‰
echo "1. å»¶è¿ŸåŸºå‡†æµ‹è¯•"
./nccl_benchmark.sh --network nvlink -s 1M -t 30 > baseline_latency_nvlink.log
./nccl_benchmark.sh --network ib -s 1M -t 30 > baseline_latency_ib.log

# 2. å¸¦å®½åŸºå‡†ï¼ˆå¤§æ•°æ®åŒ…ï¼‰
echo "2. å¸¦å®½åŸºå‡†æµ‹è¯•"  
./nccl_benchmark.sh --network nvlink -s 1G -t 120 > baseline_bandwidth_nvlink.log
./nccl_benchmark.sh --network ib -s 1G -t 120 > baseline_bandwidth_ib.log

# 3. æ··åˆè´Ÿè½½æµ‹è¯•
echo "3. æ··åˆè´Ÿè½½æµ‹è¯•"
./nccl_benchmark.sh --network auto -s 100M -t 300 > baseline_mixed_load.log

echo "åŸºå‡†æµ‹è¯•å®Œæˆï¼Œç»“æœä¿å­˜åœ¨ baseline_*.log æ–‡ä»¶ä¸­"
```

### 2.5 å•èŠ‚ç‚¹æ€§èƒ½åˆ†æ

#### 2.5.1 æ€§èƒ½æŒ‡æ ‡è§£è¯»

**å»¶è¿ŸæŒ‡æ ‡**ï¼š

- **< 10Î¼s**: ä¼˜ç§€ï¼ˆNVLinkç›´è¿ï¼‰
- **10-50Î¼s**: è‰¯å¥½ï¼ˆPCIeæˆ–é«˜é€ŸIBï¼‰
- **50-200Î¼s**: å¯æ¥å—ï¼ˆæ ‡å‡†IBæˆ–ä»¥å¤ªç½‘ï¼‰
- **> 200Î¼s**: éœ€è¦ä¼˜åŒ–

**å¸¦å®½æŒ‡æ ‡**ï¼š

- **NVLink**: æœŸæœ› > 200 GB/sï¼ˆåŒå‘ï¼‰
- **PCIeè¿æ¥**ï¼š
  - **PCIe 3.0 x16**: æœŸæœ› > 12 GB/sï¼ˆç†è®º15.75 GB/sï¼‰
  - **PCIe 4.0 x16**: æœŸæœ› > 20 GB/sï¼ˆç†è®º31.5 GB/sï¼‰
  - **PCIe 5.0 x16**: æœŸæœ› > 40 GB/sï¼ˆç†è®º63 GB/sï¼‰
- **InfiniBandï¼ˆå•èŠ‚ç‚¹loopbackæµ‹è¯•ï¼‰**ï¼š
  - **EDR (100Gb/s)**: æœŸæœ› > 8 GB/sï¼ˆå—loopbacké™åˆ¶ï¼‰
  - **HDR (200Gb/s)**: æœŸæœ› > 16 GB/sï¼ˆå—loopbacké™åˆ¶ï¼‰
  - **NDR (400Gb/s)**: æœŸæœ› > 32 GB/sï¼ˆå—loopbacké™åˆ¶ï¼‰
  - **æ³¨æ„**: å•èŠ‚ç‚¹IBæµ‹è¯•æ€§èƒ½è¿œä½äºç†è®ºå€¼ï¼Œä¸»è¦ç”¨äºåŠŸèƒ½éªŒè¯
- **ä»¥å¤ªç½‘ï¼ˆå•èŠ‚ç‚¹loopbackæµ‹è¯•ï¼‰**ï¼š
  - **100GbE**: æœŸæœ› > 4 GB/sï¼ˆå—loopbackå’Œåè®®æ ˆé™åˆ¶ï¼‰
  - **200GbE**: æœŸæœ› > 8 GB/sï¼ˆå—loopbackå’Œåè®®æ ˆé™åˆ¶ï¼‰
  - **400GbE**: æœŸæœ› > 16 GB/sï¼ˆå—loopbackå’Œåè®®æ ˆé™åˆ¶ï¼‰
  - **æ³¨æ„**: å•èŠ‚ç‚¹ä»¥å¤ªç½‘æµ‹è¯•ä¸»è¦ç”¨äºå…¼å®¹æ€§éªŒè¯ï¼Œæ€§èƒ½ä¸å…·å‚è€ƒä»·å€¼

**æ•ˆç‡æŒ‡æ ‡**ï¼š

- **ç®—æ³•æ•ˆç‡**: å®é™…å¸¦å®½ / ç†è®ºå¸¦å®½ > 80%
- **ç½‘ç»œåˆ©ç”¨ç‡**: NCCLå¸¦å®½ / ç½‘ç»œå¸¦å®½ > 70%
- **GPUåˆ©ç”¨ç‡**: é€šä¿¡æœŸé—´GPUä½¿ç”¨ç‡ > 90%

#### 2.5.2 å¸¸è§æ€§èƒ½é—®é¢˜

**å»¶è¿Ÿè¿‡é«˜**ï¼š

- æ£€æŸ¥GPUæ‹“æ‰‘ï¼š`nvidia-smi topo -m`
- éªŒè¯NVLinkçŠ¶æ€ï¼š`nvidia-smi nvlink -s`
- ç¡®è®¤NCCLç®—æ³•é€‰æ‹©ï¼šæŸ¥çœ‹æ—¥å¿—ä¸­çš„ç®—æ³•ä¿¡æ¯

**å¸¦å®½ä¸è¶³**ï¼š

- æ£€æŸ¥PCIeé“¾è·¯çŠ¶æ€ï¼š`lspci -vvv | grep -A5 NVIDIA`
- éªŒè¯å†…å­˜å¸¦å®½ï¼šè¿è¡ŒGPUå†…å­˜å¸¦å®½æµ‹è¯•
- ç¡®è®¤NCCLç½‘ç»œåç«¯ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡è®¾ç½®

**æ€§èƒ½ä¸ç¨³å®š**ï¼š

- æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½ï¼š`htop`, `nvidia-smi`
- éªŒè¯æ¸©åº¦æ§åˆ¶ï¼šé¿å…GPUè¿‡çƒ­é™é¢‘
- ç¡®è®¤ç”µæºç®¡ç†ï¼šè®¾ç½®é«˜æ€§èƒ½æ¨¡å¼

---

## 3. å®¹å™¨åŒ–æµ‹è¯•

### 3.1 å®¹å™¨åŒ–æµ‹è¯•æ¦‚è¿°

`nccl_container_manager.sh` æä¾›äº†åŸºäº Docker å®¹å™¨çš„ NCCL æµ‹è¯•è§£å†³æ–¹æ¡ˆï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

#### 3.1.1 å®¹å™¨åŒ–çš„ä¼˜åŠ¿

**ç¯å¢ƒéš”ç¦»**ï¼š

- é¿å…ä¸»æœºç¯å¢ƒä¾èµ–å†²çª
- æä¾›ä¸€è‡´çš„æµ‹è¯•ç¯å¢ƒ
- ç®€åŒ–éƒ¨ç½²å’Œç»´æŠ¤

**ç¡¬ä»¶è®¿é—®**ï¼š

- ç‰¹æƒæ¨¡å¼æä¾›å®Œæ•´çš„ç¡¬ä»¶è®¿é—®æƒé™
- æ”¯æŒ GPUã€InfiniBandã€NVLink ç­‰è®¾å¤‡
- Host Network æ¨¡å¼é¿å…ç½‘ç»œæ€§èƒ½æŸå¤±

**é…ç½®çµæ´»æ€§**ï¼š

- æ”¯æŒå¤šç§ç½‘ç»œåç«¯é…ç½®
- å¯å®šåˆ¶çš„æµ‹è¯•å‚æ•°
- äº¤äº’æ¨¡å¼ç”¨äºè°ƒè¯•

#### 3.1.2 æŠ€æœ¯ç‰¹æ€§

**ç½‘ç»œæ¨¡å¼**ï¼š

- **Host Network**ï¼šç›´æ¥ä½¿ç”¨ä¸»æœºç½‘ç»œï¼Œæ—  Docker ç½‘ç»œå±‚å¼€é”€
- **ç‰¹æƒæ¨¡å¼**ï¼šå®Œæ•´çš„è®¾å¤‡è®¿é—®æƒé™ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‚è½½è®¾å¤‡

**GPU æ”¯æŒ**ï¼š

- NVIDIA Container Toolkit é›†æˆ
- æ”¯æŒæŒ‡å®š GPU æ•°é‡å’Œ ID
- å®Œæ•´çš„ CUDA å’Œ NCCL æ”¯æŒ

**å­˜å‚¨æŒ‚è½½**ï¼š

- è‡ªåŠ¨æŒ‚è½½å¿…è¦çš„ç³»ç»Ÿç›®å½•
- æ—¥å¿—æ–‡ä»¶æŒä¹…åŒ–åˆ°ä¸»æœº
- é…ç½®æ–‡ä»¶å…±äº«

### 3.2 å‰ç½®æ¡ä»¶

#### 3.2.1 è½¯ä»¶è¦æ±‚

```bash
# 1. å®‰è£… Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 2. å®‰è£… NVIDIA Container Toolkit
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list

sudo apt-get update && sudo apt-get install -y nvidia-docker2
sudo systemctl restart docker

# 3. éªŒè¯ GPU å®¹å™¨æ”¯æŒ
docker run --rm --gpus all nvidia/cuda:11.8-base-ubuntu20.04 nvidia-smi
```

#### 3.2.2 æ„å»ºæµ‹è¯•é•œåƒ

```bash
# æ„å»º NCCL æµ‹è¯•é•œåƒ
docker build -t nccl-test:latest .

# éªŒè¯é•œåƒæ„å»ºæˆåŠŸ
docker images | grep nccl-test
```

### 3.3 åŸºæœ¬ä½¿ç”¨

#### 3.3.1 å¿«é€Ÿæµ‹è¯•

```bash
# åŸºç¡€æµ‹è¯•ï¼ˆä½¿ç”¨æ‰€æœ‰ GPUï¼‰
./nccl_container_manager.sh --gpus all --size 100M --time 60

# Dry-run æ¨¡å¼ï¼ˆæ£€æŸ¥é…ç½®ä½†ä¸æ‰§è¡Œæµ‹è¯•ï¼‰
./nccl_container_manager.sh --dry-run --gpus all --size 100M

# äº¤äº’æ¨¡å¼ï¼ˆè¿›å…¥å®¹å™¨è°ƒè¯•ï¼‰
./nccl_container_manager.sh --interactive
```

#### 3.3.2 ç½‘ç»œåç«¯æµ‹è¯•

```bash
# è‡ªåŠ¨é€‰æ‹©æœ€ä½³ç½‘ç»œåç«¯
./nccl_container_manager.sh --gpus 4 --network auto --size 1G

# å¼ºåˆ¶ä½¿ç”¨ NVLinkï¼ˆå•èŠ‚ç‚¹å¤šGPUï¼‰
./nccl_container_manager.sh --gpus 4 --network nvlink --size 500M

# å¼ºåˆ¶ä½¿ç”¨ InfiniBand
./nccl_container_manager.sh --gpus 2 --network ib --size 100M

# ä½¿ç”¨ä»¥å¤ªç½‘
./nccl_container_manager.sh --gpus 2 --network ethernet --size 50M

# ä½¿ç”¨å…±äº«å†…å­˜
./nccl_container_manager.sh --gpus 2 --network shm --size 10M
```

#### 3.3.3 GPU é…ç½®é€‰é¡¹

```bash
# ä½¿ç”¨æ‰€æœ‰å¯ç”¨ GPU
./nccl_container_manager.sh --gpus all

# ä½¿ç”¨æŒ‡å®šæ•°é‡çš„ GPU
./nccl_container_manager.sh --gpus 4

# ä½¿ç”¨ç‰¹å®š GPU ID
./nccl_container_manager.sh --gpus 0,1,2,3

# ä½¿ç”¨å•ä¸ª GPUï¼ˆæµ‹è¯•åŸºç¡€åŠŸèƒ½ï¼‰
./nccl_container_manager.sh --gpus 1
```

### 3.4 é«˜çº§é…ç½®

#### 3.4.1 è‡ªå®šä¹‰å®¹å™¨é…ç½®

```bash
# è‡ªå®šä¹‰å®¹å™¨åç§°å’Œé•œåƒ
./nccl_container_manager.sh \
    --container-name my-nccl-test \
    --image-name my-nccl:v1.0 \
    --gpus 4 --size 1G

# ä¿ç•™å®¹å™¨ç”¨äºè°ƒè¯•
./nccl_container_manager.sh \
    --no-cleanup \
    --gpus 2 --size 100M

# å¯ç”¨è¯¦ç»†æ—¥å¿—
./nccl_container_manager.sh \
    --log-level DEBUG \
    --gpus 4 --size 500M
```

#### 3.4.2 æ€§èƒ½æµ‹è¯•å¥—ä»¶

```bash
# å»¶è¿Ÿæµ‹è¯•å¥—ä»¶
echo "=== å»¶è¿Ÿæµ‹è¯•å¥—ä»¶ ==="
for backend in nvlink ib ethernet; do
    echo "æµ‹è¯• $backend å»¶è¿Ÿ..."
    ./nccl_container_manager.sh \
        --gpus 2 --network $backend \
        --size 1M --time 30
done

# å¸¦å®½æµ‹è¯•å¥—ä»¶
echo "=== å¸¦å®½æµ‹è¯•å¥—ä»¶ ==="
for size in 100M 500M 1G; do
    echo "æµ‹è¯•æ•°æ®å¤§å°: $size"
    ./nccl_container_manager.sh \
        --gpus 4 --network auto \
        --size $size --time 120
done

# æ‰©å±•æ€§æµ‹è¯•å¥—ä»¶
echo "=== æ‰©å±•æ€§æµ‹è¯•å¥—ä»¶ ==="
for gpus in 1 2 4 8; do
    echo "æµ‹è¯• GPU æ•°é‡: $gpus"
    ./nccl_container_manager.sh \
        --gpus $gpus --network nvlink \
        --size 100M --time 60
done
```

### 3.5 æ•…éšœæ’é™¤

#### 3.5.1 å¸¸è§é—®é¢˜

**Docker æƒé™é—®é¢˜**ï¼š

```bash
# å°†ç”¨æˆ·æ·»åŠ åˆ° docker ç»„
sudo usermod -aG docker $USER
# é‡æ–°ç™»å½•æˆ–æ‰§è¡Œ
newgrp docker
```

**NVIDIA Container Toolkit é—®é¢˜**ï¼š

```bash
# æ£€æŸ¥ NVIDIA è¿è¡Œæ—¶
docker info | grep nvidia

# æµ‹è¯• GPU è®¿é—®
docker run --rm --gpus all nvidia/cuda:11.8-base-ubuntu20.04 nvidia-smi
```

**é•œåƒæ„å»ºå¤±è´¥**ï¼š

```bash
# æ£€æŸ¥ Dockerfile æ˜¯å¦å­˜åœ¨
ls -la Dockerfile

# æ‰‹åŠ¨æ„å»ºå¹¶æŸ¥çœ‹è¯¦ç»†è¾“å‡º
docker build -t nccl-test:latest . --no-cache --progress=plain
```

#### 3.5.2 è°ƒè¯•æŠ€å·§

**äº¤äº’æ¨¡å¼è°ƒè¯•**ï¼š

```bash
# è¿›å…¥å®¹å™¨è¿›è¡Œæ‰‹åŠ¨è°ƒè¯•
./nccl_container_manager.sh --interactive

# åœ¨å®¹å™¨å†…æ‰‹åŠ¨è¿è¡Œæµ‹è¯•
cd /workspace/nccl_test
./nccl_benchmark.sh --network auto --size 100M
```

**æ—¥å¿—åˆ†æ**ï¼š

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs nccl-test

# æŸ¥çœ‹è¯¦ç»†çš„ NCCL æ—¥å¿—
./nccl_container_manager.sh --log-level DEBUG --gpus 2 --size 100M
```

### 3.6 æœ€ä½³å®è·µ

#### 3.6.1 æ€§èƒ½ä¼˜åŒ–

- **ä½¿ç”¨ Host Network**ï¼šé¿å… Docker ç½‘ç»œå±‚å¼€é”€
- **ç‰¹æƒæ¨¡å¼**ï¼šç¡®ä¿å®Œæ•´çš„ç¡¬ä»¶è®¿é—®æƒé™
- **GPU äº²å’Œæ€§**ï¼šåœ¨å¤š GPU ç³»ç»Ÿä¸­åˆç†åˆ†é… GPU
- **å†…å­˜ç®¡ç†**ï¼šç¡®ä¿å®¹å™¨æœ‰è¶³å¤Ÿçš„å†…å­˜ç”¨äºå¤§è§„æ¨¡æµ‹è¯•

#### 3.6.2 å®‰å…¨è€ƒè™‘

- **ç‰¹æƒæ¨¡å¼é£é™©**ï¼šä»…åœ¨å—ä¿¡ä»»çš„ç¯å¢ƒä¸­ä½¿ç”¨ç‰¹æƒæ¨¡å¼
- **ç½‘ç»œéš”ç¦»**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­è€ƒè™‘ç½‘ç»œå®‰å…¨ç­–ç•¥
- **èµ„æºé™åˆ¶**ï¼šæ ¹æ®éœ€è¦è®¾ç½® CPU å’Œå†…å­˜é™åˆ¶

#### 3.6.3 ç”Ÿäº§éƒ¨ç½²å»ºè®®

- **é•œåƒç®¡ç†**ï¼šä½¿ç”¨ç§æœ‰é•œåƒä»“åº“ç®¡ç†æµ‹è¯•é•œåƒ
- **é…ç½®ç®¡ç†**ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†å¤æ‚çš„æµ‹è¯•å‚æ•°
- **ç›‘æ§é›†æˆ**ï¼šé›†æˆç›‘æ§ç³»ç»Ÿè·Ÿè¸ªæµ‹è¯•æ€§èƒ½
- **è‡ªåŠ¨åŒ–**ï¼šç»“åˆ CI/CD æµæ°´çº¿è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•

---

## 4. å¤šèŠ‚ç‚¹æµ‹è¯•

### 4.1 å¤šèŠ‚ç‚¹æµ‹è¯•æ¦‚è¿°

å¤šèŠ‚ç‚¹ NCCL æµ‹è¯•ç”¨äºéªŒè¯è·¨èŠ‚ç‚¹çš„åˆ†å¸ƒå¼é€šä¿¡æ€§èƒ½ï¼Œæ˜¯å¤§è§„æ¨¡è®­ç»ƒç¯å¢ƒçš„é‡è¦éªŒè¯æ‰‹æ®µã€‚æœ¬å·¥å…·æä¾›ä¸¤ç§å¤šèŠ‚ç‚¹æµ‹è¯•æ–¹æ¡ˆï¼š

#### 4.1.1 åŸç”Ÿå¤šèŠ‚ç‚¹éƒ¨ç½²

ä½¿ç”¨ `nccl_multinode_launcher.sh` è„šæœ¬è¿›è¡Œä¼ ç»Ÿçš„è£¸æœºå¤šèŠ‚ç‚¹éƒ¨ç½²ï¼š

- **é€‚ç”¨åœºæ™¯**ï¼šä¼ ç»Ÿ HPC ç¯å¢ƒã€è£¸æœºéƒ¨ç½²
- **ä¼˜åŠ¿**ï¼šé…ç½®ç®€å•ã€ç›´æ¥æ§åˆ¶
- **åŠ£åŠ¿**ï¼šæ‰‹åŠ¨ç®¡ç†ã€æ‰©å±•æ€§æœ‰é™

#### 4.1.2 Kubernetes å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼ˆæ¨èï¼‰

ä½¿ç”¨ `k8s/deploy.sh` è„šæœ¬è¿›è¡Œç°ä»£åŒ–çš„å®¹å™¨ç¼–æ’éƒ¨ç½²ï¼š

- **é€‚ç”¨åœºæ™¯**ï¼šäº‘åŸç”Ÿç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒ
- **ä¼˜åŠ¿**ï¼šè‡ªåŠ¨è°ƒåº¦ã€èµ„æºç®¡ç†ã€æ•…éšœæ¢å¤ã€æ˜“æ‰©å±•
- **åŠ£åŠ¿**ï¼šéœ€è¦ Kubernetes é›†ç¾¤

**æ¨èä½¿ç”¨ Kubernetes æ–¹æ¡ˆ**ï¼Œç‰¹åˆ«æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒå’Œäº‘ç¯å¢ƒä¸­ã€‚

### 4.2 å¿«é€Ÿå¼€å§‹

#### 4.2.1 æ–¹æ¡ˆé€‰æ‹©

æ ¹æ®ä½ çš„ç¯å¢ƒé€‰æ‹©åˆé€‚çš„éƒ¨ç½²æ–¹æ¡ˆï¼š

**Kubernetes æ–¹æ¡ˆï¼ˆæ¨èï¼‰**ï¼š

```bash
# è¿›å…¥ Kubernetes é…ç½®ç›®å½•
cd k8s/

# å¿«é€Ÿéƒ¨ç½²ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
./deploy.sh deploy

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
./deploy.sh status

# æŸ¥çœ‹æµ‹è¯•æ—¥å¿—
./deploy.sh logs

# æ¸…ç†èµ„æº
./deploy.sh cleanup
```

**åŸç”Ÿæ–¹æ¡ˆ**ï¼š

```bash
# èŠ‚ç‚¹1 (ä¸»èŠ‚ç‚¹ - 192.168.1.100)
./nccl_multinode_launcher.sh 0 192.168.1.100

# èŠ‚ç‚¹2 (å·¥ä½œèŠ‚ç‚¹ - 192.168.1.101)  
./nccl_multinode_launcher.sh 1 192.168.1.100
```

**ç›´æ¥ä½¿ç”¨ nccl_benchmark.sh è¿›è¡Œå¤šèŠ‚ç‚¹æµ‹è¯•**ï¼š

```bash
# åŸºç¡€å¤šèŠ‚ç‚¹æµ‹è¯•ï¼ˆè‡ªåŠ¨ç½‘ç»œæ£€æµ‹ï¼‰
./nccl_benchmark.sh -m --master-addr 192.168.1.100

# æŒ‡å®šç½‘ç»œåç«¯ï¼ˆä¼˜åŒ–çº§åˆ«ä»…é€‚ç”¨äº NVLinkï¼‰
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ib

# å¤§æ•°æ®é‡é•¿æ—¶é—´æµ‹è¯•
./nccl_benchmark.sh -m --master-addr 192.168.1.100 -s 100M -t 120

# Dry-run æ¨¡å¼éªŒè¯é…ç½®
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --dry-run
```

#### 4.2.2 Kubernetes è‡ªå®šä¹‰é…ç½®

```bash
# è‡ªå®šä¹‰ GPU æ•°é‡å’Œæµ‹è¯•å‚æ•°
./deploy.sh deploy --gpus 4 --test-size 1G --test-duration 120

# æŒ‡å®šå‘½åç©ºé—´å’Œä½œä¸šåç§°
./deploy.sh deploy --namespace nccl-test --job-name my-nccl-test

# æŒ‡å®šç½‘ç»œåç«¯
./deploy.sh deploy --network-backend ib --test-size 500M

# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‚æ•°
./deploy.sh --help
```

#### 4.2.3 åŸç”Ÿéƒ¨ç½²åŸºç¡€é…ç½®

**åŸºç¡€2èŠ‚ç‚¹æµ‹è¯•**ï¼š

```bash
# èŠ‚ç‚¹1 (ä¸»èŠ‚ç‚¹ - 192.168.1.100)
./nccl_multinode_launcher.sh 0 192.168.1.100

# èŠ‚ç‚¹2 (å·¥ä½œèŠ‚ç‚¹ - 192.168.1.101)  
./nccl_multinode_launcher.sh 1 192.168.1.100
```

**ç›´æ¥ä½¿ç”¨ nccl_benchmark.sh è¿›è¡Œå¤šèŠ‚ç‚¹æµ‹è¯•**ï¼š

```bash
# åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼ˆè‡ªåŠ¨ç½‘ç»œæ£€æµ‹ï¼‰
./nccl_benchmark.sh -m --master-addr 192.168.1.100

# æŒ‡å®šç½‘ç»œåç«¯
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ib
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ethernet

# é…ç½®ä¼˜åŒ–çº§åˆ«ï¼ˆä»…åœ¨å•èŠ‚ç‚¹ NVLink ç¯å¢ƒä¸‹æœ‰æ•ˆï¼Œå¤šèŠ‚ç‚¹ç¯å¢ƒä¼šè‡ªåŠ¨å¿½ç•¥ï¼‰
# æ³¨æ„ï¼šå¤šèŠ‚ç‚¹ç¯å¢ƒä¸‹ï¼Œä¼˜åŒ–çº§åˆ«å‚æ•°ä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºå¤šèŠ‚ç‚¹é€šä¿¡ä¸»è¦ä½¿ç”¨ InfiniBand æˆ–ä»¥å¤ªç½‘
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --optimization-level conservative  # å‚æ•°ä¼šè¢«å¿½ç•¥
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --optimization-level balanced     # å‚æ•°ä¼šè¢«å¿½ç•¥
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --optimization-level aggressive   # å‚æ•°ä¼šè¢«å¿½ç•¥

# è‡ªå®šä¹‰æµ‹è¯•å‚æ•°
./nccl_benchmark.sh -m --master-addr 192.168.1.100 -s 100M -t 120 --network ib
```

**IP åœ°å€è¯´æ˜**:

- `192.168.1.100` æ˜¯ç¤ºä¾‹ä¸»èŠ‚ç‚¹ IP åœ°å€ï¼Œ**å®é™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„ä¸»èŠ‚ç‚¹ IP**
- å½“ä½¿ç”¨ IPoIB æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ InfiniBand ç½‘å¡ (å¦‚ `ib0`) ä¸Šé…ç½®çš„ IP åœ°å€
- å½“ä½¿ç”¨ä»¥å¤ªç½‘æ—¶ï¼Œä½¿ç”¨ä»¥å¤ªç½‘ç½‘å¡ (å¦‚ `eth0`) ä¸Šçš„ IP åœ°å€
- æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦æŒ‡å®šç›¸åŒçš„ä¸»èŠ‚ç‚¹ IP åœ°å€è¿›è¡Œåè°ƒ

**è‡ªå®šä¹‰é…ç½®æµ‹è¯•**ï¼š

```bash
# 4èŠ‚ç‚¹8GPUé«˜æ€§èƒ½æµ‹è¯•
./nccl_multinode_launcher.sh 0 192.168.1.100 -w 8 -n 2 -s 100M -t 120

# æŒ‡å®šç½‘ç»œåç«¯ç±»å‹
./nccl_multinode_launcher.sh 0 192.168.1.100 --network ib -w 4 -n 2
```

**ç½‘ç»œç±»å‹æŒ‡å®š**ï¼š

`nccl_benchmark.sh` å’Œ `nccl_multinode_launcher.sh` è„šæœ¬éƒ½æ”¯æŒé€šè¿‡ `--network` å‚æ•°æŒ‡å®šç½‘ç»œåç«¯ï¼š

```bash
# ä½¿ç”¨ InfiniBand (æ¨èï¼Œé»˜è®¤)
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ib

# ä½¿ç”¨ä»¥å¤ªç½‘
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ethernet

# ä½¿ç”¨ Socket (è°ƒè¯•ç”¨)
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network socket

# è‡ªåŠ¨æ£€æµ‹ï¼ˆæ¨èï¼‰
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network auto
```

**ç½‘ç»œåç«¯è¯´æ˜**:

| ç½‘ç»œç±»å‹ | å‚æ•°å€¼ | æ€§èƒ½ç‰¹å¾ | é€‚ç”¨åœºæ™¯ |
|----------|--------|----------|----------|
| **è‡ªåŠ¨æ£€æµ‹** | `auto` | æ™ºèƒ½é€‰æ‹©æœ€ä¼˜ç½‘ç»œ | **æ¨èä½¿ç”¨** |
| **InfiniBand** | `ib` | å»¶è¿Ÿ < 1Î¼s, å¸¦å®½æœ€é«˜ | **ç”Ÿäº§ç¯å¢ƒæ¨è** |
| ä»¥å¤ªç½‘ | `ethernet` | å»¶è¿Ÿ ~10Î¼s, æ ‡å‡†å¸¦å®½ | æ—  IB ç¯å¢ƒ |
| Socket | `socket` | å»¶è¿Ÿè¾ƒé«˜, å…¼å®¹æ€§æœ€å¥½ | è°ƒè¯•å’Œæµ‹è¯• |

**ä¼˜åŒ–çº§åˆ«é…ç½®**ï¼ˆä»…é€‚ç”¨äº NVLink ç½‘ç»œåç«¯ï¼‰:

| ä¼˜åŒ–çº§åˆ« | å‚æ•°å€¼ | ç‰¹å¾ | é€‚ç”¨åœºæ™¯ | ç½‘ç»œåç«¯æ”¯æŒ |
|----------|--------|------|----------|-------------|
| **ä¿å®ˆæ¨¡å¼** | `conservative` | ç¨³å®šæ€§ä¼˜å…ˆï¼Œå…¼å®¹æ€§æœ€å¥½ | ç”Ÿäº§ç¯å¢ƒåˆæœŸéªŒè¯ | **ä»… NVLink** |
| **å¹³è¡¡æ¨¡å¼** | `balanced` | æ€§èƒ½ä¸ç¨³å®šæ€§å¹³è¡¡ | **æ¨èä½¿ç”¨** | **ä»… NVLink** |
| **æ¿€è¿›æ¨¡å¼** | `aggressive` | æ€§èƒ½ä¼˜å…ˆï¼Œæœ€å¤§åŒ–ååé‡ | é«˜æ€§èƒ½è®¡ç®—ç¯å¢ƒ | **ä»… NVLink** |

> **é‡è¦**: InfiniBandã€ä»¥å¤ªç½‘ã€PCIeã€Socket ç­‰ç½‘ç»œåç«¯ä½¿ç”¨å›ºå®šçš„ä¼˜åŒ–é…ç½®ï¼Œä¸æ”¯æŒ `--optimization-level` å‚æ•°ã€‚

**é‡è¦**:

- é»˜è®¤ä½¿ç”¨ `auto` ç½‘ç»œæ£€æµ‹ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç½‘ç»œåç«¯
- æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ä½¿ç”¨ç›¸åŒçš„ç½‘ç»œåç«¯å’Œä¼˜åŒ–çº§åˆ«é…ç½®
- æ”¯æŒ `--dry-run` æ¨¡å¼éªŒè¯é…ç½®è€Œä¸å®é™…è¿è¡Œæµ‹è¯•
- ç½‘ç»œåç«¯ä¼šä¼ é€’ç»™åº•å±‚çš„ `nccl_benchmark.sh` è„šæœ¬

### 4.3 Kubernetes å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼ˆæ¨èï¼‰

#### 4.3.1 Kubernetes æ–¹æ¡ˆæ¦‚è¿°

Kubernetes æ–¹æ¡ˆæä¾›äº†ç°ä»£åŒ–çš„å®¹å™¨ç¼–æ’å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **è‡ªåŠ¨åŒ–éƒ¨ç½²**: ä¸€é”®éƒ¨ç½²å¤šèŠ‚ç‚¹æµ‹è¯•ç¯å¢ƒ
- **èµ„æºç®¡ç†**: è‡ªåŠ¨è°ƒåº¦å’Œèµ„æºåˆ†é…
- **æ•…éšœæ¢å¤**: è‡ªåŠ¨é‡å¯å¤±è´¥çš„ Pod
- **é…ç½®ç®¡ç†**: ç»Ÿä¸€çš„é…ç½®ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶
- **ç›‘æ§é›†æˆ**: ä¸ Kubernetes ç”Ÿæ€ç³»ç»Ÿæ— ç¼é›†æˆ

#### 4.3.2 å¿«é€Ÿå¼€å§‹

**éƒ¨ç½²æµ‹è¯•ç¯å¢ƒ**ï¼š

```bash
# è¿›å…¥ Kubernetes ç›®å½•
cd k8s/

# ä¸€é”®éƒ¨ç½²å¤šèŠ‚ç‚¹æµ‹è¯•
./deploy.sh

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods -l app=nccl-test

# æŸ¥çœ‹æµ‹è¯•æ—¥å¿—
kubectl logs -l app=nccl-test -f

# æ¸…ç†èµ„æº
kubectl delete -f nccl-multinode-job.yaml
kubectl delete -f nccl-service.yaml
kubectl delete configmap nccl-config
```

#### 4.3.3 è‡ªå®šä¹‰é…ç½®

**ä¿®æ”¹æµ‹è¯•å‚æ•°**ï¼š

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim k8s/nccl-configmap.yaml

# ç¤ºä¾‹é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: nccl-config
data:
  WORLD_SIZE: "4"
  NPROC_PER_NODE: "2"
  TEST_SIZE: "100M"
  TEST_TIME: "120"
  NETWORK_TYPE: "ib"
```

**ä¿®æ”¹èŠ‚ç‚¹æ•°é‡**ï¼š

```bash
# ç¼–è¾‘ Job é…ç½®
vim k8s/nccl-multinode-job.yaml

# ä¿®æ”¹ replicas å­—æ®µ
spec:
  parallelism: 2    # å¹¶è¡Œè¿è¡Œçš„ Pod æ•°é‡
  completions: 2    # æ€»å…±éœ€è¦å®Œæˆçš„ Pod æ•°é‡
```

#### 3.3.4 é«˜çº§é…ç½®

**GPU èµ„æºé…ç½®**ï¼š

```yaml
# åœ¨ nccl-multinode-job.yaml ä¸­é…ç½®
resources:
  limits:
    nvidia.com/gpu: 2    # æ¯ä¸ª Pod ä½¿ç”¨çš„ GPU æ•°é‡
  requests:
    nvidia.com/gpu: 2
```

**ç½‘ç»œé…ç½®**ï¼š

```yaml
# ä½¿ç”¨ InfiniBand ç½‘ç»œ
spec:
  template:
    spec:
      hostNetwork: true    # ä½¿ç”¨ä¸»æœºç½‘ç»œ
      dnsPolicy: ClusterFirstWithHostNet
```

**å­˜å‚¨é…ç½®**ï¼š

```yaml
# æŒ‚è½½å…±äº«å­˜å‚¨
volumeMounts:
- name: shared-data
  mountPath: /shared
volumes:
- name: shared-data
  nfs:
    server: nfs-server.example.com
    path: /shared/nccl-data
```

#### 3.3.5 ç›‘æ§å’Œè°ƒè¯•

**æŸ¥çœ‹é›†ç¾¤çŠ¶æ€**ï¼š

```bash
# æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes -o wide

# æŸ¥çœ‹ GPU èµ„æº
kubectl describe nodes | grep nvidia.com/gpu

# æŸ¥çœ‹ç½‘ç»œæ’ä»¶çŠ¶æ€
kubectl get pods -n kube-system | grep network
```

**è°ƒè¯•æµ‹è¯•é—®é¢˜**ï¼š

```bash
# æŸ¥çœ‹ Pod è¯¦ç»†ä¿¡æ¯
kubectl describe pod <pod-name>

# è¿›å…¥ Pod è°ƒè¯•
kubectl exec -it <pod-name> -- /bin/bash

# æŸ¥çœ‹äº‹ä»¶æ—¥å¿—
kubectl get events --sort-by=.metadata.creationTimestamp
```

#### 3.3.6 æ€§èƒ½ä¼˜åŒ–

**èŠ‚ç‚¹äº²å’Œæ€§é…ç½®**ï¼š

```yaml
# ç¡®ä¿ Pod åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹
spec:
  template:
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - nccl-test
            topologyKey: kubernetes.io/hostname
```

**ä¼˜å…ˆçº§å’ŒæŠ¢å **ï¼š

```yaml
# è®¾ç½®é«˜ä¼˜å…ˆçº§
spec:
  template:
    spec:
      priorityClassName: high-priority
      tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
```

### 3.4 è„šæœ¬å‚æ•°è¯¦è§£

#### 3.4.1 å®Œæ•´å‚æ•°åˆ—è¡¨

`nccl_multinode_launcher.sh` è„šæœ¬æ”¯æŒä»¥ä¸‹å‚æ•°ï¼š

```bash
./nccl_multinode_launcher.sh <node_rank> <master_addr> [é€‰é¡¹]
```

**å¿…éœ€å‚æ•°**:

- `node_rank`: èŠ‚ç‚¹ç¼–å· (0=ä¸»èŠ‚ç‚¹, 1,2,3...=å·¥ä½œèŠ‚ç‚¹)
- `master_addr`: ä¸»èŠ‚ç‚¹ IP åœ°å€

**å¯é€‰å‚æ•°**:

| å‚æ•° | é•¿æ ¼å¼ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|--------|------|
| `-w` | `--world-size` | 4 | æ€» GPU æ•°é‡ |
| `-n` | `--nproc-per-node` | 2 | æ¯èŠ‚ç‚¹ GPU æ•° |
| `-p` | `--master-port` | 29500 | ä¸»èŠ‚ç‚¹é€šä¿¡ç«¯å£ |
| `--network` | `--network` | ib | ç½‘ç»œåç«¯ (ib/ethernet/socket) |
| `-s` | `--size` | 50M | æµ‹è¯•æ•°æ®å¤§å° |
| `-t` | `--time` | 90 | æµ‹è¯•æ—¶é•¿ (ç§’) |
| `-h` | `--help` | - | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ |

#### 3.4.2 å‚æ•°ä½¿ç”¨ç¤ºä¾‹

```bash
# æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
./nccl_multinode_launcher.sh --help

# åŸºç¡€æµ‹è¯• (ä½¿ç”¨é»˜è®¤å‚æ•°)
./nccl_multinode_launcher.sh 0 192.168.1.100

# å®Œæ•´å‚æ•°é…ç½®
./nccl_multinode_launcher.sh 0 192.168.1.100 \
  --world-size 8 \
  --nproc-per-node 2 \
  --master-port 29500 \
  --network ib \
  --size 100M \
  --time 120

# ä»¥å¤ªç½‘ç¯å¢ƒæµ‹è¯•
./nccl_multinode_launcher.sh 0 192.168.1.100 \
  -w 4 -n 2 --network ethernet

# è°ƒè¯•æ¨¡å¼ (Socket ç½‘ç»œ)
./nccl_multinode_launcher.sh 0 192.168.1.100 \
  -w 2 -n 1 --network socket -s 10M -t 30
```

#### 3.4.3 å‚æ•°éªŒè¯è§„åˆ™

è„šæœ¬ä¼šè‡ªåŠ¨éªŒè¯å‚æ•°çš„æœ‰æ•ˆæ€§ï¼š

- `node_rank` å¿…é¡»æ˜¯éè´Ÿæ•´æ•°ä¸”å°äºæ€»èŠ‚ç‚¹æ•°
- `world_size` å¿…é¡»æ˜¯å¤§äºç­‰äº 2 çš„æ•´æ•°
- `nproc_per_node` å¿…é¡»æ˜¯æ­£æ•´æ•°
- `world_size` å¿…é¡»èƒ½è¢« `nproc_per_node` æ•´é™¤
- `master_port` å¿…é¡»æ˜¯æœ‰æ•ˆçš„ç«¯å£å·
- `network` å¿…é¡»æ˜¯æ”¯æŒçš„ç½‘ç»œç±»å‹

### 3.5 æµ‹è¯•æ­¥éª¤

#### 3.5.1 ç¯å¢ƒå‡†å¤‡

- âœ… ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹ç½‘ç»œè¿é€š
- âœ… åŒæ­¥æ‰€æœ‰èŠ‚ç‚¹æ—¶é—´
- âœ… å¼€æ”¾é˜²ç«å¢™ç«¯å£ (29500)
- âœ… éªŒè¯GPUå’ŒNCCLç¯å¢ƒ

#### 3.5.2 å¯åŠ¨æµ‹è¯•

1. **å…ˆå¯åŠ¨ä¸»èŠ‚ç‚¹** (node_rank=0)
2. **å†å¯åŠ¨å·¥ä½œèŠ‚ç‚¹** (node_rank=1,2,3...)
3. **ä½¿ç”¨ç›¸åŒå‚æ•°** åœ¨æ‰€æœ‰èŠ‚ç‚¹

#### 3.5.3 ç›‘æ§æµ‹è¯•

```bash
# ç›‘æ§ç½‘ç»œæµé‡
watch -n 1 'ibstat | grep -A 5 "Port 1"'

# ç›‘æ§GPUä½¿ç”¨
watch -n 1 nvidia-smi
```

### 3.6 å¸¸ç”¨é…ç½®

| åœºæ™¯ | èŠ‚ç‚¹æ•° | GPUæ•° | ç½‘ç»œç±»å‹ | å‘½ä»¤ç¤ºä¾‹ |
|------|--------|-------|----------|----------|
| å°è§„æ¨¡éªŒè¯ | 2 | 4 | IB (é»˜è®¤) | `./nccl_multinode_launcher.sh 0 192.168.1.100 -w 4 -n 2` |
| ä¸­ç­‰è§„æ¨¡ | 4 | 8 | IB | `./nccl_multinode_launcher.sh 0 192.168.1.100 -w 8 -n 2 -s 100M --network ib` |
| å¤§è§„æ¨¡æµ‹è¯• | 8 | 16 | IB | `./nccl_multinode_launcher.sh 0 192.168.1.100 -w 16 -n 2 -s 500M -t 300 --network ib` |
| ä»¥å¤ªç½‘ç¯å¢ƒ | 2 | 4 | Ethernet | `./nccl_multinode_launcher.sh 0 192.168.1.100 -w 4 -n 2 --network ethernet` |
| è°ƒè¯•æµ‹è¯• | 2 | 2 | Socket | `./nccl_multinode_launcher.sh 0 192.168.1.100 -w 2 -n 1 --network socket` |

**å‚æ•°è¯´æ˜**:

- `-w, --world-size`: æ€» GPU æ•°é‡
- `-n, --nproc-per-node`: æ¯èŠ‚ç‚¹ GPU æ•°
- `-s, --size`: æµ‹è¯•æ•°æ®å¤§å° (å¦‚ 10M, 100M, 1G)
- `-t, --time`: æµ‹è¯•æ—¶é•¿ (ç§’)
- `--network`: ç½‘ç»œåç«¯ç±»å‹ (ib/ethernet/socket)

### 3.7 ç½‘ç»œé…ç½®è¦æ±‚

#### 3.7.1 IP over InfiniBand (IPoIB) åœ°å€è¦æ±‚

**é‡è¦**: å½“ä½¿ç”¨ IPoIB æ—¶ï¼ŒæŒ‡å®šçš„ IP åœ°å€**å¿…é¡»æ˜¯ InfiniBand ç½‘å¡ä¸Šé…ç½®çš„åœ°å€**ï¼Œè€Œéä»¥å¤ªç½‘ç½‘å¡åœ°å€ã€‚

```bash
# 1. æŸ¥çœ‹ IB ç½‘å¡æ¥å£
ip addr show | grep ib

# å…¸å‹è¾“å‡ºç¤ºä¾‹ï¼š
# ib0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 2044 qdisc mq state UP group default qlen 256
#     inet 192.168.1.100/24 brd 192.168.1.255 scope global ib0

# 2. éªŒè¯ IB æ¥å£çŠ¶æ€
ibstat ib0

# 3. æ£€æŸ¥ IPoIB æ¨¡å—åŠ è½½
lsmod | grep ib_ipoib
```

#### 3.7.2 ç½‘ç»œæ¥å£é…ç½®ç¤ºä¾‹

```bash
# é…ç½® IPoIB æ¥å£ (Ubuntu/Debian)
sudo ip addr add 192.168.1.100/24 dev ib0
sudo ip link set ib0 up

# é…ç½® IPoIB æ¥å£ (CentOS/RHEL)
# ç¼–è¾‘ /etc/sysconfig/network-scripts/ifcfg-ib0
cat > /etc/sysconfig/network-scripts/ifcfg-ib0 << EOF
DEVICE=ib0
BOOTPROTO=static
IPADDR=192.168.1.100
NETMASK=255.255.255.0
ONBOOT=yes
TYPE=InfiniBand
CONNECTED_MODE=yes
EOF

# é‡å¯ç½‘ç»œæœåŠ¡
sudo systemctl restart network
```

#### 3.7.3 åœ°å€ç±»å‹å¯¹æ¯”

| ç½‘ç»œç±»å‹ | æ¥å£åç§° | åœ°å€ç¤ºä¾‹ | MTU | ç”¨é€” |
|----------|----------|----------|-----|------|
| ä»¥å¤ªç½‘ | eth0, ens33 | 192.168.1.100 | 1500 | ç®¡ç†ç½‘ç»œ |
| IPoIB | ib0, ib1 | 192.168.1.100 | 2044/65520 | é«˜æ€§èƒ½æ•°æ®ä¼ è¾“ |
| RoCE | eth0 (IBåŠŸèƒ½) | 192.168.1.100 | 1500 | ä»¥å¤ªç½‘ä¸Šçš„IB |

#### 3.7.4 ç½‘ç»œéªŒè¯å‘½ä»¤

```bash
# éªŒè¯ IB æ¥å£é…ç½®
ip addr show ib0

# æ£€æŸ¥ IB è®¾å¤‡çŠ¶æ€
ibstat

# æµ‹è¯• IPoIB è¿é€šæ€§
ping -I ib0 192.168.1.101

# éªŒè¯ IB é“¾è·¯çŠ¶æ€
ibstatus
```

#### 3.7.5 IPoIB ä¸åŸç”Ÿ IB çš„å…±å­˜

**é‡è¦æ¦‚å¿µ**: IPoIB å’ŒåŸç”Ÿ InfiniBand å¯ä»¥åœ¨åŒä¸€ç¡¬ä»¶ä¸Šå…±å­˜ï¼ŒNCCL ä¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜é€šä¿¡æ–¹å¼ã€‚

##### 3.7.5.1 å…±å­˜æœºåˆ¶åŸç†

```bash
# åŒä¸€ä¸ª IB è®¾å¤‡çš„åŒé‡èº«ä»½
# 1. åŸç”Ÿ IB è®¾å¤‡ (ç”¨äº RDMA/Verbs)
ibv_devinfo mlx5_0

# 2. IPoIB ç½‘ç»œæ¥å£ (ç”¨äº TCP/IP)
ip addr show ib0

# ä¸¤è€…ä½¿ç”¨ç›¸åŒçš„ç‰©ç†ç¡¬ä»¶ï¼Œä½†åè®®æ ˆä¸åŒ
```

##### 3.7.5.2 NCCL ç½‘ç»œé€‰æ‹©ä¼˜å…ˆçº§

NCCL æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§è‡ªåŠ¨é€‰æ‹©é€šä¿¡æ–¹å¼ï¼š

| ä¼˜å…ˆçº§ | é€šä¿¡æ–¹å¼ | æ€§èƒ½ç‰¹å¾ | ä½¿ç”¨åœºæ™¯ |
|--------|----------|----------|----------|
| **1 (æœ€é«˜)** | **åŸç”Ÿ IB Verbs** | å»¶è¿Ÿ < 1Î¼s, é›¶æ‹·è´ | **æ¨èç”¨äº NCCL** |
| 2 | IPoIB (Connected Mode) | å»¶è¿Ÿ ~2Î¼s, é«˜å¸¦å®½ | å…¼å®¹æ€§è¦æ±‚é«˜æ—¶ |
| 3 | IPoIB (Datagram Mode) | å»¶è¿Ÿ ~5Î¼s, ä¸­ç­‰å¸¦å®½ | ç½‘ç»œé…ç½®ç®€å•æ—¶ |
| 4 (æœ€ä½) | ä»¥å¤ªç½‘ TCP | å»¶è¿Ÿ ~10Î¼s, æ ‡å‡†å¸¦å®½ | å›é€€é€‰é¡¹ |

##### 3.7.5.3 å¼ºåˆ¶ä½¿ç”¨åŸç”Ÿ IB çš„é…ç½®

```bash
# æ–¹æ³•1: é€šè¿‡ç¯å¢ƒå˜é‡å¼ºåˆ¶ä½¿ç”¨åŸç”Ÿ IB
export NCCL_IB_DISABLE=0          # å¯ç”¨ IB æ”¯æŒ
export NCCL_NET_GDR_LEVEL=2       # å¯ç”¨ GPUDirect RDMA
export NCCL_IB_HCA=mlx5_0          # æŒ‡å®š IB è®¾å¤‡
export NCCL_SOCKET_IFNAME=""       # ç¦ç”¨ Socket æ¥å£

# æ–¹æ³•2: é€šè¿‡è„šæœ¬å‚æ•°å’Œç¯å¢ƒå˜é‡ç»„åˆ
./nccl_benchmark.sh --network ib -s 100M

# éªŒè¯ NCCL ä½¿ç”¨çš„ç½‘ç»œç±»å‹
export NCCL_DEBUG=INFO
# æŸ¥çœ‹æ—¥å¿—ä¸­çš„ "NET/" ä¿¡æ¯ç¡®è®¤ä½¿ç”¨åŸç”Ÿ IB
```

##### 3.7.5.4 ç½‘ç»œç±»å‹éªŒè¯æ–¹æ³•

```bash
# è¿è¡Œæµ‹è¯•å¹¶æ£€æŸ¥ç½‘ç»œé€‰æ‹©
./nccl_benchmark.sh -s 10M 2>&1 | grep -E "NET/|Using|Selected"

# æœŸæœ›çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# [nccl] INFO NET/IB : Using [0]mlx5_0:1/IB [RO]; OOB ib0:192.168.1.100<->192.168.1.101
# è¿™è¡¨æ˜ä½¿ç”¨äº†åŸç”Ÿ IB (NET/IB) è€Œé TCP (NET/Socket)
```

##### 3.7.5.5 æ€§èƒ½å¯¹æ¯”æµ‹è¯•

```bash
# æµ‹è¯•1:# å¼ºåˆ¶ä½¿ç”¨åŸç”Ÿ IB
export NCCL_SOCKET_IFNAME=""
./nccl_benchmark.sh -s 100M -t 60

# æµ‹è¯•2: å¼ºåˆ¶ä½¿ç”¨ IPoIB (TCP)
export NCCL_IB_DISABLE=1
export NCCL_SOCKET_IFNAME=ib0
./nccl_benchmark.sh -s 100M -t 60

# æ¯”è¾ƒä¸¤æ¬¡æµ‹è¯•çš„å»¶è¿Ÿå’Œå¸¦å®½å·®å¼‚
```

##### 3.7.5.6 æœ€ä½³å®è·µå»ºè®®

1. **é»˜è®¤é…ç½®**: è®© NCCL è‡ªåŠ¨é€‰æ‹©ï¼Œé€šå¸¸ä¼šé€‰æ‹©åŸç”Ÿ IB
2. **æ€§èƒ½ä¼˜å…ˆ**: æ˜ç¡®é…ç½®ä½¿ç”¨åŸç”Ÿ IB Verbs
3. **å…¼å®¹æ€§ä¼˜å…ˆ**: åœ¨ç½‘ç»œé…ç½®å¤æ‚æ—¶å¯è€ƒè™‘ IPoIB
4. **ç›‘æ§éªŒè¯**: é€šè¿‡æ—¥å¿—ç¡®è®¤å®é™…ä½¿ç”¨çš„ç½‘ç»œç±»å‹

```bash
# æ¨èçš„ç”Ÿäº§ç¯å¢ƒé…ç½®
export NCCL_IB_DISABLE=0          # å¯ç”¨åŸç”Ÿ IB
export NCCL_NET_GDR_LEVEL=2       # å¯ç”¨ GPUDirect
export NCCL_IB_HCA=mlx5_0          # æŒ‡å®šè®¾å¤‡
export NCCL_DEBUG=INFO             # å¯ç”¨æ—¥å¿—éªŒè¯
```

### 3.8 å¤šèŠ‚ç‚¹æ•…éšœæ’é™¤

#### 3.8.1 ä½¿ç”¨ nccl_benchmark.sh è¿›è¡Œæ•…éšœè¯Šæ–­

**Dry-run æ¨¡å¼éªŒè¯é…ç½®**ï¼š

```bash
# éªŒè¯å¤šèŠ‚ç‚¹é…ç½®è€Œä¸å®é™…è¿è¡Œæµ‹è¯•
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --dry-run

# éªŒè¯ç‰¹å®šç½‘ç»œåç«¯é…ç½®
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ib --dry-run
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ethernet --dry-run

# éªŒè¯ä¼˜åŒ–çº§åˆ«é…ç½®ï¼ˆä»…åœ¨å•èŠ‚ç‚¹ NVLink ç¯å¢ƒä¸‹æœ‰æ•ˆï¼‰
./nccl_benchmark.sh --network nvlink --optimization-level aggressive --dry-run
```

**è‡ªåŠ¨ç½‘ç»œæ£€æµ‹è¯Šæ–­**ï¼š

```bash
# ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹æ¨¡å¼æŸ¥çœ‹ç½‘ç»œé€‰æ‹©è¿‡ç¨‹
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network auto

# å¯ç”¨è¯¦ç»†æ—¥å¿—è¿›è¡Œè¯Šæ–­
NCCL_DEBUG=INFO ./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network auto
```

#### 3.8.2 è¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ (ä½¿ç”¨æ­£ç¡®çš„æ¥å£)
ping -I ib0 192.168.1.100

# æ£€æŸ¥ç«¯å£å¼€æ”¾
telnet 192.168.1.100 29500

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status

# éªŒè¯ IB è®¾å¤‡çŠ¶æ€
ibstat
ibv_devinfo

# ä½¿ç”¨ nccl_benchmark.sh éªŒè¯ç½‘ç»œé…ç½®
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ib --dry-run
```

#### 3.8.3 æ€§èƒ½é—®é¢˜

```bash
# æ£€æŸ¥ç½‘ç»œç±»å‹
grep "NET/" /tmp/nccl_test_output.log

# æ£€æŸ¥GPUåˆ©ç”¨ç‡
nvidia-smi

# æ£€æŸ¥IBçŠ¶æ€
ibstat

# ä½¿ç”¨ä¸åŒä¼˜åŒ–çº§åˆ«è¿›è¡Œæ€§èƒ½å¯¹æ¯”ï¼ˆä»…é€‚ç”¨äºå•èŠ‚ç‚¹ NVLink ç¯å¢ƒï¼‰
# æ³¨æ„ï¼šå¤šèŠ‚ç‚¹ç¯å¢ƒä¸‹ï¼Œè¿™äº›å‚æ•°ä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºå¤šèŠ‚ç‚¹é€šä¿¡ä¸ä½¿ç”¨ NVLink
./nccl_benchmark.sh --network nvlink --optimization-level conservative  # å•èŠ‚ç‚¹ NVLink æµ‹è¯•
./nccl_benchmark.sh --network nvlink --optimization-level balanced     # å•èŠ‚ç‚¹ NVLink æµ‹è¯•
./nccl_benchmark.sh --network nvlink --optimization-level aggressive   # å•èŠ‚ç‚¹ NVLink æµ‹è¯•

# æ£€æŸ¥ç»Ÿä¸€é…ç½®ç®¡ç†å™¨çš„é…ç½®åº”ç”¨
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network auto -q
```

#### 3.8.4 å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

**ç½‘ç»œåç«¯å†²çª**ï¼š

```bash
# é”™è¯¯: å¤šèŠ‚ç‚¹æ¨¡å¼ä½¿ç”¨å•èŠ‚ç‚¹ä¸“ç”¨ç½‘ç»œ
[ERROR] NVLink ä»…æ”¯æŒå•èŠ‚ç‚¹å¤šGPUæ¨¡å¼ï¼Œä¸æ”¯æŒå¤šèŠ‚ç‚¹
[ERROR] PCIe P2P ä»…æ”¯æŒå•èŠ‚ç‚¹å¤šGPUæ¨¡å¼ï¼Œä¸æ”¯æŒå¤šèŠ‚ç‚¹

# è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨å¤šèŠ‚ç‚¹å…¼å®¹çš„ç½‘ç»œåç«¯
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ib
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ethernet
```

**é…ç½®éªŒè¯å¤±è´¥**ï¼š

```bash
# é”™è¯¯: å‚æ•°éªŒè¯å¤±è´¥
[ERROR] å¤šèŠ‚ç‚¹æ¨¡å¼éœ€è¦æŒ‡å®š --master-addr å‚æ•°

# è§£å†³æ–¹æ¡ˆ: ç¡®ä¿æä¾›å¿…è¦å‚æ•°
./nccl_benchmark.sh -m --master-addr 192.168.1.100

# éªŒè¯æ‰€æœ‰å‚æ•°
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --dry-run
```

### 3.9 æ€§èƒ½åŸºå‡†

#### 3.9.1 InfiniBand (100Gbps / 12.5 GB/s)

- 2èŠ‚ç‚¹4GPU: 10-11.25 GB/s (80-90 Gbps)
- 4èŠ‚ç‚¹8GPU: 8.75-10.6 GB/s (70-85 Gbps)
- 8èŠ‚ç‚¹16GPU: 7.5-10 GB/s (60-80 Gbps)

#### 3.9.2 ä»¥å¤ªç½‘ (25Gbps / 3.125 GB/s)

- 2èŠ‚ç‚¹4GPU: 2.5-2.9 GB/s (20-23 Gbps)
- 4èŠ‚ç‚¹8GPU: 2.25-2.75 GB/s (18-22 Gbps)
- 8èŠ‚ç‚¹16GPU: 1.9-2.5 GB/s (15-20 Gbps)

### 3.10 ç›¸å…³æ–‡ä»¶

- `nccl_benchmark.sh` - ä¸»æµ‹è¯•è„šæœ¬
- `nccl_multinode_launcher.sh` - å¤šèŠ‚ç‚¹å¯åŠ¨è„šæœ¬
- `/tmp/nccl_test_output.log` - æµ‹è¯•è¾“å‡ºæ—¥å¿—

### 3.11 å¤šèŠ‚ç‚¹æœ€ä½³å®è·µ

#### 3.11.1 åŸºäº nccl_benchmark.sh çš„æœ€ä½³å®è·µ

**1. é…ç½®éªŒè¯ä¼˜å…ˆ**ï¼š

```bash
# åœ¨å®é™…æµ‹è¯•å‰ï¼Œå…ˆä½¿ç”¨ dry-run æ¨¡å¼éªŒè¯é…ç½®
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --dry-run

# éªŒè¯ä¸åŒç½‘ç»œåç«¯çš„é…ç½®
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network auto --dry-run
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ib --dry-run
```

**2. æ¸è¿›å¼æµ‹è¯•ç­–ç•¥**ï¼š

```bash
# æ­¥éª¤1: å•èŠ‚ç‚¹æµ‹è¯•éªŒè¯ç¯å¢ƒ
./nccl_benchmark.sh --network auto

# æ­¥éª¤2: ä¿å®ˆæ¨¡å¼å•èŠ‚ç‚¹ NVLink æµ‹è¯•
./nccl_benchmark.sh --network nvlink --optimization-level conservative

# æ­¥éª¤3: å¹³è¡¡æ¨¡å¼å•èŠ‚ç‚¹ NVLink æµ‹è¯•
./nccl_benchmark.sh --network nvlink --optimization-level balanced

# æ­¥éª¤4: æ¿€è¿›æ¨¡å¼å•èŠ‚ç‚¹ NVLink æµ‹è¯•
./nccl_benchmark.sh --network nvlink --optimization-level aggressive

# æ­¥éª¤5: å¤šèŠ‚ç‚¹æµ‹è¯•ï¼ˆä¼˜åŒ–çº§åˆ«å‚æ•°ä¸é€‚ç”¨ï¼‰
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network auto
```

**3. è‡ªåŠ¨åŒ–é…ç½®ç®¡ç†**ï¼š

```bash
# åˆ©ç”¨ç»Ÿä¸€é…ç½®ç®¡ç†å™¨è‡ªåŠ¨ä¼˜åŒ–ï¼ˆå¤šèŠ‚ç‚¹ç¯å¢ƒï¼‰
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network auto

# é™é»˜æ¨¡å¼å‡å°‘æ—¥å¿—è¾“å‡º
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network auto -q
```

#### 3.11.2 ä¼ ç»Ÿæœ€ä½³å®è·µ

1. **æµ‹è¯•å‰**: å…ˆè¿è¡Œå•èŠ‚ç‚¹æµ‹è¯•éªŒè¯ç¯å¢ƒ
2. **å¯åŠ¨é¡ºåº**: ä¸»èŠ‚ç‚¹ â†’ å·¥ä½œèŠ‚ç‚¹ (é—´éš”10-15ç§’)
3. **å‚æ•°ä¸€è‡´**: æ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å‚æ•°
4. **ç›‘æ§**: åŒæ—¶ç›‘æ§ç½‘ç»œå’ŒGPUä½¿ç”¨æƒ…å†µ
5. **æ—¥å¿—**: ä¿å­˜æ‰€æœ‰èŠ‚ç‚¹çš„æµ‹è¯•æ—¥å¿—ç”¨äºåˆ†æ

#### 3.11.3 é«˜çº§ä¼˜åŒ–å»ºè®®

**ç½‘ç»œåç«¯é€‰æ‹©ç­–ç•¥**ï¼š

```bash
# ç”Ÿäº§ç¯å¢ƒæ¨è: è‡ªåŠ¨æ£€æµ‹ï¼ˆå¤šèŠ‚ç‚¹ï¼‰
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network auto

# é«˜æ€§èƒ½è®¡ç®—ç¯å¢ƒ: å¼ºåˆ¶ IBï¼ˆå¤šèŠ‚ç‚¹ï¼‰
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ib

# å…¼å®¹æ€§ä¼˜å…ˆ: ä»¥å¤ªç½‘ï¼ˆå¤šèŠ‚ç‚¹ï¼‰
./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network ethernet

# å•èŠ‚ç‚¹ NVLink ä¼˜åŒ–çº§åˆ«æµ‹è¯•
./nccl_benchmark.sh --network nvlink --optimization-level aggressive  # ä»…å•èŠ‚ç‚¹æœ‰æ•ˆ
```

**æ€§èƒ½åŸºå‡†å»ºç«‹**ï¼š

```bash
# å»ºç«‹ä¸åŒé…ç½®çš„æ€§èƒ½åŸºå‡†ï¼ˆå•èŠ‚ç‚¹ NVLink ç¯å¢ƒï¼‰
for opt_level in conservative balanced aggressive; do
    echo "æµ‹è¯• NVLink ä¼˜åŒ–çº§åˆ«: $opt_level"
    ./nccl_benchmark.sh --network nvlink --optimization-level $opt_level -s 100M -t 60
done

# å¤šèŠ‚ç‚¹ç½‘ç»œåç«¯æ€§èƒ½åŸºå‡†
for network in auto ib ethernet; do
    echo "æµ‹è¯•å¤šèŠ‚ç‚¹ç½‘ç»œåç«¯: $network"
    ./nccl_benchmark.sh -m --master-addr 192.168.1.100 --network $network -s 100M -t 60
done
```

---

## 5. å…³é”®æŠ€æœ¯è¯´æ˜

### 5.1 NCCL AllReduce ç®—æ³•åŸç†

#### 5.1.1 Ring AllReduce ç®—æ³•

NCCL é»˜è®¤ä½¿ç”¨ Ring AllReduce ç®—æ³•ï¼Œè¯¥ç®—æ³•å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

```python
# Ring AllReduce ç®—æ³•ä¼ªä»£ç 
def ring_allreduce(data, rank, world_size):
    """
    Ring AllReduce ç®—æ³•å®ç°
    
    å‚æ•°:
        data: æœ¬åœ°æ•°æ®å¼ é‡
        rank: å½“å‰è¿›ç¨‹çš„æ’å (0 åˆ° world_size-1)
        world_size: æ€»è¿›ç¨‹æ•°
    
    ç®—æ³•æ­¥éª¤:
        1. Reduce-Scatter é˜¶æ®µ: å°†æ•°æ®åˆ†å—ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€ä¸ªå—çš„å½’çº¦
        2. AllGather é˜¶æ®µ: å°†å½’çº¦ç»“æœå¹¿æ’­åˆ°æ‰€æœ‰èŠ‚ç‚¹
    """
    
    # ç¬¬ä¸€é˜¶æ®µ: Reduce-Scatter
    # æ¯ä¸ªèŠ‚ç‚¹å°†å…¶æ•°æ®å—å‘é€ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¥æ”¶ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å—
    for step in range(world_size - 1):
        send_rank = (rank + 1) % world_size
        recv_rank = (rank - 1 + world_size) % world_size
        
        # å‘é€æ•°æ®å—åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ¥æ”¶æ•°æ®å—
        # å¹¶è¿›è¡Œå½’çº¦æ“ä½œ (æ±‚å’Œ)
        
    # ç¬¬äºŒé˜¶æ®µ: AllGather  
    # å°†å½’çº¦åçš„æ•°æ®å—å¹¿æ’­åˆ°æ‰€æœ‰èŠ‚ç‚¹
    for step in range(world_size - 1):
        send_rank = (rank + 1) % world_size
        recv_rank = (rank - 1 + world_size) % world_size
        
        # å‘é€å®Œæ•´çš„æ•°æ®å—åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
```

**ç®—æ³•å¤æ‚åº¦åˆ†æ**:

- **é€šä¿¡å¤æ‚åº¦**: O(N) å…¶ä¸­ N æ˜¯æ•°æ®å¤§å°
- **æ—¶é—´å¤æ‚åº¦**: 2 Ã— (N-1)/N Ã— (æ•°æ®ä¼ è¾“æ—¶é—´)
- **å¸¦å®½åˆ©ç”¨ç‡**: æ¥è¿‘ 100% (ç†è®ºæœ€ä¼˜)

#### 5.1.2 ç†è®ºä¼ è¾“é‡è®¡ç®—

```python
def calculate_theoretical_transfer(data_size_mb, world_size):
    """
    è®¡ç®— Ring AllReduce çš„ç†è®ºä¼ è¾“é‡
    
    å…¬å¼: 2 Ã— (N-1)/N Ã— data_size
    
    è§£é‡Š:
        - ç¬¬ä¸€ä¸ª (N-1)/N: Reduce-Scatter é˜¶æ®µçš„ä¼ è¾“æ¯”ä¾‹
        - ç¬¬äºŒä¸ª (N-1)/N: AllGather é˜¶æ®µçš„ä¼ è¾“æ¯”ä¾‹  
        - ç³»æ•° 2: ä¸¤ä¸ªé˜¶æ®µçš„æ€»å’Œ
    """
    transfer_ratio = 2 * (world_size - 1) / world_size
    theoretical_transfer_mb = transfer_ratio * data_size_mb
    
    return theoretical_transfer_mb

# ç¤ºä¾‹è®¡ç®—
# 4ä¸ªGPUï¼Œ100MBæ•°æ®: 2 Ã— (4-1)/4 Ã— 100 = 150MB ç†è®ºä¼ è¾“é‡
```

### 5.2 GPUDirect RDMA æŠ€æœ¯åŸç†

#### 5.2.1 ä¼ ç»Ÿæ•°æ®è·¯å¾„ vs GPUDirect RDMA

```bash
# ä¼ ç»Ÿæ•°æ®è·¯å¾„ (æ—  GPUDirect RDMA)
GPU1 Memory â†’ CPU Memory â†’ Network â†’ CPU Memory â†’ GPU2 Memory
#           â†‘ PCIe      â†‘ System Bus  â†‘ System Bus â†‘ PCIe
#           4æ¬¡å†…å­˜æ‹·è´ï¼Œé«˜å»¶è¿Ÿ

# GPUDirect RDMA æ•°æ®è·¯å¾„  
GPU1 Memory â†’ Network â†’ GPU2 Memory
#           â†‘ ç›´æ¥è¿æ¥ï¼Œé›¶æ‹·è´ï¼Œä½å»¶è¿Ÿ
```

#### 5.2.2 NCCL ç¯å¢ƒå˜é‡æŠ€æœ¯ç»†èŠ‚

```bash
# å…³é”®ç¯å¢ƒå˜é‡åŠå…¶æŠ€æœ¯å«ä¹‰

# 1. å¯ç”¨ InfiniBand æ”¯æŒ
export NCCL_IB_DISABLE=0
# æŠ€æœ¯è¯´æ˜: 
#   - 0: å¯ç”¨ IB ä¼ è¾“
#   - 1: ç¦ç”¨ IBï¼Œå›é€€åˆ° Socket/Ethernet
#   - å½±å“: ç›´æ¥å†³å®šæ˜¯å¦ä½¿ç”¨é«˜æ€§èƒ½ IB ç½‘ç»œ

# 2. GPUDirect RDMA çº§åˆ«æ§åˆ¶
export NCCL_NET_GDR_LEVEL=2  
# æŠ€æœ¯è¯´æ˜:
#   - 0: ç¦ç”¨ GPUDirect RDMA
#   - 1: å¯ç”¨ GPUDirect RDMA (è¯»å–)
#   - 2: å¯ç”¨ GPUDirect RDMA (è¯»å–+å†™å…¥) - æœ€é«˜æ€§èƒ½
#   - å½±å“: æ§åˆ¶ GPU å†…å­˜ä¸ç½‘ç»œçš„ç›´æ¥è®¿é—®ç¨‹åº¦

# 3. HCA è®¾å¤‡é€‰æ‹©
export NCCL_IB_HCA=mlx5_0
# æŠ€æœ¯è¯´æ˜:
#   - æŒ‡å®šä½¿ç”¨çš„ InfiniBand ç½‘å¡è®¾å¤‡
#   - å¤šç½‘å¡ç¯å¢ƒä¸‹çš„è´Ÿè½½å‡è¡¡å’Œæ€§èƒ½ä¼˜åŒ–
#   - æ ¼å¼: è®¾å¤‡åç§° (é€šè¿‡ ibstat -l è·å–)

# 4. GID ç´¢å¼•é…ç½® (å…³é”®æ€§èƒ½å‚æ•°)
export NCCL_IB_GID_INDEX=0    # åŸç”Ÿ IB
export NCCL_IB_GID_INDEX=3    # RoCE v2
# æŠ€æœ¯è¯´æ˜:
#   - GID (Global Identifier): IB ç½‘ç»œä¸­çš„å…¨å±€æ ‡è¯†ç¬¦
#   - ä¸åŒ GID ç´¢å¼•å¯¹åº”ä¸åŒçš„ç½‘ç»œåè®®æ ˆ
#   - é”™è¯¯é…ç½®ä¼šå¯¼è‡´è¿æ¥å¤±è´¥æˆ–æ€§èƒ½ä¸‹é™

# 5. æµæ§åˆ¶å‚æ•°
export NCCL_IB_TC=136         # Traffic Class
export NCCL_IB_SL=0           # Service Level  
# æŠ€æœ¯è¯´æ˜:
#   - TC: æµé‡åˆ†ç±»ï¼Œç”¨äº QoS æ§åˆ¶
#   - SL: æœåŠ¡çº§åˆ«ï¼Œå½±å“æ•°æ®åŒ…ä¼˜å…ˆçº§
#   - 136: å¸¸ç”¨çš„é«˜ä¼˜å…ˆçº§ TC å€¼

# 6. è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
export NCCL_IB_TIMEOUT=22     # è¶…æ—¶æ—¶é—´ (å¯¹æ•°åˆ»åº¦)
export NCCL_IB_RETRY_CNT=7    # é‡è¯•æ¬¡æ•°
# æŠ€æœ¯è¯´æ˜:
#   - TIMEOUT: 2^22 å¾®ç§’ â‰ˆ 4.2 ç§’
#   - ç½‘ç»œä¸ç¨³å®šæ—¶çš„å®¹é”™æœºåˆ¶
#   - è¿‡å°å€¼å¯èƒ½å¯¼è‡´è¯¯æŠ¥ï¼Œè¿‡å¤§å€¼å½±å“æ•…éšœæ£€æµ‹
```

### 5.3 ç½‘ç»œç±»å‹è‡ªåŠ¨æ£€æµ‹æœºåˆ¶

#### 5.3.1 æ£€æµ‹ç®—æ³•å®ç°

```bash
# è„šæœ¬ä¸­çš„ç½‘ç»œç±»å‹æ£€æµ‹é€»è¾‘
detect_network_type() {
    local is_roce=false
    local network_type="æœªçŸ¥"
    
    # ä½¿ç”¨ ibv_devinfo æ£€æµ‹é“¾è·¯å±‚ç±»å‹
    if command -v ibv_devinfo >/dev/null 2>&1; then
        # è·å–ç¬¬ä¸€ä¸ªè®¾å¤‡çš„é“¾è·¯å±‚ä¿¡æ¯
        local link_layer=$(ibv_devinfo | grep "link_layer:" | head -1 | awk '{print $2}')
        
        case "$link_layer" in
            "Ethernet")
                is_roce=true
                network_type="RoCE (Ethernet over IB)"
                # RoCE ç‰¹å®šé…ç½®
                configure_roce_parameters
                ;;
            "InfiniBand") 
                network_type="åŸç”Ÿ InfiniBand"
                # åŸç”Ÿ IB ç‰¹å®šé…ç½®
                configure_native_ib_parameters
                ;;
            *)
                network_type="æœªçŸ¥ç±»å‹: $link_layer"
                # ä½¿ç”¨ä¿å®ˆçš„é»˜è®¤é…ç½®
                configure_default_parameters
                ;;
        esac
    fi
    
    echo "æ£€æµ‹åˆ°ç½‘ç»œç±»å‹: $network_type"
}
```

#### 5.3.2 é…ç½®å·®å¼‚å¯¹æ¯”

| å‚æ•° | åŸç”Ÿ InfiniBand | RoCE v2 | æŠ€æœ¯è¯´æ˜ |
|------|----------------|---------|----------|
| `NCCL_IB_GID_INDEX` | 0 | 3 | GID ç´¢å¼•é€‰æ‹©ä¸åŒçš„åè®®æ ˆ |
| `NCCL_SOCKET_IFNAME` | æœªè®¾ç½® | `""` | RoCE éœ€ç¦ç”¨ Socket æ¥å£é¿å…å†²çª |
| ç½‘ç»œå±‚ | IB Verbs | Ethernet + IB Verbs | åº•å±‚ä¼ è¾“åè®®ä¸åŒ |
| æ€§èƒ½ç‰¹å¾ | è¶…ä½å»¶è¿Ÿ | è¾ƒä½å»¶è¿Ÿï¼Œæ›´å¥½å…¼å®¹æ€§ | ç¡¬ä»¶å’Œåè®®æ ˆå·®å¼‚ |

### 5.4 æ€§èƒ½æµ‹è¯•æ ¸å¿ƒä»£ç è§£æ

#### 5.4.1 åŠ¨æ€å¼ é‡å¤§å°è®¡ç®—

```python
# è„šæœ¬ç”Ÿæˆçš„ Python æµ‹è¯•ä»£ç å…³é”®éƒ¨åˆ†
def calculate_tensor_size(test_size_str):
    """
    æ ¹æ®ç”¨æˆ·è¾“å…¥è®¡ç®—å¼ é‡å…ƒç´ æ•°é‡
    
    æŠ€æœ¯ç»†èŠ‚:
        - float32 å¼ é‡: æ¯ä¸ªå…ƒç´  4 å­—èŠ‚
        - å†…å­˜å¯¹é½: GPU å†…å­˜åˆ†é…éœ€è¦è€ƒè™‘å¯¹é½è¦æ±‚
        - å¤§å°é™åˆ¶: å— GPU å†…å­˜å®¹é‡é™åˆ¶
    """
    size_mapping = {
        "1M":  262144,      # 1MB / 4 bytes = 262,144 elements
        "10M": 2621440,     # 10MB / 4 bytes = 2,621,440 elements  
        "100M": 26214400,   # 100MB / 4 bytes = 26,214,400 elements
        "1G": 268435456     # 1GB / 4 bytes = 268,435,456 elements
    }
    
    return size_mapping.get(test_size_str, 262144)

# GPU å†…å­˜å®‰å…¨æ£€æŸ¥
def check_gpu_memory_safety(tensor_size, device):
    """
    æ£€æŸ¥ GPU å†…å­˜æ˜¯å¦è¶³å¤Ÿå®¹çº³æµ‹è¯•æ•°æ®
    
    å®‰å…¨ç­–ç•¥:
        - é¢„ç•™ 20% å†…å­˜ç”¨äº CUDA ä¸Šä¸‹æ–‡å’Œå…¶ä»–å¼€é”€
        - è€ƒè™‘ NCCL å†…éƒ¨ç¼“å†²åŒºéœ€æ±‚
        - å¤š GPU ç¯å¢ƒä¸‹çš„å†…å­˜ç¢ç‰‡é—®é¢˜
    """
    gpu_memory_bytes = torch.cuda.get_device_properties(device).total_memory
    required_memory_bytes = tensor_size * 4  # float32
    
    # å®‰å…¨é˜ˆå€¼: 80% GPU å†…å­˜
    safety_threshold = gpu_memory_bytes * 0.8
    
    if required_memory_bytes > safety_threshold:
        print(f"è­¦å‘Š: æ‰€éœ€å†…å­˜ {required_memory_bytes/1024**3:.2f}GB "
              f"è¶…è¿‡å®‰å…¨é˜ˆå€¼ {safety_threshold/1024**3:.2f}GB")
        return False
    
    return True
```

#### 5.4.2 æ€§èƒ½æŒ‡æ ‡è®¡ç®—è¯¦è§£

```python
def calculate_performance_metrics(tensor, duration_ms, world_size):
    """
    è®¡ç®—è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡
    
    è¿”å›æŒ‡æ ‡è¯´æ˜:
        - å»¶è¿Ÿ: AllReduce æ“ä½œçš„ç«¯åˆ°ç«¯æ—¶é—´
        - æ•°æ®ååé‡: åº”ç”¨å±‚æ•°æ®å¤„ç†é€Ÿç‡ (éç½‘ç»œå¸¦å®½)
        - ç†è®ºä¼ è¾“é‡: Ring AllReduce ç®—æ³•çš„ç†è®ºç½‘ç»œä¼ è¾“é‡
        - ç®—æ³•æ•ˆç‡: å®é™…æ€§èƒ½ä¸ç†è®ºæœ€ä¼˜çš„æ¯”å€¼
    """
    
    # 1. åŸºç¡€æ•°æ®è®¡ç®—
    data_size_bytes = tensor.numel() * tensor.element_size()
    data_size_mb = data_size_bytes / (1024 * 1024)
    
    # 2. å»¶è¿Ÿè®¡ç®— (æ¯«ç§’)
    latency_ms = duration_ms
    
    # 3. æ•°æ®ååé‡è®¡ç®— (Gbps)
    # æ³¨æ„: è¿™æ˜¯åº”ç”¨å±‚ååé‡ï¼ŒåŒ…å«äº†ç®—æ³•å¼€é”€
    throughput_gbps = (data_size_mb * 8) / (duration_ms / 1000) / 1000
    
    # 4. ç†è®ºä¼ è¾“é‡è®¡ç®— (Ring AllReduce)
    if world_size > 1:
        # Ring AllReduce å…¬å¼: 2 * (N-1) / N * data_size
        transfer_efficiency = 2 * (world_size - 1) / world_size
        theoretical_transfer_mb = transfer_efficiency * data_size_mb
    else:
        theoretical_transfer_mb = 0  # å• GPU æ— ç½‘ç»œä¼ è¾“
    
    # 5. ç®—æ³•æ•ˆç‡åˆ†æ
    # ç†è®ºæœ€ä¼˜: æ¯ä¸ªå­—èŠ‚åªä¼ è¾“ä¸€æ¬¡
    # Ring AllReduce: æ¯ä¸ªå­—èŠ‚ä¼ è¾“ 2*(N-1)/N æ¬¡
    algorithm_overhead = transfer_efficiency if world_size > 1 else 1.0
    
    return {
        'latency_ms': latency_ms,
        'throughput_gbps': throughput_gbps, 
        'data_size_mb': data_size_mb,
        'theoretical_transfer_mb': theoretical_transfer_mb,
        'algorithm_overhead': algorithm_overhead
    }
```

### 5.5 è°ƒè¯•å’Œè¯Šæ–­æŠ€æœ¯

#### 5.5.1 NCCL è°ƒè¯•çº§åˆ«è¯¦è§£

```bash
# NCCL è°ƒè¯•çº§åˆ«é…ç½®
export NCCL_DEBUG=TRACE    # æœ€è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
export NCCL_DEBUG=INFO     # æ ‡å‡†è°ƒè¯•ä¿¡æ¯ (æ¨è)
export NCCL_DEBUG=WARN     # ä»…è­¦å‘Šå’Œé”™è¯¯ (ç”Ÿäº§ç¯å¢ƒ)

# è°ƒè¯•å­ç³»ç»Ÿé€‰æ‹©
export NCCL_DEBUG_SUBSYS=ALL        # æ‰€æœ‰å­ç³»ç»Ÿ
export NCCL_DEBUG_SUBSYS=INIT,NET   # åˆå§‹åŒ–å’Œç½‘ç»œå­ç³»ç»Ÿ
export NCCL_DEBUG_SUBSYS=GRAPH      # é€šä¿¡å›¾æ„å»º
export NCCL_DEBUG_SUBSYS=TUNING     # æ€§èƒ½è°ƒä¼˜ä¿¡æ¯

# è°ƒè¯•è¾“å‡ºç¤ºä¾‹è§£æ
# [nccl] INFO NCCL_IB_HCA set by environment to mlx5_0
#        â†‘     â†‘    â†‘
#     ç»„ä»¶  çº§åˆ«  æ¶ˆæ¯å†…å®¹
```

#### 5.5.2 æ€§èƒ½ç“¶é¢ˆè¯Šæ–­æµç¨‹

```bash
# 1. ç½‘ç»œè¿é€šæ€§æ£€æŸ¥
ping_test() {
    # IB ç½‘ç»œ ping æµ‹è¯•
    ibping -S    # æœåŠ¡ç«¯
    ibping -c 1000 -f <server_lid>  # å®¢æˆ·ç«¯
}

# 2. å¸¦å®½åŸºå‡†æµ‹è¯•  
bandwidth_test() {
    # ä½¿ç”¨ ib_write_bw æµ‹è¯•åŸå§‹ IB å¸¦å®½
    ib_write_bw -d mlx5_0 -i 1 -s 1048576
    
    # å¯¹æ¯” NCCL æµ‹è¯•ç»“æœä¸åŸå§‹å¸¦å®½
    # å¦‚æœå·®è·è¿‡å¤§ï¼Œå¯èƒ½å­˜åœ¨é…ç½®é—®é¢˜
}

# 3. å»¶è¿ŸåŸºå‡†æµ‹è¯•
latency_test() {
    # ä½¿ç”¨ ib_write_lat æµ‹è¯•åŸå§‹ IB å»¶è¿Ÿ
    ib_write_lat -d mlx5_0 -i 1000
    
    # NCCL å»¶è¿Ÿé€šå¸¸æ¯”åŸå§‹ IB å»¶è¿Ÿé«˜ 2-5 å€
    # è¿™æ˜¯æ­£å¸¸çš„ç®—æ³•å’Œåè®®å¼€é”€
}

# 4. GPU å†…å­˜å¸¦å®½æµ‹è¯•
gpu_memory_test() {
    # ä½¿ç”¨ bandwidthTest (éœ€è¦å®‰è£… CUDA Samples)
    # å¦‚æœå·²å®‰è£…: /usr/local/cuda/samples/1_Utilities/bandwidthTest/bandwidthTest
    if command -v bandwidthTest >/dev/null 2>&1; then
        bandwidthTest --memory=pinned --mode=quick
    else
        echo "bandwidthTest æœªæ‰¾åˆ°ï¼Œè¯·å®‰è£… CUDA Samples"
        echo "æˆ–ä½¿ç”¨: nvidia-smi --query-gpu=memory.total,memory.used --format=csv"
    fi
}    
    # GPU å†…å­˜å¸¦å®½åº”è¿œé«˜äºç½‘ç»œå¸¦å®½
    # ç¡®ä¿ä¸æ˜¯ GPU å†…å­˜æˆä¸ºç“¶é¢ˆ
}
```

---

## 6. Python æµ‹è¯•æ¨¡æ¿

### 6.1 Python æµ‹è¯•æ¨¡æ¿æ¦‚è¿°

`nccl_python_template.py` æä¾›äº†ä¸€ä¸ªç®€æ´é«˜æ•ˆçš„ NCCL åˆ†å¸ƒå¼é€šä¿¡æµ‹è¯•æ¨¡æ¿ï¼Œä¸“æ³¨äºæ ¸å¿ƒæ€§èƒ½æµ‹è¯•åŠŸèƒ½ï¼š

#### 6.1.1 åŠŸèƒ½ç‰¹æ€§

**ç³»ç»Ÿä¿¡æ¯æ”¶é›†**ï¼š

- è‡ªåŠ¨æ£€æµ‹å’Œæ˜¾ç¤ºç³»ç»Ÿç¡¬ä»¶ä¿¡æ¯ï¼ˆPythonç‰ˆæœ¬ã€PyTorchç‰ˆæœ¬ã€CUDAç‰ˆæœ¬ã€GPUä¿¡æ¯ï¼‰
- NCCL ç‰ˆæœ¬ä¿¡æ¯å’Œç¯å¢ƒå˜é‡é…ç½®å±•ç¤º
- æœ¬æœºIPåœ°å€è·å–
- GPUå†…å­˜ä¿¡æ¯æ˜¾ç¤º

**æ€§èƒ½æµ‹è¯•**ï¼š

- NCCL AllReduce æ“ä½œçš„æŒç»­æ€§èƒ½æµ‹è¯•
- åŸºäºæ—¶é—´çš„æµ‹è¯•æ§åˆ¶ï¼ˆé»˜è®¤30ç§’ï¼‰
- å®æ—¶å»¶è¿Ÿå’Œååé‡æµ‹é‡
- è¯¦ç»†çš„æ€§èƒ½ç»Ÿè®¡åˆ†æ

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- ä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œå‚æ•°é…ç½®
- æ”¯æŒå¤šè¿›ç¨‹åˆ†å¸ƒå¼æµ‹è¯•
- å›ºå®šä½¿ç”¨float32æ•°æ®ç±»å‹
- è‡ªåŠ¨è¿›ç¨‹åŒæ­¥å’Œèµ„æºæ¸…ç†

#### 6.1.2 æŠ€æœ¯æ¶æ„

**åˆ†å¸ƒå¼åˆå§‹åŒ–**ï¼š

- ä½¿ç”¨ PyTorch åˆ†å¸ƒå¼åç«¯ï¼ˆtorch.distributedï¼‰
- æ”¯æŒ NCCL åç«¯çš„ GPU é€šä¿¡
- åŸºäºç¯å¢ƒå˜é‡çš„è¿›ç¨‹ç»„ç®¡ç†
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œè¶…æ—¶æœºåˆ¶

**æµ‹è¯•æ‰§è¡Œæµç¨‹**ï¼š

- ç³»ç»Ÿä¿¡æ¯æ£€æµ‹å’Œç¯å¢ƒéªŒè¯
- åˆ†å¸ƒå¼ç¯å¢ƒåˆå§‹åŒ–å’Œè®¾å¤‡åˆ†é…
- é¢„çƒ­é˜¶æ®µï¼ˆ5æ¬¡AllReduceæ“ä½œï¼‰
- åŸºäºæ—¶é—´çš„æŒç»­æ€§èƒ½æµ‹è¯•
- ç»Ÿè®¡æ•°æ®æ”¶é›†å’Œç»“æœè¾“å‡º

**æ€§èƒ½ç›‘æ§**ï¼š

- æ¯«ç§’çº§ç²¾ç¡®æ—¶é—´æµ‹é‡
- å®æ—¶ååé‡è®¡ç®—ï¼ˆGB/sï¼‰
- å»¶è¿Ÿç»Ÿè®¡ï¼ˆå¹³å‡å€¼ã€æœ€å°å€¼ã€æœ€å¤§å€¼ï¼‰
- AllReduceç†è®ºä¼ è¾“é‡è®¡ç®—

### 6.2 ç¯å¢ƒè¦æ±‚

#### 6.2.1 è½¯ä»¶ä¾èµ–

```bash
# Python ç¯å¢ƒè¦æ±‚
Python >= 3.7

# æ ¸å¿ƒä¾èµ–åŒ…ï¼ˆå¿…éœ€ï¼‰
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# æ³¨æ„ï¼šæ¨¡æ¿ä»…ä½¿ç”¨æ ‡å‡†åº“å’ŒPyTorchï¼Œæ— éœ€é¢å¤–ä¾èµ–åŒ…
```

#### 6.2.2 ç¡¬ä»¶è¦æ±‚

- **GPU**: NVIDIA GPU with CUDA support
- **NCCL**: NCCL 2.0+ (é€šå¸¸éš PyTorch å®‰è£…)
- **ç½‘ç»œ**: InfiniBand, Ethernet, æˆ– NVLink
- **å†…å­˜**: è¶³å¤Ÿçš„ GPU å†…å­˜ç”¨äºæµ‹è¯•æ•°æ®

### 6.3 åŸºæœ¬ä½¿ç”¨

**é‡è¦è¯´æ˜**ï¼šè¯¥æ¨¡æ¿é€šè¿‡ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®ï¼Œé€šå¸¸ç”± `nccl_benchmark.sh` è„šæœ¬è°ƒç”¨ï¼Œä¸æ”¯æŒå‘½ä»¤è¡Œå‚æ•°ã€‚

#### 6.3.1 ç¯å¢ƒå˜é‡é…ç½®

```bash
# åˆ†å¸ƒå¼é…ç½®ï¼ˆå¿…éœ€ï¼‰
export RANK=0                    # è¿›ç¨‹æ’å
export WORLD_SIZE=2              # æ€»è¿›ç¨‹æ•°
export LOCAL_RANK=0              # æœ¬åœ°GPUæ’å
export MASTER_ADDR=localhost     # ä¸»èŠ‚ç‚¹åœ°å€
export MASTER_PORT=29500         # ä¸»èŠ‚ç‚¹ç«¯å£

# æµ‹è¯•å‚æ•°é…ç½®ï¼ˆå¯é€‰ï¼‰
export TENSOR_ELEMENTS=1000000   # å¼ é‡å…ƒç´ æ•°é‡ï¼ˆé»˜è®¤1Mï¼‰
export TEST_DURATION=30          # æµ‹è¯•æ—¶é•¿ï¼ˆç§’ï¼Œé»˜è®¤30ï¼‰
export NCCL_BACKEND=nccl         # åç«¯ç±»å‹ï¼ˆé»˜è®¤ncclï¼‰

# è¿è¡Œæµ‹è¯•
python nccl_python_template.py
```

#### 6.3.2 å•èŠ‚ç‚¹å¤šGPUæµ‹è¯•

```bash
# 2 GPUæµ‹è¯•ç¤ºä¾‹
export WORLD_SIZE=2
export MASTER_ADDR=localhost
export MASTER_PORT=29500

# å¯åŠ¨ç¬¬ä¸€ä¸ªè¿›ç¨‹
export RANK=0
export LOCAL_RANK=0
python nccl_python_template.py &

# å¯åŠ¨ç¬¬äºŒä¸ªè¿›ç¨‹
export RANK=1
export LOCAL_RANK=1
python nccl_python_template.py &

wait  # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
```

#### 6.3.3 å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼æµ‹è¯•

```bash
# èŠ‚ç‚¹1 (192.168.1.100) - è¿è¡Œ2ä¸ªè¿›ç¨‹
export WORLD_SIZE=4
export MASTER_ADDR=192.168.1.100
export MASTER_PORT=29500

# èŠ‚ç‚¹1çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹
export RANK=0
export LOCAL_RANK=0
python nccl_python_template.py &

# èŠ‚ç‚¹1çš„ç¬¬äºŒä¸ªè¿›ç¨‹
export RANK=1
export LOCAL_RANK=1
python nccl_python_template.py &

# èŠ‚ç‚¹2 (192.168.1.101) - è¿è¡Œ2ä¸ªè¿›ç¨‹
export WORLD_SIZE=4
export MASTER_ADDR=192.168.1.100
export MASTER_PORT=29500

# èŠ‚ç‚¹2çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹
export RANK=2
export LOCAL_RANK=0
python nccl_python_template.py &

# èŠ‚ç‚¹2çš„ç¬¬äºŒä¸ªè¿›ç¨‹
export RANK=3
export LOCAL_RANK=1
python nccl_python_template.py &
```

### 6.4 é«˜çº§é…ç½®

#### 6.4.1 æµ‹è¯•å‚æ•°è°ƒæ•´

```bash
# å¤§æ•°æ®é‡æµ‹è¯•ï¼ˆ10Må…ƒç´ ï¼Œçº¦40MBï¼‰
export TENSOR_ELEMENTS=10000000
export TEST_DURATION=60
python nccl_python_template.py

# å°æ•°æ®é‡å»¶è¿Ÿæµ‹è¯•ï¼ˆ100Kå…ƒç´ ï¼Œçº¦400KBï¼‰
export TENSOR_ELEMENTS=100000
export TEST_DURATION=30
python nccl_python_template.py

# é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•
export TENSOR_ELEMENTS=1000000
export TEST_DURATION=300  # 5åˆ†é’Ÿ
python nccl_python_template.py
```

#### 6.4.2 NCCLç¯å¢ƒå˜é‡é…ç½®

**æ¨èæ–¹å¼ï¼šä½¿ç”¨ nccl_benchmark.sh ç»Ÿä¸€é…ç½®ç®¡ç†å™¨ï¼š**

```bash
# è‡ªåŠ¨é…ç½®æ‰€æœ‰NCCLç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰
./nccl_benchmark.sh --network auto --dry-run

# æŸ¥çœ‹é…ç½®åçš„ç¯å¢ƒå˜é‡
./nccl_benchmark.sh --network ib --dry-run | grep "export"

# åº”ç”¨é…ç½®åˆ°å½“å‰ç¯å¢ƒ
source <(./nccl_benchmark.sh --network ib --dry-run | grep "export")

# NVLink ä¼˜åŒ–çº§åˆ«é…ç½®ï¼ˆä»…å•èŠ‚ç‚¹æœ‰æ•ˆï¼‰
./nccl_benchmark.sh --network nvlink --optimization-level balanced --dry-run | grep "export"
```

**æ‰‹åŠ¨é…ç½®æ–¹å¼ï¼ˆä»…åœ¨ç‰¹æ®Šéœ€æ±‚æ—¶ä½¿ç”¨ï¼‰ï¼š**

```bash
# NCCL è°ƒè¯•é…ç½®
export NCCL_DEBUG=INFO
export NCCL_DEBUG_SUBSYS=ALL

# ç½‘ç»œé…ç½®ï¼ˆç”±ç»Ÿä¸€é…ç½®ç®¡ç†å™¨è‡ªåŠ¨è®¾ç½®ï¼‰
export NCCL_IB_DISABLE=0
export NCCL_NET_GDR_LEVEL=5
export NCCL_SOCKET_IFNAME=^docker0,lo

# æ€§èƒ½ä¼˜åŒ–ï¼ˆç”±ä¼˜åŒ–çº§åˆ«è‡ªåŠ¨è®¾ç½®ï¼‰
export NCCL_BUFFSIZE=8388608
export NCCL_NTHREADS=16

# è¿è¡Œæµ‹è¯•
export RANK=0
export WORLD_SIZE=2
export LOCAL_RANK=0
python nccl_python_template.py
```

**ç»Ÿä¸€é…ç½®ç®¡ç†å™¨çš„ä¼˜åŠ¿**ï¼š

- **è‡ªåŠ¨åŒ–é…ç½®**ï¼šæ ¹æ®ç¡¬ä»¶ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜é…ç½®
- **æ™ºèƒ½ç¼“å­˜**ï¼šé¿å…é‡å¤æ£€æµ‹ï¼Œæé«˜é…ç½®æ•ˆç‡
- **æ‰¹é‡è®¾ç½®**ï¼šä¸€æ¬¡æ€§é…ç½®æ‰€æœ‰ç›¸å…³ç¯å¢ƒå˜é‡
- **ç½‘ç»œé¢„è®¾**ï¼šé’ˆå¯¹ä¸åŒç½‘ç»œç±»å‹çš„ä¼˜åŒ–é…ç½®
- **ä¼˜åŒ–çº§åˆ«**ï¼šä¿å®ˆã€å¹³è¡¡ã€æ¿€è¿›ä¸‰ç§æ€§èƒ½ç­–ç•¥ï¼ˆ**ä»…é€‚ç”¨äº NVLink ç½‘ç»œåç«¯**ï¼‰

> **é‡è¦è¯´æ˜**: ä¼˜åŒ–çº§åˆ«å‚æ•°ï¼ˆ`--optimization-level`ï¼‰ä»…å¯¹ NVLink ç½‘ç»œåç«¯æœ‰æ•ˆã€‚InfiniBandã€ä»¥å¤ªç½‘ã€PCIeã€Socket ç­‰å…¶ä»–ç½‘ç»œåç«¯ä½¿ç”¨å›ºå®šçš„ä¼˜åŒ–é…ç½®ã€‚

#### 6.4.3 æ‰¹é‡æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash
# batch_test.sh - æ‰¹é‡æ€§èƒ½æµ‹è¯•è„šæœ¬

# æµ‹è¯•ä¸åŒæ•°æ®å¤§å°ï¼ˆä»¥å…ƒç´ æ•°é‡ä¸ºå•ä½ï¼‰
tensor_sizes=(100000 1000000 10000000)  # 100K, 1M, 10M å…ƒç´ 
world_sizes=(2 4 8)

echo "å¼€å§‹æ‰¹é‡æ€§èƒ½æµ‹è¯•..."
echo "æ—¶é—´æˆ³: $(date)"

export MASTER_ADDR=localhost
export MASTER_PORT=29500
export TEST_DURATION=30

for size in "${tensor_sizes[@]}"; do
    for ws in "${world_sizes[@]}"; do
        echo "æµ‹è¯•é…ç½®: ${ws} è¿›ç¨‹, å¼ é‡å¤§å°: ${size} å…ƒç´ "
        
        export TENSOR_ELEMENTS=$size
        export WORLD_SIZE=$ws
        
        # å¯åŠ¨å¤šä¸ªè¿›ç¨‹
        for ((rank=0; rank<ws; rank++)); do
            export RANK=$rank
            export LOCAL_RANK=$((rank % $(nvidia-smi -L | wc -l)))
            python nccl_python_template.py > "log_${ws}proc_${size}elem_rank${rank}.txt" 2>&1 &
        done
        
        wait  # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
        echo "å®Œæˆ: ${ws} è¿›ç¨‹, ${size} å…ƒç´ "
        sleep 5
    done
done

echo "æ‰¹é‡æµ‹è¯•å®Œæˆ"
```

### 6.5 è¾“å‡ºè§£è¯»

#### 6.5.1 ç³»ç»Ÿä¿¡æ¯è¾“å‡º

æ¨¡æ¿é¦–å…ˆè¾“å‡ºç³»ç»Ÿç¯å¢ƒä¿¡æ¯ï¼š

```bash
=== ç³»ç»Ÿä¿¡æ¯ ===
Python ç‰ˆæœ¬: 3.12.11 | packaged by Anaconda, Inc. | (main, Jun  5 2025, 13:09:17) [GCC 11.2.0]
PyTorch ç‰ˆæœ¬: 2.7.0+cu126
CUDA ç‰ˆæœ¬: 12.6
NCCL ç‰ˆæœ¬: (2, 26, 2)
å¯ç”¨ GPU æ•°é‡: 3
GPU 0: NVIDIA GPU (79.2 GB)
GPU 1: NVIDIA GPU (79.2 GB)
GPU 2: NVIDIA GPU (79.2 GB)
æœ¬æœº IP: 192.168.1.100

=== NCCL ç¯å¢ƒä¿¡æ¯ ===
NCCL ç‰ˆæœ¬: (2, 26, 2)
NCCL ç¯å¢ƒå˜é‡:
  NCCL_IB_DISABLE: 1
  NCCL_NET_DISABLE: 1
  NCCL_NET_GDR_LEVEL: 0
  NCCL_IB_HCA: æœªè®¾ç½®
  NCCL_IB_GID_INDEX: æœªè®¾ç½®
  NCCL_DEBUG: INFO
  NCCL_DEBUG_SUBSYS: INIT,NET
  NCCL_P2P_DISABLE: 0
  NCCL_P2P_LEVEL: NVL
  NCCL_NVLS_ENABLE: 1
  NCCL_SOCKET_IFNAME: lo
  NCCL_IB_TIMEOUT: æœªè®¾ç½®
  NCCL_IB_RETRY_CNT: æœªè®¾ç½®
  NCCL_SHM_DISABLE: æœªè®¾ç½®
  NCCL_SOCKET_FAMILY: æœªè®¾ç½®
  NCCL_SOCKET_NTHREADS: æœªè®¾ç½®
```

#### 6.5.2 æµ‹è¯•é…ç½®è¾“å‡º

```bash
[Rank 0] å¼€å§‹åˆå§‹åŒ–åˆ†å¸ƒå¼ç¯å¢ƒ...
[Rank 0] åç«¯: nccl
[Rank 0] ä¸–ç•Œå¤§å°: 3
[Rank 0] æœ¬åœ°æ’å: 0
[Rank 0] å¼ é‡å¤§å°: 262144 ä¸ªå…ƒç´  (1.00 MB)
[Rank 0] åˆ†å¸ƒå¼ç¯å¢ƒåˆå§‹åŒ–æˆåŠŸ
[Rank 0] ä½¿ç”¨è®¾å¤‡: cuda:0
[Rank 0] GPU: NVIDIA GPU

[Rank 1] å¼€å§‹åˆå§‹åŒ–åˆ†å¸ƒå¼ç¯å¢ƒ...
[Rank 1] åç«¯: nccl
[Rank 1] ä¸–ç•Œå¤§å°: 3
[Rank 1] æœ¬åœ°æ’å: 1
[Rank 1] å¼ é‡å¤§å°: 262144 ä¸ªå…ƒç´  (1.00 MB)
[Rank 1] åˆ†å¸ƒå¼ç¯å¢ƒåˆå§‹åŒ–æˆåŠŸ
[Rank 1] ä½¿ç”¨è®¾å¤‡: cuda:1
[Rank 1] GPU: NVIDIA GPU

[Rank 2] å¼€å§‹åˆå§‹åŒ–åˆ†å¸ƒå¼ç¯å¢ƒ...
[Rank 2] åç«¯: nccl
[Rank 2] ä¸–ç•Œå¤§å°: 3
[Rank 2] æœ¬åœ°æ’å: 2
[Rank 2] å¼ é‡å¤§å°: 262144 ä¸ªå…ƒç´  (1.00 MB)
[Rank 2] åˆ†å¸ƒå¼ç¯å¢ƒåˆå§‹åŒ–æˆåŠŸ
[Rank 2] ä½¿ç”¨è®¾å¤‡: cuda:2
[Rank 2] GPU: NVIDIA GPU
```

#### 6.5.3 æ€§èƒ½æµ‹è¯•ç»“æœ

```bash
=== æ€§èƒ½æµ‹è¯•å¼€å§‹ ===
[Rank 0] è¿­ä»£ 100: 0.05 ms, 74.47 GB/s
[Rank 1] è¿­ä»£ 100: 0.05 ms, 73.47 GB/s
[Rank 2] è¿­ä»£ 100: 0.05 ms, 74.81 GB/s

[Rank 0] è¿­ä»£ 200: 0.05 ms, 75.16 GB/s
[Rank 1] è¿­ä»£ 200: 0.05 ms, 74.81 GB/s
[Rank 2] è¿­ä»£ 200: 0.05 ms, 75.50 GB/s

...

[Rank 0] è¿­ä»£ 374200: 0.05 ms, 75.16 GB/s
[Rank 1] è¿­ä»£ 374200: 0.05 ms, 74.81 GB/s
[Rank 2] è¿­ä»£ 374200: 0.05 ms, 75.50 GB/s

[Rank 0] æµ‹è¯•æ—¶é—´åˆ°è¾¾ï¼Œè®¾ç½®åœæ­¢æ ‡å¿—
[Rank 0] æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œé€€å‡ºæµ‹è¯•å¾ªç¯
[Rank 1] æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œé€€å‡ºæµ‹è¯•å¾ªç¯
[Rank 2] æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œé€€å‡ºæµ‹è¯•å¾ªç¯

=== æµ‹è¯•å®Œæˆ ===
[Rank 0] æ€»è¿­ä»£æ¬¡æ•°: 374250
[Rank 0] æ€»æµ‹è¯•æ—¶é—´: 30.01 ç§’
[Rank 0] å¹³å‡å»¶è¿Ÿ: 0.08 ms
[Rank 0] æœ€å°å»¶è¿Ÿ: 0.05 ms
[Rank 0] æœ€å¤§å»¶è¿Ÿ: 21.14 ms
[Rank 0] å¹³å‡ååé‡: 48.71 GB/s
[Rank 0] æ•°æ®å¤§å°: 262144 ä¸ªå…ƒç´  (1.00 MB)
[Rank 0] ç†è®ºä¼ è¾“é‡: 1461.91 GB
[Rank 0] ç½‘ç»œä¼ è¾“å€æ•°: 4.0x

[Rank 1] æ€»è¿­ä»£æ¬¡æ•°: 374250
[Rank 1] æ€»æµ‹è¯•æ—¶é—´: 30.01 ç§’
[Rank 1] å¹³å‡å»¶è¿Ÿ: 0.08 ms
[Rank 1] æœ€å°å»¶è¿Ÿ: 0.05 ms
[Rank 1] æœ€å¤§å»¶è¿Ÿ: 21.74 ms
[Rank 1] å¹³å‡ååé‡: 48.71 GB/s

[Rank 2] æ€»è¿­ä»£æ¬¡æ•°: 374250
[Rank 2] æ€»æµ‹è¯•æ—¶é—´: 30.01 ç§’
[Rank 2] å¹³å‡å»¶è¿Ÿ: 0.08 ms
[Rank 2] æœ€å°å»¶è¿Ÿ: 0.05 ms
[Rank 2] æœ€å¤§å»¶è¿Ÿ: 21.51 ms
[Rank 2] å¹³å‡ååé‡: 48.71 GB/s

âœ… NCCL AllReduce æµ‹è¯•æˆåŠŸå®Œæˆ
```

#### 6.5.4 æŒ‡æ ‡å«ä¹‰

- **æ€»è¿­ä»£æ¬¡æ•°**: åœ¨æŒ‡å®šæ—¶é—´å†…å®Œæˆçš„AllReduceæ“ä½œæ¬¡æ•°
- **æ€»æµ‹è¯•æ—¶é—´**: å®é™…æµ‹è¯•è¿è¡Œçš„æ€»æ—¶é•¿
- **å¹³å‡å»¶è¿Ÿ**: å•æ¬¡AllReduceæ“ä½œçš„å¹³å‡è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
- **æœ€å°å»¶è¿Ÿ**: æµ‹è¯•æœŸé—´è®°å½•çš„æœ€ä½å»¶è¿Ÿ
- **æœ€å¤§å»¶è¿Ÿ**: æµ‹è¯•æœŸé—´è®°å½•çš„æœ€é«˜å»¶è¿Ÿï¼ˆåŒ…å«åˆå§‹åŒ–å¼€é”€ï¼‰
- **å¹³å‡ååé‡**: æ•°æ®ä¼ è¾“çš„å¹³å‡é€Ÿç‡ï¼ˆGB/sï¼‰
- **æ•°æ®å¤§å°**: æ¯æ¬¡ä¼ è¾“çš„æ•°æ®é‡ï¼ˆå…ƒç´ æ•°é‡ï¼Œ1.00 MBï¼‰
- **ç†è®ºä¼ è¾“é‡**: æµ‹è¯•æœŸé—´çš„æ€»æ•°æ®ä¼ è¾“é‡
- **ç½‘ç»œä¼ è¾“å€æ•°**: AllReduceæ“ä½œçš„ç½‘ç»œä¼ è¾“å€æ•°ï¼ˆé€šå¸¸ä¸º 2Ã—(n-1)/nï¼Œå…¶ä¸­nä¸ºGPUæ•°é‡ï¼‰

### 6.6 æ³¨æ„äº‹é¡¹

#### 6.6.1 ç¯å¢ƒè¦æ±‚

- **PyTorchç‰ˆæœ¬**: ç¡®ä¿å®‰è£…äº†æ”¯æŒNCCLçš„PyTorchç‰ˆæœ¬
- **CUDAç¯å¢ƒ**: éœ€è¦æ­£ç¡®é…ç½®CUDAç¯å¢ƒå˜é‡
- **åˆ†å¸ƒå¼ç¯å¢ƒ**: å¤šèŠ‚ç‚¹æµ‹è¯•éœ€è¦é…ç½®SSHå…å¯†ç™»å½•
- **ç½‘ç»œè¿é€š**: ç¡®ä¿èŠ‚ç‚¹é—´ç½‘ç»œè¿é€šæ€§

#### 6.6.2 å¸¸è§é—®é¢˜

**ç¯å¢ƒå˜é‡æœªè®¾ç½®**ï¼š

```bash
# æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
echo $RANK $WORLD_SIZE $LOCAL_RANK $MASTER_ADDR $MASTER_PORT

# è®¾ç½®é»˜è®¤å€¼
export RANK=0
export WORLD_SIZE=1
export LOCAL_RANK=0
export MASTER_ADDR=localhost
export MASTER_PORT=29500
```

**GPUå†…å­˜ä¸è¶³**ï¼š

```bash
# å‡å°‘å¼ é‡å¤§å°
export TENSOR_ELEMENTS=100000  # å‡å°‘åˆ°100Kå…ƒç´ 

# æ£€æŸ¥GPUå†…å­˜ä½¿ç”¨
nvidia-smi
```

**åˆ†å¸ƒå¼åˆå§‹åŒ–è¶…æ—¶**ï¼š

```bash
# å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆä»£ç ä¸­å·²è®¾ç½®ä¸º300ç§’ï¼‰
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping $MASTER_ADDR

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -an | grep $MASTER_PORT
```

#### 6.6.3 è°ƒè¯•å»ºè®®

- **å•è¿›ç¨‹æµ‹è¯•**: å…ˆåœ¨å•è¿›ç¨‹ç¯å¢ƒä¸‹éªŒè¯ä»£ç æ­£ç¡®æ€§
- **é€æ­¥æ‰©å±•**: ä»å•èŠ‚ç‚¹å¤šGPUæ‰©å±•åˆ°å¤šèŠ‚ç‚¹æµ‹è¯•
- **æ—¥å¿—åˆ†æ**: æŸ¥çœ‹æ¯ä¸ªè¿›ç¨‹çš„è¾“å‡ºæ—¥å¿—
- **æ€§èƒ½å¯¹æ¯”**: ä¸å®˜æ–¹nccl-testsç»“æœè¿›è¡Œå¯¹æ¯”

---

## 7. é…ç½®è¯´æ˜

### 7.1 NCCL ç¯å¢ƒå˜é‡

è„šæœ¬ä¼šè‡ªåŠ¨é…ç½®ä»¥ä¸‹å…³é”®çš„ NCCL ç¯å¢ƒå˜é‡ï¼š

#### 7.1.1 åŸºç¡€é…ç½®

- `NCCL_IB_DISABLE=0`: å¯ç”¨ InfiniBand æ”¯æŒ
- `NCCL_NET_GDR_LEVEL=2`: å¯ç”¨ GPUDirect RDMA
- `NCCL_IB_HCA`: è‡ªåŠ¨æ£€æµ‹å¹¶è®¾ç½® HCA è®¾å¤‡å

#### 7.1.2 ç½‘ç»œç±»å‹ç‰¹å®šé…ç½®

**åŸç”Ÿ InfiniBand**:

- `NCCL_IB_GID_INDEX=0`: ä½¿ç”¨é»˜è®¤ GID
- `NCCL_IB_TC=136`: æµæ§åˆ¶å‚æ•°
- `NCCL_IB_SL=0`: æœåŠ¡çº§åˆ«

**RoCE (Ethernet over IB)**:

- `NCCL_IB_GID_INDEX=3`: RoCE v2 GID
- `NCCL_IB_TC=136`: æµæ§åˆ¶å‚æ•°
- `NCCL_IB_SL=0`: æœåŠ¡çº§åˆ«
- `NCCL_SOCKET_IFNAME=""`: ç¦ç”¨ Socket æ¥å£

### 7.2 è°ƒè¯•å’Œæ€§èƒ½ä¼˜åŒ–

- `NCCL_DEBUG=INFO`: å¯ç”¨è¯¦ç»†æ—¥å¿—
- `NCCL_DEBUG_SUBSYS=INIT,NET`: ç½‘ç»œåˆå§‹åŒ–è°ƒè¯•
- `NCCL_IB_TIMEOUT=22`: IB è¶…æ—¶è®¾ç½®
- `NCCL_IB_RETRY_CNT=7`: é‡è¯•æ¬¡æ•°

### 7.3 ä¸åŒç½‘ç»œæ¨¡å¼ä¸‹çš„ NCCL ç¯å¢ƒå˜é‡é…ç½®

è„šæœ¬æ”¯æŒ 7 ç§ç½‘ç»œåç«¯æ¨¡å¼ï¼Œæ¯ç§æ¨¡å¼éƒ½æœ‰ç‰¹å®šçš„ NCCL ç¯å¢ƒå˜é‡é…ç½®ç­–ç•¥å’Œä¸¥æ ¼çš„ç¡¬ä»¶æ£€æŸ¥æœºåˆ¶ã€‚è„šæœ¬ä¼šæ ¹æ®é€‰æ‹©çš„ç½‘ç»œæ¨¡å¼è¿›è¡Œç›¸åº”çš„ç¡¬ä»¶éªŒè¯ï¼Œå¦‚æœç¡¬ä»¶ä¸æ”¯æŒæˆ–é…ç½®ä¸å½“ï¼Œä¼šç›´æ¥é€€å‡ºå¹¶æä¾›è¯¦ç»†çš„è§£å†³æ–¹æ¡ˆã€‚

**æ”¯æŒçš„ç½‘ç»œæ¨¡å¼**ï¼š

- **auto**: è‡ªåŠ¨æ£€æµ‹æœ€ä¼˜ç½‘ç»œï¼ˆæŒ‰ NCCL ä¼˜å…ˆçº§ï¼‰
- **ib**: å¼ºåˆ¶ä½¿ç”¨ InfiniBandï¼ˆåŒ…æ‹¬åŸç”Ÿ IB å’Œ RoCEï¼‰
- **nvlink**: å¼ºåˆ¶ä½¿ç”¨ NVLinkï¼ˆä»…å•èŠ‚ç‚¹å¤šGPUï¼‰
- **pcie**: å¼ºåˆ¶ä½¿ç”¨ PCIe P2Pï¼ˆä»…å•èŠ‚ç‚¹å¤šGPUï¼‰
- **ethernet**: ä½¿ç”¨æ ‡å‡†ä»¥å¤ªç½‘
- **socket**: å¼ºåˆ¶ä½¿ç”¨ TCP Socket
- **shm**: ä»…ä½¿ç”¨å…±äº«å†…å­˜ï¼ˆä»…å•èŠ‚ç‚¹ï¼‰

**é‡è¦ç‰¹æ€§**ï¼š

- **ç¡¬ä»¶æ£€æŸ¥**: æ¯ç§å¼ºåˆ¶æ¨¡å¼éƒ½ä¼šéªŒè¯ç¡¬ä»¶æ”¯æŒ
- **é”™è¯¯å¤„ç†**: ç¡¬ä»¶ä¸åŒ¹é…æ—¶æä¾›è¯¦ç»†çš„è§£å†³æ–¹æ¡ˆ
- **é…ç½®å†²çªæ£€æµ‹**: é˜²æ­¢å¤šèŠ‚ç‚¹æ¨¡å¼ä½¿ç”¨å•èŠ‚ç‚¹ä¸“ç”¨ç½‘ç»œ
- **ç¯å¢ƒå˜é‡å±•ç¤º**: å®æ—¶æ˜¾ç¤ºå½“å‰ NCCL ç¯å¢ƒå˜é‡é…ç½®

ä»¥ä¸‹æ˜¯å„ç§æ¨¡å¼çš„è¯¦ç»†é…ç½®è¯´æ˜ï¼š

#### 7.3.1 Auto æ¨¡å¼ (`--network auto`)

**é…ç½®ç­–ç•¥**: æŒ‰ç…§ NCCL ä¼˜å…ˆçº§è‡ªåŠ¨æ£€æµ‹å¹¶é€‰æ‹©æœ€ä¼˜ç½‘ç»œ

Auto æ¨¡å¼å®ç°äº†æ™ºèƒ½çš„ç¡¬ä»¶æ£€æµ‹å’Œé…ç½®é€‰æ‹©ï¼Œä¸¥æ ¼æŒ‰ç…§ NCCL çš„æ€§èƒ½ä¼˜å…ˆçº§è¿›è¡Œæ£€æµ‹ï¼š

**æ£€æµ‹ä¼˜å…ˆçº§å’Œé€»è¾‘**:

1. **NVLink æ£€æµ‹** (æœ€é«˜ä¼˜å…ˆçº§ï¼Œä»…å•èŠ‚ç‚¹å¤šGPU)

   ```bash
   # æ£€æµ‹æ´»è·ƒçš„ NVLink è¿æ¥
   nvidia-smi nvlink --status | grep "GB/s"
   # éªŒè¯å¸¦å®½ä¿¡æ¯ï¼ˆå¦‚ "26.562 GB/s"ï¼‰
   # å¤‡é€‰ï¼šæ£€æµ‹ GPU æ‹“æ‰‘ä¸­çš„ NVLink ç¡¬ä»¶
   nvidia-smi topo -m | grep "NV[0-9]+"
   ```

2. **PCIe P2P æ£€æµ‹** (ç¬¬äºŒä¼˜å…ˆçº§ï¼Œä»…å•èŠ‚ç‚¹å¤šGPU)

   ```bash
   # æ£€æŸ¥ P2P æ‹“æ‰‘çŸ©é˜µ
   nvidia-smi topo -p2p r | grep "OK"
   # åŸºäº GPU å‹å·æ¨æµ‹ï¼ˆTesla/Quadro/Aç³»åˆ—/Hç³»åˆ—æ”¯æŒï¼‰
   ```

3. **å…±äº«å†…å­˜** (ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼Œä»…å•èŠ‚ç‚¹)
   - å•èŠ‚ç‚¹æ¨¡å¼ä¸‹è‡ªåŠ¨å¯ç”¨ï¼Œæ— éœ€é¢å¤–æ£€æµ‹

4. **ç½‘ç»œä¼ è¾“** (æœ€ä½ä¼˜å…ˆçº§)

   ```bash
   # InfiniBand ä¼˜å…ˆæ£€æµ‹
   ibv_devinfo | grep "link_layer"
   # åŒºåˆ†åŸç”Ÿ InfiniBand å’Œ RoCE
   # ä»¥å¤ªç½‘å¤‡é€‰ï¼šInfiniBand ä¸å¯ç”¨æ—¶å›é€€
   ```

**ç¯å¢ƒå˜é‡è®¾ç½®**: æ ¹æ®æ£€æµ‹ç»“æœè°ƒç”¨å¯¹åº”çš„é…ç½®å‡½æ•°

```bash
# é€šç”¨è°ƒè¯•é…ç½®ï¼ˆæ‰€æœ‰æ£€æµ‹åˆ°çš„æ¨¡å¼ï¼‰
NCCL_DEBUG=INFO                    # å¯ç”¨è°ƒè¯•ä¿¡æ¯
NCCL_DEBUG_SUBSYS=INIT,NET        # åˆå§‹åŒ–å’Œç½‘ç»œå­ç³»ç»Ÿè°ƒè¯•

# å¤šèŠ‚ç‚¹é…ç½®ï¼ˆå¦‚æœå¯ç”¨å¤šèŠ‚ç‚¹æ¨¡å¼ï¼‰
NCCL_SOCKET_IFNAME=^docker0,lo     # æ’é™¤å®¹å™¨æ¥å£

# å…·ä½“çš„ç¯å¢ƒå˜é‡é…ç½®å–å†³äºæ£€æµ‹ç»“æœï¼š
# - æ£€æµ‹åˆ° NVLink â†’ è°ƒç”¨ configure_nvlink_settings
# - æ£€æµ‹åˆ° PCIe P2P â†’ è°ƒç”¨ configure_pcie_p2p_settings  
# - å•èŠ‚ç‚¹æ— é«˜é€Ÿäº’è¿ â†’ è°ƒç”¨ configure_shm_settings
# - æ£€æµ‹åˆ° InfiniBand â†’ è°ƒç”¨ configure_infiniband_settings
# - å›é€€åˆ°ä»¥å¤ªç½‘ â†’ è°ƒç”¨ configure_ethernet_settings
```

**æ£€æµ‹æ—¥å¿—ç¤ºä¾‹**:

```bash
[INFO] è‡ªåŠ¨æ£€æµ‹ç½‘ç»œç¯å¢ƒ (æŒ‰ NCCL ä¼˜å…ˆçº§: NVLink > PCIe P2P > å…±äº«å†…å­˜ > ç½‘ç»œä¼ è¾“)...
[SUCCESS] æ£€æµ‹åˆ° 4 ä¸ªæ´»è·ƒçš„ NVLink è¿æ¥ (å¸¦å®½: 25.781 GB/s)
[SUCCESS] è‡ªåŠ¨é€‰æ‹© NVLink ç½‘ç»œ (æœ€é«˜ä¼˜å…ˆçº§)
```

#### 7.3.2 InfiniBand æ¨¡å¼ (`--network ib`)

**é…ç½®ç­–ç•¥**: å¼ºåˆ¶ä½¿ç”¨ InfiniBand ç½‘ç»œï¼ŒåŒ…å«ä¸¥æ ¼çš„ç¡¬ä»¶æ£€æŸ¥

InfiniBand æ¨¡å¼ä¼šè¿›è¡Œå…¨é¢çš„ç¡¬ä»¶éªŒè¯ï¼Œç¡®ä¿ InfiniBand ç¯å¢ƒå¯ç”¨ï¼š

**ç¡¬ä»¶æ£€æŸ¥æµç¨‹**:

1. **å·¥å…·å¯ç”¨æ€§æ£€æŸ¥**

   ```bash
   # éªŒè¯ ibv_devinfo å‘½ä»¤å¯ç”¨æ€§
   command -v ibv_devinfo >/dev/null 2>&1
   # å¤±è´¥æ—¶æä¾›å®‰è£…æŒ‡å¯¼ï¼šapt-get install infiniband-diags
   ```

2. **è®¾å¤‡æ£€æµ‹å’Œç±»å‹è¯†åˆ«**

   ```bash
   # æ£€æµ‹ InfiniBand è®¾å¤‡
   ibv_devinfo | grep "link_layer:"
   # åŒºåˆ†é“¾è·¯å±‚ç±»å‹ï¼š
   # - "InfiniBand" â†’ åŸç”Ÿ InfiniBand
   # - "Ethernet" â†’ RoCE (RDMA over Converged Ethernet)
   ```

3. **è®¾å¤‡çŠ¶æ€éªŒè¯**

   ```bash
   # éªŒè¯ HCA è®¾å¤‡çŠ¶æ€ï¼ˆå¦‚æœ ibstat å¯ç”¨ï¼‰
   ibstat | grep "State: Active"
   # ç¡®ä¿è®¾å¤‡å¤„äºæ´»è·ƒçŠ¶æ€
   ```

**ç¯å¢ƒå˜é‡è®¾ç½®**:

```bash
# æ ¸å¿ƒ InfiniBand é…ç½®
NCCL_IB_DISABLE=0                  # å¯ç”¨ InfiniBand
NCCL_SOCKET_DISABLE=1              # ç¦ç”¨ Socket ä¼ è¾“
NCCL_NET_GDR_LEVEL=5               # æœ€é«˜çº§åˆ«çš„ GPUDirect RDMA

# InfiniBand ç‰¹å®šå‚æ•°
NCCL_IB_HCA=mlx5_0                 # HCA è®¾å¤‡ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
NCCL_IB_GID_INDEX=3                # GID ç´¢å¼•ï¼ˆRoCE ä½¿ç”¨ 3ï¼ŒåŸç”Ÿ IB ä½¿ç”¨ 0ï¼‰
NCCL_IB_TIMEOUT=22                 # è¶…æ—¶è®¾ç½®
NCCL_IB_RETRY_CNT=7                # é‡è¯•æ¬¡æ•°

# æ€§èƒ½ä¼˜åŒ–
NCCL_IB_USE_CUDA_MEM=1             # å¯ç”¨ CUDA å†…å­˜
NCCL_IB_CUDA_SUPPORT=1             # å¯ç”¨ CUDA æ”¯æŒ
NCCL_BUFFSIZE=8388608              # 8MB ç¼“å†²åŒº

# è°ƒè¯•å’Œç›‘æ§
NCCL_DEBUG=INFO
NCCL_DEBUG_SUBSYS=INIT,NET
NCCL_GRAPH_DUMP_FILE=/tmp/nccl_graph_ib.xml
NCCL_TOPO_DUMP_FILE=/tmp/nccl_topo_ib.xml

# å…¶ä»–é…ç½®
NCCL_IGNORE_CPU_AFFINITY=1
NCCL_CROSS_NIC=0
```

**é”™è¯¯å¤„ç†**: ç¡¬ä»¶æ£€æŸ¥å¤±è´¥æ—¶ä¼šç›´æ¥é€€å‡ºå¹¶æä¾›è§£å†³æ–¹æ¡ˆï¼š

```bash
[ERROR] ç¡¬ä»¶æ£€æŸ¥å¤±è´¥: ibv_devinfo å‘½ä»¤ä¸å¯ç”¨ï¼Œè¯·å®‰è£… InfiniBand é©±åŠ¨å’Œå·¥å…·
[ERROR] æ— æ³•å¼ºåˆ¶ä½¿ç”¨ InfiniBand ç½‘ç»œ
[INFO] è§£å†³æ–¹æ¡ˆ:
[INFO]   1. å®‰è£… InfiniBand é©±åŠ¨: apt-get install infiniband-diags
[INFO]   2. æˆ–ä½¿ç”¨å…¶ä»–ç½‘ç»œåç«¯: --network ethernet æˆ– --network auto
```

#### 7.3.3 NVLink æ¨¡å¼ (`--network nvlink`)

**é…ç½®ç­–ç•¥**: å¼ºåˆ¶ä½¿ç”¨ NVLink ä¼ è¾“ï¼Œä»…æ”¯æŒå•èŠ‚ç‚¹å¤šGPU

NVLink æ¨¡å¼åŒ…å«ä¸¥æ ¼çš„ç¡¬ä»¶æ£€æŸ¥å’Œé…ç½®é™åˆ¶ï¼š

**åŸºç¡€æ¡ä»¶æ£€æŸ¥**:

1. **èŠ‚ç‚¹æ¨¡å¼éªŒè¯**

   ```bash
   # NVLink ä»…é€‚ç”¨äºå•èŠ‚ç‚¹å¤šGPUåœºæ™¯
   if [ "$MULTI_NODE_MODE" = true ]; then
       # ç›´æ¥é€€å‡ºï¼Œæä¾›è§£å†³æ–¹æ¡ˆ
   fi
   ```

2. **GPU æ•°é‡æ£€æŸ¥**

   ```bash
   # æ£€æŸ¥ nvidia-smi å¯ç”¨æ€§
   command -v nvidia-smi >/dev/null 2>&1
   # éªŒè¯ GPU æ•°é‡ï¼ˆè‡³å°‘ 2 ä¸ªï¼‰
   gpu_count=$(nvidia-smi -L | wc -l)
   ```

**NVLink ç¡¬ä»¶æ£€æµ‹**:

1. **æ´»è·ƒè¿æ¥æ£€æµ‹**ï¼ˆä¸»è¦æ–¹æ³•ï¼‰

   ```bash
   # æ£€æµ‹æ´»è·ƒçš„ NVLink è¿æ¥
   nvidia-smi nvlink --status | grep -c "GB/s"
   # éªŒè¯å¸¦å®½ä¿¡æ¯ï¼ˆå¦‚ "26.562 GB/s"ï¼‰
   ```

2. **ç¡¬ä»¶æ‹“æ‰‘æ£€æµ‹**ï¼ˆå¤‡é€‰æ–¹æ³•ï¼‰

   ```bash
   # æ£€æŸ¥ NVLink ç¡¬ä»¶æ‹“æ‰‘
   nvidia-smi topo -m | grep -E "NV[0-9]+"
   ```

**ç¯å¢ƒå˜é‡è®¾ç½®**:

```bash
# NVLink æ ¸å¿ƒé…ç½®
NCCL_NET_DISABLE=1                 # ç¦ç”¨ç½‘ç»œä¼ è¾“
NCCL_P2P_DISABLE=0                 # å¯ç”¨ P2P ä¼ è¾“
NCCL_SHM_DISABLE=1                 # ç¦ç”¨å…±äº«å†…å­˜

# NVLink ç‰¹å®šå‚æ•°
NCCL_NVLS_ENABLE=1                 # å¯ç”¨ NVLink Sharp
NCCL_NVLS_CHUNKSIZE=524288         # å—å¤§å° (512KB)
NCCL_ALGO=NVLS,Tree,Ring           # ç®—æ³•ä¼˜å…ˆçº§

# æ€§èƒ½ä¼˜åŒ–
NCCL_MAX_NCHANNELS=16              # æœ€å¤§é€šé“æ•°
NCCL_MIN_NCHANNELS=8               # æœ€å°é€šé“æ•°

# è°ƒè¯•é…ç½®
NCCL_DEBUG=INFO
NCCL_DEBUG_SUBSYS=INIT,NET
NCCL_GRAPH_DUMP_FILE=/tmp/nccl_graph_nvlink.xml
NCCL_TOPO_DUMP_FILE=/tmp/nccl_topo_nvlink.xml

# å…¶ä»–é…ç½®
NCCL_IGNORE_CPU_AFFINITY=1
NCCL_CROSS_NIC=0
```

**é”™è¯¯å¤„ç†**: ä¸æ»¡è¶³æ¡ä»¶æ—¶ä¼šç›´æ¥é€€å‡ºå¹¶æä¾›è§£å†³æ–¹æ¡ˆï¼š

```bash
[ERROR] NVLink ä»…æ”¯æŒå•èŠ‚ç‚¹å¤šGPUæ¨¡å¼ï¼Œä¸æ”¯æŒå¤šèŠ‚ç‚¹
[ERROR] æ— æ³•å¼ºåˆ¶ä½¿ç”¨ NVLink ç½‘ç»œ
[INFO] è§£å†³æ–¹æ¡ˆ:
[INFO]   1. ä½¿ç”¨å•èŠ‚ç‚¹æ¨¡å¼ (ç§»é™¤ -m æˆ– --multi-node å‚æ•°)
[INFO]   2. æˆ–ä½¿ç”¨å¤šèŠ‚ç‚¹å…¼å®¹çš„ç½‘ç»œåç«¯: --network ib æˆ– --network ethernet
```

#### 7.3.4 PCIe æ¨¡å¼ (`--network pcie`)

**é…ç½®ç­–ç•¥**: å¼ºåˆ¶ä½¿ç”¨ PCIe P2P ä¼ è¾“ï¼Œä»…æ”¯æŒå•èŠ‚ç‚¹å¤šGPU

PCIe æ¨¡å¼ä¸ NVLink æ¨¡å¼ç±»ä¼¼ï¼ŒåŒ…å«ä¸¥æ ¼çš„ç¡¬ä»¶æ£€æŸ¥å’Œé…ç½®é™åˆ¶ï¼š

**åŸºç¡€æ¡ä»¶æ£€æŸ¥**:

1. **èŠ‚ç‚¹æ¨¡å¼éªŒè¯**

   ```bash
   # PCIe P2P ä»…é€‚ç”¨äºå•èŠ‚ç‚¹å¤šGPUåœºæ™¯
   if [ "$MULTI_NODE_MODE" = true ]; then
       # ç›´æ¥é€€å‡ºï¼Œæä¾›è§£å†³æ–¹æ¡ˆ
   fi
   ```

2. **GPU æ•°é‡å’Œ P2P æ”¯æŒæ£€æŸ¥**

   ```bash
   # éªŒè¯ GPU æ•°é‡ï¼ˆè‡³å°‘ 2 ä¸ªï¼‰
   gpu_count=$(nvidia-smi -L | wc -l)
   # æ£€æŸ¥ P2P æ‹“æ‰‘å¯ç”¨æ€§
   nvidia-smi topo -p2p r | grep "OK"
   ```

**PCIe P2P ç¡¬ä»¶æ£€æµ‹**:

1. **P2P æ‹“æ‰‘éªŒè¯**

   ```bash
   # æ£€æŸ¥ P2P æ‹“æ‰‘çŸ©é˜µ
   nvidia-smi topo -p2p r | grep "OK"
   ```

2. **ACS çŠ¶æ€æ£€æµ‹**

   ```bash
   # æ£€æµ‹ Access Control Services (ACS) çŠ¶æ€
   # ACS å¯ç”¨å¯èƒ½é˜»æ­¢ P2P é€šä¿¡
   ```

3. **GPU å‹å·æ¨æµ‹**

   ```bash
   # åŸºäº GPU å‹å·æ¨æµ‹ P2P æ”¯æŒ
   # Tesla/Quadro/Aç³»åˆ—/Hç³»åˆ—é€šå¸¸æ”¯æŒ P2P
   ```

**ç¯å¢ƒå˜é‡è®¾ç½®**:

```bash
# PCIe P2P æ ¸å¿ƒé…ç½®
NCCL_NET_DISABLE=1                 # ç¦ç”¨ç½‘ç»œä¼ è¾“
NCCL_P2P_DISABLE=0                 # å¯ç”¨ P2P ä¼ è¾“
NCCL_SHM_DISABLE=1                 # ç¦ç”¨å…±äº«å†…å­˜

# PCIe ç‰¹å®šå‚æ•°
NCCL_P2P_LEVEL=SYS                 # ç³»ç»Ÿçº§åˆ« P2P
NCCL_ALGO=Tree,Ring                # ç®—æ³•é€‰æ‹©

# æ€§èƒ½ä¼˜åŒ–
NCCL_MAX_NCHANNELS=8               # æœ€å¤§é€šé“æ•°
NCCL_MIN_NCHANNELS=4               # æœ€å°é€šé“æ•°

# è°ƒè¯•é…ç½®
NCCL_DEBUG=INFO
NCCL_DEBUG_SUBSYS=INIT,NET
NCCL_GRAPH_DUMP_FILE=/tmp/nccl_graph_pcie.xml
NCCL_TOPO_DUMP_FILE=/tmp/nccl_topo_pcie.xml

# å…¶ä»–é…ç½®
NCCL_IGNORE_CPU_AFFINITY=1
NCCL_CROSS_NIC=0
```

**é”™è¯¯å¤„ç†**: ä¸æ»¡è¶³æ¡ä»¶æ—¶ä¼šç›´æ¥é€€å‡ºå¹¶æä¾›è§£å†³æ–¹æ¡ˆï¼š

```bash
[ERROR] PCIe P2P ä»…æ”¯æŒå•èŠ‚ç‚¹å¤šGPUæ¨¡å¼ï¼Œä¸æ”¯æŒå¤šèŠ‚ç‚¹
[ERROR] æ— æ³•å¼ºåˆ¶ä½¿ç”¨ PCIe P2P ç½‘ç»œ
[INFO] è§£å†³æ–¹æ¡ˆ:
[INFO]   1. ä½¿ç”¨å•èŠ‚ç‚¹æ¨¡å¼ (ç§»é™¤ -m æˆ– --multi-node å‚æ•°)
[INFO]   2. æˆ–ä½¿ç”¨å¤šèŠ‚ç‚¹å…¼å®¹çš„ç½‘ç»œåç«¯: --network ib æˆ– --network ethernet
```

#### 7.3.5 ä»¥å¤ªç½‘æ¨¡å¼ (`--network ethernet`)

**é…ç½®ç­–ç•¥**: ä½¿ç”¨æ ‡å‡†ä»¥å¤ªç½‘è¿›è¡Œé€šä¿¡ï¼ˆå…¼å®¹æ€§æ¨¡å¼ï¼‰

ä»¥å¤ªç½‘æ¨¡å¼æä¾›æœ€å¤§çš„å…¼å®¹æ€§ï¼Œé€‚ç”¨äºå„ç§ç½‘ç»œç¯å¢ƒï¼š

**ç½‘ç»œæ¥å£æ£€æµ‹**:

1. **å¯ç”¨æ¥å£æ£€æµ‹**

   ```bash
   # æ£€æµ‹å¯ç”¨çš„ä»¥å¤ªç½‘æ¥å£
   ip link show | grep "state UP" | grep -v "lo\|docker"
   # æ’é™¤å›ç¯å’Œè™šæ‹Ÿæ¥å£
   ```

2. **æ¥å£çŠ¶æ€éªŒè¯**

   ```bash
   # éªŒè¯æ¥å£çŠ¶æ€å’Œè¿é€šæ€§
   # é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„ä»¥å¤ªç½‘æ¥å£
   ```

**ç¯å¢ƒå˜é‡è®¾ç½®**:

```bash
# ä»¥å¤ªç½‘æ ¸å¿ƒé…ç½®
NCCL_NET_DISABLE=0                 # å¯ç”¨ç½‘ç»œä¼ è¾“
NCCL_IB_DISABLE=1                  # ç¦ç”¨ InfiniBand
NCCL_SOCKET_DISABLE=0              # å¯ç”¨ Socket ä¼ è¾“

# ç½‘ç»œæ¥å£é…ç½®
NCCL_SOCKET_IFNAME=eth0            # æŒ‡å®šä»¥å¤ªç½‘æ¥å£ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
NCCL_SOCKET_NTHREADS=4             # Socket çº¿ç¨‹æ•°

# æ€§èƒ½é…ç½®
NCCL_NET_GDR_LEVEL=0               # ç¦ç”¨ GPUDirectï¼ˆä»¥å¤ªç½‘ä¸æ”¯æŒï¼‰
NCCL_BUFFSIZE=8388608              # 8MB ç¼“å†²åŒº

# è°ƒè¯•é…ç½®
NCCL_DEBUG=INFO
NCCL_DEBUG_SUBSYS=INIT,NET
NCCL_GRAPH_DUMP_FILE=/tmp/nccl_graph_ethernet.xml
NCCL_TOPO_DUMP_FILE=/tmp/nccl_topo_ethernet.xml

# å…¶ä»–é…ç½®
NCCL_IGNORE_CPU_AFFINITY=1
NCCL_CROSS_NIC=0
```

**ç‰¹ç‚¹**:

- **é«˜å…¼å®¹æ€§**: é€‚ç”¨äºæ‰€æœ‰æœ‰ä»¥å¤ªç½‘çš„ç¯å¢ƒ
- **è‡ªåŠ¨æ£€æµ‹**: è‡ªåŠ¨é€‰æ‹©å¯ç”¨çš„ä»¥å¤ªç½‘æ¥å£
- **æ€§èƒ½é€‚ä¸­**: æ€§èƒ½ä½äº InfiniBand ä½†é«˜äº Socket æ¨¡å¼
- **å¤šèŠ‚ç‚¹æ”¯æŒ**: æ”¯æŒå¤šèŠ‚ç‚¹åˆ†å¸ƒå¼è®­ç»ƒ

#### 7.3.6 Socket æ¨¡å¼ (`--network socket`)

**é…ç½®ç­–ç•¥**: å¼ºåˆ¶ä½¿ç”¨ TCP Socket è¿›è¡Œé€šä¿¡ï¼ˆè°ƒè¯•å’Œæµ‹è¯•æ¨¡å¼ï¼‰

Socket æ¨¡å¼å¼ºåˆ¶ä½¿ç”¨ TCP Socket ä¼ è¾“ï¼Œä¸»è¦ç”¨äºè°ƒè¯•å’Œå…¼å®¹æ€§æµ‹è¯•ï¼š

**é…ç½®ç‰¹ç‚¹**:

- **å¼ºåˆ¶ Socket**: ç¦ç”¨æ‰€æœ‰å…¶ä»–ä¼ è¾“æ–¹å¼
- **å®¹å™¨å‹å¥½**: è‡ªåŠ¨æ’é™¤å®¹å™¨ç½‘ç»œæ¥å£
- **è°ƒè¯•ä¼˜åŒ–**: é€‚åˆç½‘ç»œé—®é¢˜æ’æŸ¥

**ç¯å¢ƒå˜é‡è®¾ç½®**:

```bash
# Socket æ ¸å¿ƒé…ç½®
NCCL_NET_DISABLE=0                 # å¯ç”¨ç½‘ç»œä¼ è¾“
NCCL_IB_DISABLE=1                  # ç¦ç”¨ InfiniBand
NCCL_SOCKET_DISABLE=0              # å¯ç”¨ Socket ä¼ è¾“
NCCL_SOCKET_FORCE=1                # å¼ºåˆ¶ä½¿ç”¨ Socket

# å®¹å™¨ç¯å¢ƒé€‚é…
NCCL_SOCKET_IFNAME=^docker0,lo     # æ’é™¤å®¹å™¨æ¥å£ï¼ˆå¤šèŠ‚ç‚¹ï¼‰
# æˆ–å•èŠ‚ç‚¹æ—¶ä½¿ç”¨ loopback

# æ€§èƒ½é…ç½®
NCCL_NET_GDR_LEVEL=0               # ç¦ç”¨ GPUDirect
NCCL_BUFFSIZE=8388608              # 8MB ç¼“å†²åŒº
NCCL_CHECK_DISABLE=0               # å¯ç”¨æ£€æŸ¥

# è°ƒè¯•é…ç½®
NCCL_DEBUG=INFO
NCCL_DEBUG_SUBSYS=INIT,NET
NCCL_GRAPH_DUMP_FILE=/tmp/nccl_graph_socket.xml
NCCL_TOPO_DUMP_FILE=/tmp/nccl_topo_socket.xml

# å…¶ä»–é…ç½®
NCCL_IGNORE_CPU_AFFINITY=1
NCCL_CROSS_NIC=0
```

**ä½¿ç”¨åœºæ™¯**:

- **ç½‘ç»œè°ƒè¯•**: æ’æŸ¥ç½‘ç»œé…ç½®é—®é¢˜
- **å…¼å®¹æ€§æµ‹è¯•**: éªŒè¯åŸºç¡€ TCP è¿é€šæ€§
- **å®¹å™¨ç¯å¢ƒ**: å®¹å™¨åŒ–éƒ¨ç½²çš„å¤‡é€‰æ–¹æ¡ˆ
- **å¼€å‘æµ‹è¯•**: å¼€å‘ç¯å¢ƒçš„ç®€å•é…ç½®

#### 7.3.7 å…±äº«å†…å­˜æ¨¡å¼ (`--network shm`)

**é…ç½®ç­–ç•¥**: ä»…ä½¿ç”¨å…±äº«å†…å­˜è¿›è¡Œ GPU é—´é€šä¿¡ï¼ˆä»…å•èŠ‚ç‚¹ï¼‰

å…±äº«å†…å­˜æ¨¡å¼æ˜¯æœ€åŸºç¡€çš„ä¼ è¾“æ–¹å¼ï¼Œä»…é€‚ç”¨äºå•èŠ‚ç‚¹ç¯å¢ƒï¼š

**é™åˆ¶æ£€æŸ¥**:

1. **èŠ‚ç‚¹æ¨¡å¼éªŒè¯**

   ```bash
   # å…±äº«å†…å­˜ä»…é€‚ç”¨äºå•èŠ‚ç‚¹
   if [ "$MULTI_NODE_MODE" = true ]; then
       # ç›´æ¥é€€å‡ºï¼Œæä¾›è§£å†³æ–¹æ¡ˆ
   fi
   ```

2. **æ€§èƒ½è­¦å‘Š**

   ```bash
   # è­¦å‘Šæ€§èƒ½é™åˆ¶
   log_warning "å…±äº«å†…å­˜æ¨¡å¼æ€§èƒ½æœ‰é™ï¼Œå»ºè®®ä½¿ç”¨ NVLink æˆ– PCIe P2P"
   ```

**ç¯å¢ƒå˜é‡è®¾ç½®**:

```bash
# å…±äº«å†…å­˜æ ¸å¿ƒé…ç½®
NCCL_NET_DISABLE=1                 # ç¦ç”¨ç½‘ç»œä¼ è¾“
NCCL_P2P_DISABLE=1                 # ç¦ç”¨ P2P ä¼ è¾“
NCCL_SHM_DISABLE=0                 # å¯ç”¨å…±äº«å†…å­˜

# ç¦ç”¨é«˜çº§åŠŸèƒ½
NCCL_NET_GDR_LEVEL=0               # ç¦ç”¨ GPUDirect
NCCL_NVLS_ENABLE=0                 # ç¦ç”¨ NVLink SHARP

# æ€§èƒ½é…ç½®
NCCL_BUFFSIZE=8388608              # 8MB ç¼“å†²åŒº

# ç½‘ç»œæ¥å£æ¸…ç†
NCCL_SOCKET_IFNAME=                # æ¸…é™¤æ¥å£é™åˆ¶

# è°ƒè¯•é…ç½®
NCCL_DEBUG=INFO
NCCL_DEBUG_SUBSYS=INIT,NET
NCCL_GRAPH_DUMP_FILE=/tmp/nccl_graph_shm.xml
NCCL_TOPO_DUMP_FILE=/tmp/nccl_topo_shm.xml

# å…¶ä»–é…ç½®
NCCL_IGNORE_CPU_AFFINITY=1
NCCL_CROSS_NIC=0
```

**ç‰¹ç‚¹å’Œé™åˆ¶**:

- **ä»…å•èŠ‚ç‚¹**: ä¸æ”¯æŒå¤šèŠ‚ç‚¹åˆ†å¸ƒå¼è®­ç»ƒ
- **æ€§èƒ½æœ€ä½**: æ‰€æœ‰ä¼ è¾“æ–¹å¼ä¸­æ€§èƒ½æœ€ä½
- **é«˜å…¼å®¹æ€§**: é€‚ç”¨äºæ‰€æœ‰å•èŠ‚ç‚¹ç¯å¢ƒ
- **è°ƒè¯•ç”¨é€”**: ä¸»è¦ç”¨äºæ’æŸ¥ç¡¬ä»¶é—®é¢˜

**é”™è¯¯å¤„ç†**: å¤šèŠ‚ç‚¹æ¨¡å¼ä¸‹ä¼šç›´æ¥é€€å‡ºï¼š

```bash
[ERROR] å…±äº«å†…å­˜æ¨¡å¼ä»…æ”¯æŒå•èŠ‚ç‚¹ï¼Œä¸æ”¯æŒå¤šèŠ‚ç‚¹
[ERROR] æ— æ³•ä½¿ç”¨å…±äº«å†…å­˜ç½‘ç»œ
[INFO] è§£å†³æ–¹æ¡ˆ:
[INFO]   1. ä½¿ç”¨å•èŠ‚ç‚¹æ¨¡å¼ (ç§»é™¤ -m æˆ– --multi-node å‚æ•°)
[INFO]   2. æˆ–ä½¿ç”¨å¤šèŠ‚ç‚¹å…¼å®¹çš„ç½‘ç»œåç«¯: --network ib æˆ– --network ethernet
```

#### 7.3.8 ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§å’Œè¦†ç›–è§„åˆ™

**é…ç½®æµç¨‹**:

1. **ç½‘ç»œæ¨¡å¼é€‰æ‹©**: æ ¹æ® `--network` å‚æ•°é€‰æ‹©é…ç½®ç­–ç•¥
2. **ç¡¬ä»¶æ£€æŸ¥**: éªŒè¯ç¡¬ä»¶æ”¯æŒï¼ˆå¼ºåˆ¶æ¨¡å¼ä¸‹ï¼‰
3. **ç¯å¢ƒå˜é‡é…ç½®**: è°ƒç”¨å¯¹åº”çš„é…ç½®å‡½æ•°
4. **é€šç”¨é…ç½®**: åº”ç”¨è°ƒè¯•å’Œå¤šèŠ‚ç‚¹é…ç½®
5. **ç¯å¢ƒå˜é‡å±•ç¤º**: å®æ—¶æ˜¾ç¤ºå½“å‰é…ç½®

**ä¼˜å…ˆçº§é¡ºåº**:

1. **å‘½ä»¤è¡Œå‚æ•°** (`--network` é€‰é¡¹) - æœ€é«˜ä¼˜å…ˆçº§
2. **è„šæœ¬é…ç½®å‡½æ•°** (åŸºäºç¡¬ä»¶æ£€æµ‹å’Œæ¨¡å¼é€‰æ‹©)
3. **é€šç”¨é…ç½®** (è°ƒè¯•ã€å¤šèŠ‚ç‚¹ç­‰)
4. **NCCL é»˜è®¤å€¼** - æœ€ä½ä¼˜å…ˆçº§

**é‡è¦ç‰¹æ€§**:

- **ä¸è¦†ç›–ç”¨æˆ·å˜é‡**: è„šæœ¬ä¸ä¼šè¦†ç›–ç”¨æˆ·é¢„è®¾çš„ NCCL ç¯å¢ƒå˜é‡
- **é…ç½®ä¸€è‡´æ€§**: æ¯ç§æ¨¡å¼éƒ½æœ‰ç‹¬ç«‹çš„é…ç½®å‡½æ•°ï¼Œç¡®ä¿é…ç½®ä¸€è‡´
- **é”™è¯¯å¤„ç†**: ç¡¬ä»¶ä¸åŒ¹é…æ—¶ç›´æ¥é€€å‡ºï¼Œé¿å…é”™è¯¯é…ç½®
- **å®æ—¶å±•ç¤º**: é…ç½®å®Œæˆåç«‹å³æ˜¾ç¤ºç¯å¢ƒå˜é‡çŠ¶æ€

**ç¯å¢ƒå˜é‡å±•ç¤ºåŠŸèƒ½**:

è„šæœ¬åœ¨é…ç½®å®Œæˆåä¼šè°ƒç”¨ `display_nccl_environment_variables` å‡½æ•°ï¼Œæä¾›ï¼š

- **åˆ†ç±»å±•ç¤º**: æŒ‰æ ¸å¿ƒé…ç½®ã€ç½‘ç»œé…ç½®ã€æ€§èƒ½ä¼˜åŒ–ã€è°ƒè¯•é…ç½®åˆ†ç±»
- **çŠ¶æ€æ ‡è¯†**:
  - `[SUCCESS]` - å·²è®¾ç½®çš„å˜é‡
  - `[INFO] æœªè®¾ç½®` - æœªè®¾ç½®çš„å˜é‡  
  - `[WARNING]` - é¢å¤–çš„å˜é‡ï¼ˆéé¢„å®šä¹‰ä½†å·²è®¾ç½®ï¼‰
- **ç»Ÿè®¡ä¿¡æ¯**: æ˜¾ç¤ºå·²è®¾ç½®å˜é‡çš„æ•°é‡å’Œæ¯”ä¾‹
- **å®æ—¶æ›´æ–°**: åæ˜ å½“å‰ç¯å¢ƒçš„å®é™…çŠ¶æ€

**éªŒè¯æ–¹æ³•**:

```bash
# æŸ¥çœ‹é…ç½®è¿‡ç¨‹å’Œç¯å¢ƒå˜é‡
./nccl_benchmark.sh --network auto --dry-run

# æŸ¥çœ‹ç‰¹å®šæ¨¡å¼çš„é…ç½®
./nccl_benchmark.sh --network ib --dry-run

# å¯ç”¨è¯¦ç»†æ—¥å¿—æŸ¥çœ‹ç¡¬ä»¶æ£€æµ‹è¿‡ç¨‹
./nccl_benchmark.sh --network nvlink --verbose --dry-run
```

---

## 8. æµ‹è¯•ç»“æœä¸è¿ç»´æŒ‡å—

### 8.1 è¾“å‡ºæ–‡ä»¶è¯´æ˜

#### 8.1.1 æ—¥å¿—æ–‡ä»¶

- **ä½ç½®**: `/tmp/nccl_test_YYYYMMDD_HHMMSS.log`
- **å†…å®¹**: è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ£€æŸ¥ã€é…ç½®å’Œæµ‹è¯•è¿‡ç¨‹

#### 8.1.2 æµ‹è¯•è¾“å‡º

- **ä½ç½®**: `/tmp/nccl_test_output.log`
- **å†…å®¹**: NCCL æµ‹è¯•çš„åŸå§‹è¾“å‡ºï¼ŒåŒ…å«æ€§èƒ½æ•°æ®å’Œè°ƒè¯•ä¿¡æ¯

#### 8.1.3 æµ‹è¯•æŠ¥å‘Š

- **ä½ç½®**: `/tmp/nccl_test_report_YYYYMMDD_HHMMSS.txt`
- **å†…å®¹**: æ ¼å¼åŒ–çš„æµ‹è¯•æŠ¥å‘Šï¼ŒåŒ…å«ç³»ç»Ÿä¿¡æ¯ã€é…ç½®å‚æ•°ã€æµ‹è¯•ç»“æœ

#### 8.1.4 ä¸´æ—¶æ–‡ä»¶

- `/tmp/nccl_test.py`: åŠ¨æ€ç”Ÿæˆçš„ NCCL æµ‹è¯•è„šæœ¬

### 8.2 æ€§èƒ½æŒ‡æ ‡è¯´æ˜

#### 8.2.1 å»¶è¿Ÿ (Latency)

- **å•ä½**: æ¯«ç§’ (ms)
- **å«ä¹‰**: AllReduce æ“ä½œçš„ç«¯åˆ°ç«¯å»¶è¿Ÿ
- **å…¸å‹å€¼**: 0.1-2.0 ms (å–å†³äºæ•°æ®å¤§å°å’Œç½‘ç»œé…ç½®)

#### 8.2.2 æ•°æ®ååé‡ (Data Throughput)

- **å•ä½**: Gbps (æ¯”ç‰¹æ¯ç§’)
- **å«ä¹‰**: NCCL æ“ä½œçš„æ•°æ®å¤„ç†é€Ÿç‡
- **æ³¨æ„**: è¿™ä¸ç­‰åŒäºç½‘ç»œå¸¦å®½ï¼ŒåŒ…å«äº†ç®—æ³•å¼€é”€
- **æ¢ç®—**: 1 Gbps = 0.125 GB/s (å­—èŠ‚æ¯ç§’)

#### 8.2.3 ç†è®ºä¼ è¾“é‡ (Theoretical Transfer)

- **å•ä½**: MB
- **è®¡ç®—å…¬å¼**: Ring AllReduce: `2 * (N-1) / N * data_size`
- **å«ä¹‰**: ç†è®ºä¸Šéœ€è¦ä¼ è¾“çš„æ•°æ®é‡

---

### 8.3 æ•…éšœæ’é™¤

#### 8.3.1 å¸¸è§é—®é¢˜

##### 8.3.1.1 ä¾èµ–æ£€æŸ¥å¤±è´¥

```bash
[ERROR] Python3 æœªå®‰è£…
[ERROR] PyTorch æœªå®‰è£…æˆ–ä¸å¯ç”¨
```

**è§£å†³æ–¹æ¡ˆ**: å®‰è£…ç¼ºå¤±çš„ä¾èµ–åŒ…

##### 8.3.1.2 InfiniBand è®¾å¤‡ä¸å¯ç”¨

```bash
[ERROR] InfiniBand è®¾å¤‡ä¸å¯ç”¨æˆ–æœªé…ç½®
```

**è§£å†³æ–¹æ¡ˆ**:

- æ£€æŸ¥ IB é©±åŠ¨æ˜¯å¦æ­£ç¡®å®‰è£…
- ç¡®è®¤ IB ç½‘å¡ç¡¬ä»¶è¿æ¥æ­£å¸¸
- è¿è¡Œ `ibstat` æ£€æŸ¥è®¾å¤‡çŠ¶æ€

##### 8.3.1.3 NCCL æµ‹è¯•å¤±è´¥

```bash
[ERROR] NCCL æµ‹è¯•æ‰§è¡Œå¤±è´¥
```

**è§£å†³æ–¹æ¡ˆ**:

- æ£€æŸ¥ GPU å†…å­˜æ˜¯å¦å……è¶³
- ç¡®è®¤ NCCL ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- æŸ¥çœ‹è¯¦ç»†æ—¥å¿—æ–‡ä»¶æ’æŸ¥å…·ä½“é”™è¯¯

##### 8.3.1.4 ç½‘ç»œæ€§èƒ½ä¸ä½³

```bash
[WARNING] æ•°æ®ååé‡ä½äºé¢„æœŸ
```

**è§£å†³æ–¹æ¡ˆ**:

- æ£€æŸ¥ IB ç½‘ç»œæ‹“æ‰‘å’Œè¿æ¥
- éªŒè¯ GPUDirect RDMA æ˜¯å¦å¯ç”¨
- è°ƒæ•´ NCCL å‚æ•°ä¼˜åŒ–æ€§èƒ½

#### 8.3.2 è°ƒè¯•æŠ€å·§

##### 8.3.2.1 å¯ç”¨è¯¦ç»†æ—¥å¿—

```bash
export NCCL_DEBUG=TRACE
export NCCL_DEBUG_SUBSYS=ALL
./nccl_benchmark.sh --network auto -s 1M -t 30
```

##### 8.3.2.2 æ£€æŸ¥ IB çŠ¶æ€

```bash
# æŸ¥çœ‹ IB è®¾å¤‡çŠ¶æ€
ibstat

# æŸ¥çœ‹è®¾å¤‡è¯¦ç»†ä¿¡æ¯
ibv_devinfo

# æ£€æŸ¥æ€§èƒ½è®¡æ•°å™¨
perfquery -a
```

##### 8.3.2.3 ç›‘æ§ç½‘ç»œæµé‡

```bash
# åœ¨æµ‹è¯•å‰åæ¯”è¾ƒè®¡æ•°å™¨
perfquery -a > before.txt
# è¿è¡Œæµ‹è¯•
perfquery -a > after.txt
diff before.txt after.txt
```

---

### 8.4 æœ€ä½³å®è·µ

#### 8.4.1 æµ‹è¯•å‰å‡†å¤‡

- å»ºè®®å…ˆè¿è¡Œ `../InfiniBand/health/ib_health_check.sh` ç¡®ä¿ InfiniBand ç½‘ç»œæ­£å¸¸
- ä½¿ç”¨ `../InfiniBand/monitor/ib_bandwidth_monitor.sh` ç›‘æ§æµ‹è¯•æœŸé—´çš„ç½‘ç»œæ€§èƒ½
- ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹çš„æ—¶é—´åŒæ­¥
- ç¡®ä¿æ‰€æœ‰ GPU å¯ç”¨ä¸”å†…å­˜å……è¶³
- éªŒè¯ InfiniBand ç½‘ç»œè¿æ¥æ­£å¸¸
- å…³é—­ä¸å¿…è¦çš„åå°è¿›ç¨‹

#### 8.4.2 æ€§èƒ½ç›‘æ§

- åœ¨æµ‹è¯•æœŸé—´ï¼Œå¯ä»¥ä½¿ç”¨ä¸“é—¨çš„ `ib_bandwidth_monitor.sh` è„šæœ¬ç›‘æ§ InfiniBand ç½‘ç»œæ€§èƒ½
- å»ºè®®åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£è¿è¡Œç›‘æ§è„šæœ¬ï¼š

  ```bash
  # åœ¨æµ‹è¯•æœŸé—´ç›‘æ§ç½‘ç»œæ€§èƒ½ (éœ€è¦å…ˆå®‰è£… InfiniBand å·¥å…·åŒ…)
  # è„šæœ¬ä½ç½®: ../InfiniBand/monitor/ib_bandwidth_monitor.sh
  ../InfiniBand/monitor/ib_bandwidth_monitor.sh -d mlx5_0 -p 1 -t 300
  ```

#### 8.4.3 æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨å¤š GPU ç¯å¢ƒè¿›è¡Œæµ‹è¯•
- ç¡®ä¿ GPUDirect RDMA æ­£ç¡®é…ç½®
- æ ¹æ®ç½‘ç»œç±»å‹è°ƒæ•´ NCCL å‚æ•°

#### 8.4.4 å®šæœŸç›‘æ§

- å®šæœŸè¿è¡Œæµ‹è¯•ä»¥ç›‘æ§ç³»ç»Ÿæ€§èƒ½å˜åŒ–
- å»ºç«‹æ€§èƒ½åŸºçº¿ï¼ŒåŠæ—¶å‘ç°æ€§èƒ½é€€åŒ–
- è®°å½•é…ç½®å˜æ›´å¯¹æ€§èƒ½çš„å½±å“
